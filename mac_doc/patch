diff -r -u uae-0.8.5/configure uae-0.8.6/configure
--- uae-0.8.5/configure	Thu Jul  2 22:15:14 1998
+++ uae-0.8.6/configure	Sat Jul 18 13:14:42 1998
@@ -40,8 +40,6 @@
 ac_help="$ac_help
   --enable-penguins       Enable threads that only make sense on SMP machines"
 ac_help="$ac_help
-  --enable-sound          Enable sound support"
-ac_help="$ac_help
   --enable-file-sound          Enable sound output to file"
 
 # Initialize some variables set by options.
@@ -555,7 +553,7 @@
 # Extract the first word of "gcc", so it can be a program name with args.
 set dummy gcc; ac_word=$2
 echo $ac_n "checking for $ac_word""... $ac_c" 1>&6
-echo "configure:559: checking for $ac_word" >&5
+echo "configure:557: checking for $ac_word" >&5
 if eval "test \"`echo '$''{'ac_cv_prog_CC'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -584,7 +582,7 @@
   # Extract the first word of "cc", so it can be a program name with args.
 set dummy cc; ac_word=$2
 echo $ac_n "checking for $ac_word""... $ac_c" 1>&6
-echo "configure:588: checking for $ac_word" >&5
+echo "configure:586: checking for $ac_word" >&5
 if eval "test \"`echo '$''{'ac_cv_prog_CC'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -632,7 +630,7 @@
 fi
 
 echo $ac_n "checking whether the C compiler ($CC $CFLAGS $LDFLAGS) works""... $ac_c" 1>&6
-echo "configure:636: checking whether the C compiler ($CC $CFLAGS $LDFLAGS) works" >&5
+echo "configure:634: checking whether the C compiler ($CC $CFLAGS $LDFLAGS) works" >&5
 
 ac_ext=c
 # CFLAGS is not in ac_cpp because -g, -O, etc. are not valid cpp options.
@@ -642,11 +640,11 @@
 cross_compiling=$ac_cv_prog_cc_cross
 
 cat > conftest.$ac_ext <<EOF
-#line 646 "configure"
+#line 644 "configure"
 #include "confdefs.h"
 main(){return(0);}
 EOF
-if { (eval echo configure:650: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:648: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   ac_cv_prog_cc_works=yes
   # If we can't run a trivial program, we are probably using a cross compiler.
   if (./conftest; exit) 2>/dev/null; then
@@ -666,12 +664,12 @@
   { echo "configure: error: installation or configuration problem: C compiler cannot create executables." 1>&2; exit 1; }
 fi
 echo $ac_n "checking whether the C compiler ($CC $CFLAGS $LDFLAGS) is a cross-compiler""... $ac_c" 1>&6
-echo "configure:670: checking whether the C compiler ($CC $CFLAGS $LDFLAGS) is a cross-compiler" >&5
+echo "configure:668: checking whether the C compiler ($CC $CFLAGS $LDFLAGS) is a cross-compiler" >&5
 echo "$ac_t""$ac_cv_prog_cc_cross" 1>&6
 cross_compiling=$ac_cv_prog_cc_cross
 
 echo $ac_n "checking whether we are using GNU C""... $ac_c" 1>&6
-echo "configure:675: checking whether we are using GNU C" >&5
+echo "configure:673: checking whether we are using GNU C" >&5
 if eval "test \"`echo '$''{'ac_cv_prog_gcc'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -680,7 +678,7 @@
   yes;
 #endif
 EOF
-if { ac_try='${CC-cc} -E conftest.c'; { (eval echo configure:684: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }; } | egrep yes >/dev/null 2>&1; then
+if { ac_try='${CC-cc} -E conftest.c'; { (eval echo configure:682: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }; } | egrep yes >/dev/null 2>&1; then
   ac_cv_prog_gcc=yes
 else
   ac_cv_prog_gcc=no
@@ -695,7 +693,7 @@
   ac_save_CFLAGS="$CFLAGS"
   CFLAGS=
   echo $ac_n "checking whether ${CC-cc} accepts -g""... $ac_c" 1>&6
-echo "configure:699: checking whether ${CC-cc} accepts -g" >&5
+echo "configure:697: checking whether ${CC-cc} accepts -g" >&5
 if eval "test \"`echo '$''{'ac_cv_prog_cc_g'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -724,7 +722,7 @@
 
 
 echo $ac_n "checking how to run the C preprocessor""... $ac_c" 1>&6
-echo "configure:728: checking how to run the C preprocessor" >&5
+echo "configure:726: checking how to run the C preprocessor" >&5
 # On Suns, sometimes $CPP names a directory.
 if test -n "$CPP" && test -d "$CPP"; then
   CPP=
@@ -739,13 +737,13 @@
   # On the NeXT, cc -E runs the code through the compiler's parser,
   # not just through cpp.
   cat > conftest.$ac_ext <<EOF
-#line 743 "configure"
+#line 741 "configure"
 #include "confdefs.h"
 #include <assert.h>
 Syntax Error
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:749: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:747: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   :
@@ -756,13 +754,13 @@
   rm -rf conftest*
   CPP="${CC-cc} -E -traditional-cpp"
   cat > conftest.$ac_ext <<EOF
-#line 760 "configure"
+#line 758 "configure"
 #include "confdefs.h"
 #include <assert.h>
 Syntax Error
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:766: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:764: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   :
@@ -785,7 +783,7 @@
 echo "$ac_t""$CPP" 1>&6
 
 echo $ac_n "checking whether ${MAKE-make} sets \${MAKE}""... $ac_c" 1>&6
-echo "configure:789: checking whether ${MAKE-make} sets \${MAKE}" >&5
+echo "configure:787: checking whether ${MAKE-make} sets \${MAKE}" >&5
 set dummy ${MAKE-make}; ac_make=`echo "$2" | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_prog_make_${ac_make}_set'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -814,7 +812,7 @@
 # Extract the first word of "file", so it can be a program name with args.
 set dummy file; ac_word=$2
 echo $ac_n "checking for $ac_word""... $ac_c" 1>&6
-echo "configure:818: checking for $ac_word" >&5
+echo "configure:816: checking for $ac_word" >&5
 if eval "test \"`echo '$''{'ac_cv_path_FILEPRG'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -846,7 +844,7 @@
 # Extract the first word of "wrc", so it can be a program name with args.
 set dummy wrc; ac_word=$2
 echo $ac_n "checking for $ac_word""... $ac_c" 1>&6
-echo "configure:850: checking for $ac_word" >&5
+echo "configure:848: checking for $ac_word" >&5
 if eval "test \"`echo '$''{'ac_cv_path_WRCPRG'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -878,7 +876,7 @@
 # Extract the first word of "rcl", so it can be a program name with args.
 set dummy rcl; ac_word=$2
 echo $ac_n "checking for $ac_word""... $ac_c" 1>&6
-echo "configure:882: checking for $ac_word" >&5
+echo "configure:880: checking for $ac_word" >&5
 if eval "test \"`echo '$''{'ac_cv_path_RCLPRG'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -909,9 +907,9 @@
 
 
 echo $ac_n "checking for AIX""... $ac_c" 1>&6
-echo "configure:913: checking for AIX" >&5
+echo "configure:911: checking for AIX" >&5
 cat > conftest.$ac_ext <<EOF
-#line 915 "configure"
+#line 913 "configure"
 #include "confdefs.h"
 #ifdef _AIX
   yes
@@ -933,7 +931,7 @@
 
 
 echo $ac_n "checking for POSIXized ISC""... $ac_c" 1>&6
-echo "configure:937: checking for POSIXized ISC" >&5
+echo "configure:935: checking for POSIXized ISC" >&5
 if test -d /etc/conf/kconfig.d &&
   grep _POSIX_VERSION /usr/include/sys/unistd.h >/dev/null 2>&1
 then
@@ -955,9 +953,9 @@
 
 
 echo $ac_n "checking for Watcom C""... $ac_c" 1>&6
-echo "configure:959: checking for Watcom C" >&5
+echo "configure:957: checking for Watcom C" >&5
 cat > conftest.$ac_ext <<EOF
-#line 961 "configure"
+#line 959 "configure"
 #include "confdefs.h"
 #ifdef __WATCOMC__
   yes
@@ -977,19 +975,19 @@
 echo "$ac_t""$uae_cv_prog_cc_watcom" 1>&6
 
 echo $ac_n "checking for Cygwin32 environment""... $ac_c" 1>&6
-echo "configure:981: checking for Cygwin32 environment" >&5
+echo "configure:979: checking for Cygwin32 environment" >&5
 if eval "test \"`echo '$''{'am_cv_cygwin32'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 986 "configure"
+#line 984 "configure"
 #include "confdefs.h"
 
 int main() {
 return __CYGWIN32__;
 ; return 0; }
 EOF
-if { (eval echo configure:993: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:991: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   am_cv_cygwin32=yes
 else
@@ -1006,19 +1004,19 @@
 CYGWIN32=
 test "$am_cv_cygwin32" = yes && CYGWIN32=yes
 echo $ac_n "checking for Mingw32 environment""... $ac_c" 1>&6
-echo "configure:1010: checking for Mingw32 environment" >&5
+echo "configure:1008: checking for Mingw32 environment" >&5
 if eval "test \"`echo '$''{'am_cv_mingw32'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1015 "configure"
+#line 1013 "configure"
 #include "confdefs.h"
 
 int main() {
 return __MINGW32__;
 ; return 0; }
 EOF
-if { (eval echo configure:1022: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:1020: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   am_cv_mingw32=yes
 else
@@ -1037,7 +1035,7 @@
 
 
 echo $ac_n "checking for executable suffix""... $ac_c" 1>&6
-echo "configure:1041: checking for executable suffix" >&5
+echo "configure:1039: checking for executable suffix" >&5
 if eval "test \"`echo '$''{'am_cv_exeext'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -1080,7 +1078,7 @@
 HAVE_BEOS=no
 HAVE_POS=no
 echo $ac_n "checking for main in -lMedia_s""... $ac_c" 1>&6
-echo "configure:1084: checking for main in -lMedia_s" >&5
+echo "configure:1082: checking for main in -lMedia_s" >&5
 ac_lib_var=`echo Media_s'_'main | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1088,14 +1086,14 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lMedia_s  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1092 "configure"
+#line 1090 "configure"
 #include "confdefs.h"
 
 int main() {
 main()
 ; return 0; }
 EOF
-if { (eval echo configure:1099: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1097: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1117,7 +1115,7 @@
 fi
 
 echo $ac_n "checking for main in -lNeXT_s""... $ac_c" 1>&6
-echo "configure:1121: checking for main in -lNeXT_s" >&5
+echo "configure:1119: checking for main in -lNeXT_s" >&5
 ac_lib_var=`echo NeXT_s'_'main | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1125,14 +1123,14 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lNeXT_s  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1129 "configure"
+#line 1127 "configure"
 #include "confdefs.h"
 
 int main() {
 main()
 ; return 0; }
 EOF
-if { (eval echo configure:1136: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1134: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1154,7 +1152,7 @@
 fi
 
 echo $ac_n "checking for OpenLibrary in -lamiga""... $ac_c" 1>&6
-echo "configure:1158: checking for OpenLibrary in -lamiga" >&5
+echo "configure:1156: checking for OpenLibrary in -lamiga" >&5
 ac_lib_var=`echo amiga'_'OpenLibrary | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1162,7 +1160,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lamiga  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1166 "configure"
+#line 1164 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1173,7 +1171,7 @@
 OpenLibrary()
 ; return 0; }
 EOF
-if { (eval echo configure:1177: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1175: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1195,7 +1193,7 @@
 fi
 
 echo $ac_n "checking for vga_setmode in -lvga""... $ac_c" 1>&6
-echo "configure:1199: checking for vga_setmode in -lvga" >&5
+echo "configure:1197: checking for vga_setmode in -lvga" >&5
 ac_lib_var=`echo vga'_'vga_setmode | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1203,7 +1201,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lvga  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1207 "configure"
+#line 1205 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1214,7 +1212,7 @@
 vga_setmode()
 ; return 0; }
 EOF
-if { (eval echo configure:1218: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1216: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1236,7 +1234,7 @@
 fi
 
 echo $ac_n "checking for AFOpenAudioConn in -lAF""... $ac_c" 1>&6
-echo "configure:1240: checking for AFOpenAudioConn in -lAF" >&5
+echo "configure:1238: checking for AFOpenAudioConn in -lAF" >&5
 ac_lib_var=`echo AF'_'AFOpenAudioConn | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1244,7 +1242,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lAF  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1248 "configure"
+#line 1246 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1255,7 +1253,7 @@
 AFOpenAudioConn()
 ; return 0; }
 EOF
-if { (eval echo configure:1259: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1257: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1277,7 +1275,7 @@
 fi
 
 echo $ac_n "checking for waveOutGetNumDevs in -lmme""... $ac_c" 1>&6
-echo "configure:1281: checking for waveOutGetNumDevs in -lmme" >&5
+echo "configure:1279: checking for waveOutGetNumDevs in -lmme" >&5
 ac_lib_var=`echo mme'_'waveOutGetNumDevs | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1285,7 +1283,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lmme  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1289 "configure"
+#line 1287 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1296,7 +1294,7 @@
 waveOutGetNumDevs()
 ; return 0; }
 EOF
-if { (eval echo configure:1300: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1298: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1318,7 +1316,7 @@
 fi
 
 echo $ac_n "checking for waddch in -lncurses""... $ac_c" 1>&6
-echo "configure:1322: checking for waddch in -lncurses" >&5
+echo "configure:1320: checking for waddch in -lncurses" >&5
 ac_lib_var=`echo ncurses'_'waddch | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1326,7 +1324,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lncurses  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1330 "configure"
+#line 1328 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1337,7 +1335,7 @@
 waddch()
 ; return 0; }
 EOF
-if { (eval echo configure:1341: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1339: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1359,7 +1357,7 @@
 fi
 
 echo $ac_n "checking for sem_init in -lposix4""... $ac_c" 1>&6
-echo "configure:1363: checking for sem_init in -lposix4" >&5
+echo "configure:1361: checking for sem_init in -lposix4" >&5
 ac_lib_var=`echo posix4'_'sem_init | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1367,7 +1365,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lposix4  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1371 "configure"
+#line 1369 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1378,7 +1376,7 @@
 sem_init()
 ; return 0; }
 EOF
-if { (eval echo configure:1382: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1380: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1400,7 +1398,7 @@
 fi
 
 echo $ac_n "checking for sem_init in -lrt""... $ac_c" 1>&6
-echo "configure:1404: checking for sem_init in -lrt" >&5
+echo "configure:1402: checking for sem_init in -lrt" >&5
 ac_lib_var=`echo rt'_'sem_init | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1408,7 +1406,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lrt  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1412 "configure"
+#line 1410 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1419,7 +1417,7 @@
 sem_init()
 ; return 0; }
 EOF
-if { (eval echo configure:1423: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1421: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1441,7 +1439,7 @@
 fi
 
 echo $ac_n "checking for ggiInit in -lggi""... $ac_c" 1>&6
-echo "configure:1445: checking for ggiInit in -lggi" >&5
+echo "configure:1443: checking for ggiInit in -lggi" >&5
 ac_lib_var=`echo ggi'_'ggiInit | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1449,7 +1447,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lggi  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1453 "configure"
+#line 1451 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1460,7 +1458,7 @@
 ggiInit()
 ; return 0; }
 EOF
-if { (eval echo configure:1464: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1462: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1487,7 +1485,7 @@
 # Uses ac_ vars as temps to allow command line to override cache and checks.
 # --without-x overrides everything else, but does not touch the cache.
 echo $ac_n "checking for X""... $ac_c" 1>&6
-echo "configure:1491: checking for X" >&5
+echo "configure:1489: checking for X" >&5
 
 # Check whether --with-x or --without-x was given.
 if test "${with_x+set}" = set; then
@@ -1549,12 +1547,12 @@
 
   # First, try using that file with no special directory specified.
 cat > conftest.$ac_ext <<EOF
-#line 1553 "configure"
+#line 1551 "configure"
 #include "confdefs.h"
 #include <$x_direct_test_include>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:1558: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:1556: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -1623,14 +1621,14 @@
   ac_save_LIBS="$LIBS"
   LIBS="-l$x_direct_test_library $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1627 "configure"
+#line 1625 "configure"
 #include "confdefs.h"
 
 int main() {
 ${x_direct_test_function}()
 ; return 0; }
 EOF
-if { (eval echo configure:1634: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1632: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   LIBS="$ac_save_LIBS"
 # We can link X programs with no special library path.
@@ -1736,17 +1734,17 @@
     case "`(uname -sr) 2>/dev/null`" in
     "SunOS 5"*)
       echo $ac_n "checking whether -R must be followed by a space""... $ac_c" 1>&6
-echo "configure:1740: checking whether -R must be followed by a space" >&5
+echo "configure:1738: checking whether -R must be followed by a space" >&5
       ac_xsave_LIBS="$LIBS"; LIBS="$LIBS -R$x_libraries"
       cat > conftest.$ac_ext <<EOF
-#line 1743 "configure"
+#line 1741 "configure"
 #include "confdefs.h"
 
 int main() {
 
 ; return 0; }
 EOF
-if { (eval echo configure:1750: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1748: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   ac_R_nospace=yes
 else
@@ -1762,14 +1760,14 @@
       else
 	LIBS="$ac_xsave_LIBS -R $x_libraries"
 	cat > conftest.$ac_ext <<EOF
-#line 1766 "configure"
+#line 1764 "configure"
 #include "confdefs.h"
 
 int main() {
 
 ; return 0; }
 EOF
-if { (eval echo configure:1773: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1771: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   ac_R_space=yes
 else
@@ -1801,7 +1799,7 @@
     # libraries were built with DECnet support.  And karl@cs.umb.edu says
     # the Alpha needs dnet_stub (dnet does not exist).
     echo $ac_n "checking for dnet_ntoa in -ldnet""... $ac_c" 1>&6
-echo "configure:1805: checking for dnet_ntoa in -ldnet" >&5
+echo "configure:1803: checking for dnet_ntoa in -ldnet" >&5
 ac_lib_var=`echo dnet'_'dnet_ntoa | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1809,7 +1807,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-ldnet  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1813 "configure"
+#line 1811 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1820,7 +1818,7 @@
 dnet_ntoa()
 ; return 0; }
 EOF
-if { (eval echo configure:1824: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1822: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1842,7 +1840,7 @@
 
     if test $ac_cv_lib_dnet_dnet_ntoa = no; then
       echo $ac_n "checking for dnet_ntoa in -ldnet_stub""... $ac_c" 1>&6
-echo "configure:1846: checking for dnet_ntoa in -ldnet_stub" >&5
+echo "configure:1844: checking for dnet_ntoa in -ldnet_stub" >&5
 ac_lib_var=`echo dnet_stub'_'dnet_ntoa | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1850,7 +1848,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-ldnet_stub  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1854 "configure"
+#line 1852 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1861,7 +1859,7 @@
 dnet_ntoa()
 ; return 0; }
 EOF
-if { (eval echo configure:1865: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1863: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1890,12 +1888,12 @@
     # The nsl library prevents programs from opening the X display
     # on Irix 5.2, according to dickey@clark.net.
     echo $ac_n "checking for gethostbyname""... $ac_c" 1>&6
-echo "configure:1894: checking for gethostbyname" >&5
+echo "configure:1892: checking for gethostbyname" >&5
 if eval "test \"`echo '$''{'ac_cv_func_gethostbyname'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1899 "configure"
+#line 1897 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char gethostbyname(); below.  */
@@ -1918,7 +1916,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:1922: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1920: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_func_gethostbyname=yes"
 else
@@ -1939,7 +1937,7 @@
 
     if test $ac_cv_func_gethostbyname = no; then
       echo $ac_n "checking for gethostbyname in -lnsl""... $ac_c" 1>&6
-echo "configure:1943: checking for gethostbyname in -lnsl" >&5
+echo "configure:1941: checking for gethostbyname in -lnsl" >&5
 ac_lib_var=`echo nsl'_'gethostbyname | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1947,7 +1945,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lnsl  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1951 "configure"
+#line 1949 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1958,7 +1956,7 @@
 gethostbyname()
 ; return 0; }
 EOF
-if { (eval echo configure:1962: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1960: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1988,12 +1986,12 @@
     # -lsocket must be given before -lnsl if both are needed.
     # We assume that if connect needs -lnsl, so does gethostbyname.
     echo $ac_n "checking for connect""... $ac_c" 1>&6
-echo "configure:1992: checking for connect" >&5
+echo "configure:1990: checking for connect" >&5
 if eval "test \"`echo '$''{'ac_cv_func_connect'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1997 "configure"
+#line 1995 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char connect(); below.  */
@@ -2016,7 +2014,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:2020: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:2018: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_func_connect=yes"
 else
@@ -2037,7 +2035,7 @@
 
     if test $ac_cv_func_connect = no; then
       echo $ac_n "checking for connect in -lsocket""... $ac_c" 1>&6
-echo "configure:2041: checking for connect in -lsocket" >&5
+echo "configure:2039: checking for connect in -lsocket" >&5
 ac_lib_var=`echo socket'_'connect | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -2045,7 +2043,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lsocket $X_EXTRA_LIBS $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 2049 "configure"
+#line 2047 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -2056,7 +2054,7 @@
 connect()
 ; return 0; }
 EOF
-if { (eval echo configure:2060: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:2058: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -2080,12 +2078,12 @@
 
     # gomez@mi.uni-erlangen.de says -lposix is necessary on A/UX.
     echo $ac_n "checking for remove""... $ac_c" 1>&6
-echo "configure:2084: checking for remove" >&5
+echo "configure:2082: checking for remove" >&5
 if eval "test \"`echo '$''{'ac_cv_func_remove'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2089 "configure"
+#line 2087 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char remove(); below.  */
@@ -2108,7 +2106,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:2112: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:2110: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_func_remove=yes"
 else
@@ -2129,7 +2127,7 @@
 
     if test $ac_cv_func_remove = no; then
       echo $ac_n "checking for remove in -lposix""... $ac_c" 1>&6
-echo "configure:2133: checking for remove in -lposix" >&5
+echo "configure:2131: checking for remove in -lposix" >&5
 ac_lib_var=`echo posix'_'remove | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -2137,7 +2135,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lposix  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 2141 "configure"
+#line 2139 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -2148,7 +2146,7 @@
 remove()
 ; return 0; }
 EOF
-if { (eval echo configure:2152: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:2150: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -2172,12 +2170,12 @@
 
     # BSDI BSD/OS 2.1 needs -lipc for XOpenDisplay.
     echo $ac_n "checking for shmat""... $ac_c" 1>&6
-echo "configure:2176: checking for shmat" >&5
+echo "configure:2174: checking for shmat" >&5
 if eval "test \"`echo '$''{'ac_cv_func_shmat'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2181 "configure"
+#line 2179 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char shmat(); below.  */
@@ -2200,7 +2198,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:2204: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:2202: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_func_shmat=yes"
 else
@@ -2221,7 +2219,7 @@
 
     if test $ac_cv_func_shmat = no; then
       echo $ac_n "checking for shmat in -lipc""... $ac_c" 1>&6
-echo "configure:2225: checking for shmat in -lipc" >&5
+echo "configure:2223: checking for shmat in -lipc" >&5
 ac_lib_var=`echo ipc'_'shmat | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -2229,7 +2227,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lipc  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 2233 "configure"
+#line 2231 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -2240,7 +2238,7 @@
 shmat()
 ; return 0; }
 EOF
-if { (eval echo configure:2244: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:2242: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -2273,7 +2271,7 @@
   # libraries we check for below, so use a different variable.
   #  --interran@uluru.Stanford.EDU, kb@cs.umb.edu.
   echo $ac_n "checking for IceConnectionNumber in -lICE""... $ac_c" 1>&6
-echo "configure:2277: checking for IceConnectionNumber in -lICE" >&5
+echo "configure:2275: checking for IceConnectionNumber in -lICE" >&5
 ac_lib_var=`echo ICE'_'IceConnectionNumber | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -2281,7 +2279,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lICE  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 2285 "configure"
+#line 2283 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -2292,7 +2290,7 @@
 IceConnectionNumber()
 ; return 0; }
 EOF
-if { (eval echo configure:2296: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:2294: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -2323,12 +2321,12 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr that defines DIR""... $ac_c" 1>&6
-echo "configure:2327: checking for $ac_hdr that defines DIR" >&5
+echo "configure:2325: checking for $ac_hdr that defines DIR" >&5
 if eval "test \"`echo '$''{'ac_cv_header_dirent_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2332 "configure"
+#line 2330 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <$ac_hdr>
@@ -2336,7 +2334,7 @@
 DIR *dirp = 0;
 ; return 0; }
 EOF
-if { (eval echo configure:2340: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:2338: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   eval "ac_cv_header_dirent_$ac_safe=yes"
 else
@@ -2361,7 +2359,7 @@
 # Two versions of opendir et al. are in -ldir and -lx on SCO Xenix.
 if test $ac_header_dirent = dirent.h; then
 echo $ac_n "checking for opendir in -ldir""... $ac_c" 1>&6
-echo "configure:2365: checking for opendir in -ldir" >&5
+echo "configure:2363: checking for opendir in -ldir" >&5
 ac_lib_var=`echo dir'_'opendir | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -2369,7 +2367,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-ldir  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 2373 "configure"
+#line 2371 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -2380,7 +2378,7 @@
 opendir()
 ; return 0; }
 EOF
-if { (eval echo configure:2384: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:2382: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -2402,7 +2400,7 @@
 
 else
 echo $ac_n "checking for opendir in -lx""... $ac_c" 1>&6
-echo "configure:2406: checking for opendir in -lx" >&5
+echo "configure:2404: checking for opendir in -lx" >&5
 ac_lib_var=`echo x'_'opendir | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -2410,7 +2408,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lx  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 2414 "configure"
+#line 2412 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -2421,7 +2419,7 @@
 opendir()
 ; return 0; }
 EOF
-if { (eval echo configure:2425: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:2423: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -2444,12 +2442,12 @@
 fi
 
 echo $ac_n "checking for ANSI C header files""... $ac_c" 1>&6
-echo "configure:2448: checking for ANSI C header files" >&5
+echo "configure:2446: checking for ANSI C header files" >&5
 if eval "test \"`echo '$''{'ac_cv_header_stdc'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2453 "configure"
+#line 2451 "configure"
 #include "confdefs.h"
 #include <stdlib.h>
 #include <stdarg.h>
@@ -2457,7 +2455,7 @@
 #include <float.h>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:2461: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:2459: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -2474,7 +2472,7 @@
 if test $ac_cv_header_stdc = yes; then
   # SunOS 4.x string.h does not declare mem*, contrary to ANSI.
 cat > conftest.$ac_ext <<EOF
-#line 2478 "configure"
+#line 2476 "configure"
 #include "confdefs.h"
 #include <string.h>
 EOF
@@ -2492,7 +2490,7 @@
 if test $ac_cv_header_stdc = yes; then
   # ISC 2.0.2 stdlib.h does not declare free, contrary to ANSI.
 cat > conftest.$ac_ext <<EOF
-#line 2496 "configure"
+#line 2494 "configure"
 #include "confdefs.h"
 #include <stdlib.h>
 EOF
@@ -2513,7 +2511,7 @@
   :
 else
   cat > conftest.$ac_ext <<EOF
-#line 2517 "configure"
+#line 2515 "configure"
 #include "confdefs.h"
 #include <ctype.h>
 #define ISLOWER(c) ('a' <= (c) && (c) <= 'z')
@@ -2524,7 +2522,7 @@
 exit (0); }
 
 EOF
-if { (eval echo configure:2528: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:2526: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   :
 else
@@ -2552,17 +2550,17 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
-echo "configure:2556: checking for $ac_hdr" >&5
+echo "configure:2554: checking for $ac_hdr" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2561 "configure"
+#line 2559 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:2566: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:2564: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -2592,17 +2590,17 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
-echo "configure:2596: checking for $ac_hdr" >&5
+echo "configure:2594: checking for $ac_hdr" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2601 "configure"
+#line 2599 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:2606: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:2604: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -2632,17 +2630,17 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
-echo "configure:2636: checking for $ac_hdr" >&5
+echo "configure:2634: checking for $ac_hdr" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2641 "configure"
+#line 2639 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:2646: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:2644: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -2672,17 +2670,17 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
-echo "configure:2676: checking for $ac_hdr" >&5
+echo "configure:2674: checking for $ac_hdr" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2681 "configure"
+#line 2679 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:2686: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:2684: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -2712,17 +2710,17 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
-echo "configure:2716: checking for $ac_hdr" >&5
+echo "configure:2714: checking for $ac_hdr" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2721 "configure"
+#line 2719 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:2726: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:2724: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -2750,17 +2748,17 @@
 
 ac_safe=`echo "be_math.h" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for be_math.h""... $ac_c" 1>&6
-echo "configure:2754: checking for be_math.h" >&5
+echo "configure:2752: checking for be_math.h" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2759 "configure"
+#line 2757 "configure"
 #include "confdefs.h"
 #include <be_math.h>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:2764: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:2762: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -2786,17 +2784,17 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
-echo "configure:2790: checking for $ac_hdr" >&5
+echo "configure:2788: checking for $ac_hdr" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2795 "configure"
+#line 2793 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:2800: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:2798: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -2826,17 +2824,17 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
-echo "configure:2830: checking for $ac_hdr" >&5
+echo "configure:2828: checking for $ac_hdr" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2835 "configure"
+#line 2833 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:2840: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:2838: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -2866,17 +2864,17 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
-echo "configure:2870: checking for $ac_hdr" >&5
+echo "configure:2868: checking for $ac_hdr" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2875 "configure"
+#line 2873 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:2880: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:2878: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -2904,7 +2902,7 @@
 
 
 echo $ac_n "checking size of char""... $ac_c" 1>&6
-echo "configure:2908: checking size of char" >&5
+echo "configure:2906: checking size of char" >&5
 if eval "test \"`echo '$''{'ac_cv_sizeof_char'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -2912,7 +2910,7 @@
   ac_cv_sizeof_char=1
 else
   cat > conftest.$ac_ext <<EOF
-#line 2916 "configure"
+#line 2914 "configure"
 #include "confdefs.h"
 #include <stdio.h>
 main()
@@ -2923,7 +2921,7 @@
   exit(0);
 }
 EOF
-if { (eval echo configure:2927: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:2925: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   ac_cv_sizeof_char=`cat conftestval`
 else
@@ -2943,7 +2941,7 @@
 
 
 echo $ac_n "checking size of short""... $ac_c" 1>&6
-echo "configure:2947: checking size of short" >&5
+echo "configure:2945: checking size of short" >&5
 if eval "test \"`echo '$''{'ac_cv_sizeof_short'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -2951,7 +2949,7 @@
   ac_cv_sizeof_short=2
 else
   cat > conftest.$ac_ext <<EOF
-#line 2955 "configure"
+#line 2953 "configure"
 #include "confdefs.h"
 #include <stdio.h>
 main()
@@ -2962,7 +2960,7 @@
   exit(0);
 }
 EOF
-if { (eval echo configure:2966: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:2964: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   ac_cv_sizeof_short=`cat conftestval`
 else
@@ -2982,7 +2980,7 @@
 
 
 echo $ac_n "checking size of int""... $ac_c" 1>&6
-echo "configure:2986: checking size of int" >&5
+echo "configure:2984: checking size of int" >&5
 if eval "test \"`echo '$''{'ac_cv_sizeof_int'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -2990,7 +2988,7 @@
   ac_cv_sizeof_int=4
 else
   cat > conftest.$ac_ext <<EOF
-#line 2994 "configure"
+#line 2992 "configure"
 #include "confdefs.h"
 #include <stdio.h>
 main()
@@ -3001,7 +2999,7 @@
   exit(0);
 }
 EOF
-if { (eval echo configure:3005: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:3003: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   ac_cv_sizeof_int=`cat conftestval`
 else
@@ -3021,7 +3019,7 @@
 
 
 echo $ac_n "checking size of long""... $ac_c" 1>&6
-echo "configure:3025: checking size of long" >&5
+echo "configure:3023: checking size of long" >&5
 if eval "test \"`echo '$''{'ac_cv_sizeof_long'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -3029,7 +3027,7 @@
   ac_cv_sizeof_long=4
 else
   cat > conftest.$ac_ext <<EOF
-#line 3033 "configure"
+#line 3031 "configure"
 #include "confdefs.h"
 #include <stdio.h>
 main()
@@ -3040,7 +3038,7 @@
   exit(0);
 }
 EOF
-if { (eval echo configure:3044: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:3042: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   ac_cv_sizeof_long=`cat conftestval`
 else
@@ -3060,7 +3058,7 @@
 
 
 echo $ac_n "checking size of long long""... $ac_c" 1>&6
-echo "configure:3064: checking size of long long" >&5
+echo "configure:3062: checking size of long long" >&5
 if eval "test \"`echo '$''{'ac_cv_sizeof_long_long'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -3068,7 +3066,7 @@
   ac_cv_sizeof_long_long=8
 else
   cat > conftest.$ac_ext <<EOF
-#line 3072 "configure"
+#line 3070 "configure"
 #include "confdefs.h"
 #include <stdio.h>
 main()
@@ -3079,7 +3077,7 @@
   exit(0);
 }
 EOF
-if { (eval echo configure:3083: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:3081: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   ac_cv_sizeof_long_long=`cat conftestval`
 else
@@ -3099,7 +3097,7 @@
 
 
 echo $ac_n "checking size of __int64""... $ac_c" 1>&6
-echo "configure:3103: checking size of __int64" >&5
+echo "configure:3101: checking size of __int64" >&5
 if eval "test \"`echo '$''{'ac_cv_sizeof___int64'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -3107,7 +3105,7 @@
   ac_cv_sizeof___int64=8
 else
   cat > conftest.$ac_ext <<EOF
-#line 3111 "configure"
+#line 3109 "configure"
 #include "confdefs.h"
 #include <stdio.h>
 main()
@@ -3118,7 +3116,7 @@
   exit(0);
 }
 EOF
-if { (eval echo configure:3122: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:3120: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   ac_cv_sizeof___int64=`cat conftestval`
 else
@@ -3139,12 +3137,12 @@
 
 
 echo $ac_n "checking for working const""... $ac_c" 1>&6
-echo "configure:3143: checking for working const" >&5
+echo "configure:3141: checking for working const" >&5
 if eval "test \"`echo '$''{'ac_cv_c_const'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3148 "configure"
+#line 3146 "configure"
 #include "confdefs.h"
 
 int main() {
@@ -3193,7 +3191,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:3197: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:3195: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   ac_cv_c_const=yes
 else
@@ -3214,21 +3212,21 @@
 fi
 
 echo $ac_n "checking for inline""... $ac_c" 1>&6
-echo "configure:3218: checking for inline" >&5
+echo "configure:3216: checking for inline" >&5
 if eval "test \"`echo '$''{'ac_cv_c_inline'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   ac_cv_c_inline=no
 for ac_kw in inline __inline__ __inline; do
   cat > conftest.$ac_ext <<EOF
-#line 3225 "configure"
+#line 3223 "configure"
 #include "confdefs.h"
 
 int main() {
 } $ac_kw foo() {
 ; return 0; }
 EOF
-if { (eval echo configure:3232: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:3230: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   ac_cv_c_inline=$ac_kw; break
 else
@@ -3257,12 +3255,12 @@
   ac_cv_c_inline=
 fi
 echo $ac_n "checking for mode_t""... $ac_c" 1>&6
-echo "configure:3261: checking for mode_t" >&5
+echo "configure:3259: checking for mode_t" >&5
 if eval "test \"`echo '$''{'ac_cv_type_mode_t'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3266 "configure"
+#line 3264 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #if STDC_HEADERS
@@ -3290,12 +3288,12 @@
 fi
 
 echo $ac_n "checking for off_t""... $ac_c" 1>&6
-echo "configure:3294: checking for off_t" >&5
+echo "configure:3292: checking for off_t" >&5
 if eval "test \"`echo '$''{'ac_cv_type_off_t'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3299 "configure"
+#line 3297 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #if STDC_HEADERS
@@ -3323,12 +3321,12 @@
 fi
 
 echo $ac_n "checking for pid_t""... $ac_c" 1>&6
-echo "configure:3327: checking for pid_t" >&5
+echo "configure:3325: checking for pid_t" >&5
 if eval "test \"`echo '$''{'ac_cv_type_pid_t'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3332 "configure"
+#line 3330 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #if STDC_HEADERS
@@ -3356,12 +3354,12 @@
 fi
 
 echo $ac_n "checking for st_blocks in struct stat""... $ac_c" 1>&6
-echo "configure:3360: checking for st_blocks in struct stat" >&5
+echo "configure:3358: checking for st_blocks in struct stat" >&5
 if eval "test \"`echo '$''{'ac_cv_struct_st_blocks'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3365 "configure"
+#line 3363 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <sys/stat.h>
@@ -3369,7 +3367,7 @@
 struct stat s; s.st_blocks;
 ; return 0; }
 EOF
-if { (eval echo configure:3373: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:3371: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   ac_cv_struct_st_blocks=yes
 else
@@ -3392,12 +3390,12 @@
 fi
 
 echo $ac_n "checking whether time.h and sys/time.h may both be included""... $ac_c" 1>&6
-echo "configure:3396: checking whether time.h and sys/time.h may both be included" >&5
+echo "configure:3394: checking whether time.h and sys/time.h may both be included" >&5
 if eval "test \"`echo '$''{'ac_cv_header_time'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3401 "configure"
+#line 3399 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <sys/time.h>
@@ -3406,7 +3404,7 @@
 struct tm *tp;
 ; return 0; }
 EOF
-if { (eval echo configure:3410: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:3408: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   ac_cv_header_time=yes
 else
@@ -3427,12 +3425,12 @@
 fi
 
 echo $ac_n "checking whether struct tm is in sys/time.h or time.h""... $ac_c" 1>&6
-echo "configure:3431: checking whether struct tm is in sys/time.h or time.h" >&5
+echo "configure:3429: checking whether struct tm is in sys/time.h or time.h" >&5
 if eval "test \"`echo '$''{'ac_cv_struct_tm'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3436 "configure"
+#line 3434 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <time.h>
@@ -3440,7 +3438,7 @@
 struct tm *tp; tp->tm_sec;
 ; return 0; }
 EOF
-if { (eval echo configure:3444: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:3442: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   ac_cv_struct_tm=time.h
 else
@@ -3463,13 +3461,13 @@
 
 if test $ac_cv_prog_gcc = yes; then
     echo $ac_n "checking whether ${CC-cc} needs -traditional""... $ac_c" 1>&6
-echo "configure:3467: checking whether ${CC-cc} needs -traditional" >&5
+echo "configure:3465: checking whether ${CC-cc} needs -traditional" >&5
 if eval "test \"`echo '$''{'ac_cv_prog_gcc_traditional'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
     ac_pattern="Autoconf.*'x'"
   cat > conftest.$ac_ext <<EOF
-#line 3473 "configure"
+#line 3471 "configure"
 #include "confdefs.h"
 #include <sgtty.h>
 Autoconf TIOCGETP
@@ -3487,7 +3485,7 @@
 
   if test $ac_cv_prog_gcc_traditional = no; then
     cat > conftest.$ac_ext <<EOF
-#line 3491 "configure"
+#line 3489 "configure"
 #include "confdefs.h"
 #include <termio.h>
 Autoconf TCGETA
@@ -3509,7 +3507,7 @@
 fi
 
 echo $ac_n "checking for 8-bit clean memcmp""... $ac_c" 1>&6
-echo "configure:3513: checking for 8-bit clean memcmp" >&5
+echo "configure:3511: checking for 8-bit clean memcmp" >&5
 if eval "test \"`echo '$''{'ac_cv_func_memcmp_clean'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -3517,7 +3515,7 @@
   ac_cv_func_memcmp_clean=no
 else
   cat > conftest.$ac_ext <<EOF
-#line 3521 "configure"
+#line 3519 "configure"
 #include "confdefs.h"
 
 main()
@@ -3527,7 +3525,7 @@
 }
 
 EOF
-if { (eval echo configure:3531: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:3529: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   ac_cv_func_memcmp_clean=yes
 else
@@ -3545,12 +3543,12 @@
 test $ac_cv_func_memcmp_clean = no && LIBOBJS="$LIBOBJS memcmp.o"
 
 echo $ac_n "checking return type of signal handlers""... $ac_c" 1>&6
-echo "configure:3549: checking return type of signal handlers" >&5
+echo "configure:3547: checking return type of signal handlers" >&5
 if eval "test \"`echo '$''{'ac_cv_type_signal'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3554 "configure"
+#line 3552 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <signal.h>
@@ -3567,7 +3565,7 @@
 int i;
 ; return 0; }
 EOF
-if { (eval echo configure:3571: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:3569: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   ac_cv_type_signal=void
 else
@@ -3586,7 +3584,7 @@
 
 
 echo $ac_n "checking whether utime accepts a null argument""... $ac_c" 1>&6
-echo "configure:3590: checking whether utime accepts a null argument" >&5
+echo "configure:3588: checking whether utime accepts a null argument" >&5
 if eval "test \"`echo '$''{'ac_cv_func_utime_null'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -3596,7 +3594,7 @@
   ac_cv_func_utime_null=no
 else
   cat > conftest.$ac_ext <<EOF
-#line 3600 "configure"
+#line 3598 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <sys/stat.h>
@@ -3607,7 +3605,7 @@
 && t.st_mtime - s.st_mtime < 120));
 }
 EOF
-if { (eval echo configure:3611: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:3609: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   ac_cv_func_utime_null=yes
 else
@@ -3633,12 +3631,12 @@
 for ac_func in getcwd getopt strdup gettimeofday sigaction mkdir rmdir select strerror strstr
 do
 echo $ac_n "checking for $ac_func""... $ac_c" 1>&6
-echo "configure:3637: checking for $ac_func" >&5
+echo "configure:3635: checking for $ac_func" >&5
 if eval "test \"`echo '$''{'ac_cv_func_$ac_func'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3642 "configure"
+#line 3640 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char $ac_func(); below.  */
@@ -3661,7 +3659,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:3665: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:3663: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_func_$ac_func=yes"
 else
@@ -3688,12 +3686,12 @@
 for ac_func in tcgetattr cfmakeraw readdir_r vprintf vsprintf vfprintf
 do
 echo $ac_n "checking for $ac_func""... $ac_c" 1>&6
-echo "configure:3692: checking for $ac_func" >&5
+echo "configure:3690: checking for $ac_func" >&5
 if eval "test \"`echo '$''{'ac_cv_func_$ac_func'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3697 "configure"
+#line 3695 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char $ac_func(); below.  */
@@ -3716,7 +3714,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:3720: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:3718: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_func_$ac_func=yes"
 else
@@ -3753,17 +3751,17 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
-echo "configure:3757: checking for $ac_hdr" >&5
+echo "configure:3755: checking for $ac_hdr" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3762 "configure"
+#line 3760 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:3767: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:3765: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -3795,12 +3793,12 @@
 listmntent memcpy mkfifo strchr strerror strrchr
 do
 echo $ac_n "checking for $ac_func""... $ac_c" 1>&6
-echo "configure:3799: checking for $ac_func" >&5
+echo "configure:3797: checking for $ac_func" >&5
 if eval "test \"`echo '$''{'ac_cv_func_$ac_func'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3804 "configure"
+#line 3802 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char $ac_func(); below.  */
@@ -3823,7 +3821,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:3827: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:3825: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_func_$ac_func=yes"
 else
@@ -3855,7 +3853,7 @@
 # make sure LIBS contains -lsun (on Irix4) or -lseq (on PTX).
 # getmntent is in -lsun on Irix 4, -lseq on Dynix/PTX, -lgen on Unixware.
 echo $ac_n "checking for getmntent in -lsun""... $ac_c" 1>&6
-echo "configure:3859: checking for getmntent in -lsun" >&5
+echo "configure:3857: checking for getmntent in -lsun" >&5
 ac_lib_var=`echo sun'_'getmntent | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -3863,7 +3861,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lsun  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 3867 "configure"
+#line 3865 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -3874,7 +3872,7 @@
 getmntent()
 ; return 0; }
 EOF
-if { (eval echo configure:3878: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:3876: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -3893,7 +3891,7 @@
 else
   echo "$ac_t""no" 1>&6
 echo $ac_n "checking for getmntent in -lseq""... $ac_c" 1>&6
-echo "configure:3897: checking for getmntent in -lseq" >&5
+echo "configure:3895: checking for getmntent in -lseq" >&5
 ac_lib_var=`echo seq'_'getmntent | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -3901,7 +3899,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lseq  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 3905 "configure"
+#line 3903 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -3912,7 +3910,7 @@
 getmntent()
 ; return 0; }
 EOF
-if { (eval echo configure:3916: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:3914: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -3931,7 +3929,7 @@
 else
   echo "$ac_t""no" 1>&6
 echo $ac_n "checking for getmntent in -lgen""... $ac_c" 1>&6
-echo "configure:3935: checking for getmntent in -lgen" >&5
+echo "configure:3933: checking for getmntent in -lgen" >&5
 ac_lib_var=`echo gen'_'getmntent | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -3939,7 +3937,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lgen  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 3943 "configure"
+#line 3941 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -3950,7 +3948,7 @@
 getmntent()
 ; return 0; }
 EOF
-if { (eval echo configure:3954: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:3952: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -3975,12 +3973,12 @@
 fi
 
 echo $ac_n "checking for getmntent""... $ac_c" 1>&6
-echo "configure:3979: checking for getmntent" >&5
+echo "configure:3977: checking for getmntent" >&5
 if eval "test \"`echo '$''{'ac_cv_func_getmntent'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 3984 "configure"
+#line 3982 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char getmntent(); below.  */
@@ -4003,7 +4001,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:4007: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:4005: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_func_getmntent=yes"
 else
@@ -4038,13 +4036,13 @@
 if test -z "$list_mounted_fs"; then
 # Cray UNICOS 9
 echo $ac_n "checking for listmntent of Cray/Unicos-9""... $ac_c" 1>&6
-echo "configure:4042: checking for listmntent of Cray/Unicos-9" >&5
+echo "configure:4040: checking for listmntent of Cray/Unicos-9" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_mounted_cray_listmntent'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   fu_cv_sys_mounted_cray_listmntent=no
 cat > conftest.$ac_ext <<EOF
-#line 4048 "configure"
+#line 4046 "configure"
 #include "confdefs.h"
 #ifdef _CRAY
 yes
@@ -4082,7 +4080,7 @@
 if test -z "$list_mounted_fs"; then
 # 4.3BSD, SunOS, HP-UX, Dynix, Irix
 echo $ac_n "checking for one-argument getmntent function""... $ac_c" 1>&6
-echo "configure:4086: checking for one-argument getmntent function" >&5
+echo "configure:4084: checking for one-argument getmntent function" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_mounted_getmntent1'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -4104,12 +4102,12 @@
 if test -z "$list_mounted_fs"; then
 # SVR4
 echo $ac_n "checking for two-argument getmntent function""... $ac_c" 1>&6
-echo "configure:4108: checking for two-argument getmntent function" >&5
+echo "configure:4106: checking for two-argument getmntent function" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_mounted_getmntent2'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 4113 "configure"
+#line 4111 "configure"
 #include "confdefs.h"
 #include <sys/mnttab.h>
 EOF
@@ -4144,12 +4142,12 @@
 if test -z "$list_mounted_fs"; then
 # DEC Alpha running OSF/1.
 echo $ac_n "checking for getfsstat function""... $ac_c" 1>&6
-echo "configure:4148: checking for getfsstat function" >&5
+echo "configure:4146: checking for getfsstat function" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_mounted_getsstat'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 4153 "configure"
+#line 4151 "configure"
 #include "confdefs.h"
 
 #include <sys/types.h>
@@ -4160,7 +4158,7 @@
 int numsys = getfsstat ((struct statfs *)0, 0L, MNT_WAIT); 
 ; return 0; }
 EOF
-if { (eval echo configure:4164: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:4162: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   fu_cv_sys_mounted_getsstat=yes
 else
@@ -4185,17 +4183,17 @@
 if test -z "$list_mounted_fs"; then
 # AIX.
 echo $ac_n "checking for mntctl function and struct vmount""... $ac_c" 1>&6
-echo "configure:4189: checking for mntctl function and struct vmount" >&5
+echo "configure:4187: checking for mntctl function and struct vmount" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_mounted_vmount'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 4194 "configure"
+#line 4192 "configure"
 #include "confdefs.h"
 #include <fshelp.h>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:4199: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:4197: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -4223,12 +4221,12 @@
 if test -z "$list_mounted_fs"; then
 # SVR3
 echo $ac_n "checking for FIXME existence of three headers""... $ac_c" 1>&6
-echo "configure:4227: checking for FIXME existence of three headers" >&5
+echo "configure:4225: checking for FIXME existence of three headers" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_mounted_fread_fstyp'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 4232 "configure"
+#line 4230 "configure"
 #include "confdefs.h"
 
 #include <sys/statfs.h>
@@ -4236,7 +4234,7 @@
 #include <mnttab.h>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:4240: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:4238: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -4264,7 +4262,7 @@
 if test -z "$list_mounted_fs"; then
 # 4.4BSD and DEC OSF/1.
 echo $ac_n "checking for getmntinfo function""... $ac_c" 1>&6
-echo "configure:4268: checking for getmntinfo function" >&5
+echo "configure:4266: checking for getmntinfo function" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_mounted_getmntinfo'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -4272,7 +4270,7 @@
 ok=
 if test $ac_cv_func_getmntinfo = yes; then
 cat > conftest.$ac_ext <<EOF
-#line 4276 "configure"
+#line 4274 "configure"
 #include "confdefs.h"
 #include <sys/mount.h>
 EOF
@@ -4305,19 +4303,19 @@
 if test -z "$list_mounted_fs"; then
 # Ultrix
 echo $ac_n "checking for getmnt function""... $ac_c" 1>&6
-echo "configure:4309: checking for getmnt function" >&5
+echo "configure:4307: checking for getmnt function" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_mounted_getmnt'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 4314 "configure"
+#line 4312 "configure"
 #include "confdefs.h"
 
 #include <sys/fs_types.h>
 #include <sys/mount.h>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:4321: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:4319: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -4345,17 +4343,17 @@
 if test -z "$list_mounted_fs"; then
 # SVR2
 echo $ac_n "checking whether it is possible to resort to fread on /etc/mnttab""... $ac_c" 1>&6
-echo "configure:4349: checking whether it is possible to resort to fread on /etc/mnttab" >&5
+echo "configure:4347: checking whether it is possible to resort to fread on /etc/mnttab" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_mounted_fread'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 4354 "configure"
+#line 4352 "configure"
 #include "confdefs.h"
 #include <mnttab.h>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:4359: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:4357: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -4387,7 +4385,7 @@
 fi
 
 echo "checking how to get filesystem space usage" 1>&6
-echo "configure:4391: checking how to get filesystem space usage" >&5
+echo "configure:4389: checking how to get filesystem space usage" >&5
 space=no
 
 # Perform only the link test since it seems there are no variants of the
@@ -4399,12 +4397,12 @@
 if test $space = no; then
 # SVR4
 echo $ac_n "checking statvfs function (SVR4)""... $ac_c" 1>&6
-echo "configure:4403: checking statvfs function (SVR4)" >&5
+echo "configure:4401: checking statvfs function (SVR4)" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_stat_statvfs'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 4408 "configure"
+#line 4406 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <sys/statvfs.h>
@@ -4412,7 +4410,7 @@
 struct statvfs fsd; statvfs (0, &fsd);
 ; return 0; }
 EOF
-if { (eval echo configure:4416: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:4414: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   fu_cv_sys_stat_statvfs=yes
 else
@@ -4437,7 +4435,7 @@
 if test $space = no; then
 # DEC Alpha running OSF/1
 echo $ac_n "checking for 3-argument statfs function (DEC OSF/1)""... $ac_c" 1>&6
-echo "configure:4441: checking for 3-argument statfs function (DEC OSF/1)" >&5
+echo "configure:4439: checking for 3-argument statfs function (DEC OSF/1)" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_stat_statfs3_osf1'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -4445,7 +4443,7 @@
   fu_cv_sys_stat_statfs3_osf1=no
 else
   cat > conftest.$ac_ext <<EOF
-#line 4449 "configure"
+#line 4447 "configure"
 #include "confdefs.h"
 
 #include <sys/param.h>
@@ -4458,7 +4456,7 @@
 exit (statfs (".", &fsd, sizeof (struct statfs)));
 }
 EOF
-if { (eval echo configure:4462: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:4460: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   fu_cv_sys_stat_statfs3_osf1=yes
 else
@@ -4485,7 +4483,7 @@
 if test $space = no; then
 # AIX
 echo $ac_n "checking for two-argument statfs with statfs.bsize member (AIX, 4.3BSD)""... $ac_c" 1>&6
-echo "configure:4489: checking for two-argument statfs with statfs.bsize member (AIX, 4.3BSD)" >&5
+echo "configure:4487: checking for two-argument statfs with statfs.bsize member (AIX, 4.3BSD)" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_stat_statfs2_bsize'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -4493,7 +4491,7 @@
   fu_cv_sys_stat_statfs2_bsize=no
 else
   cat > conftest.$ac_ext <<EOF
-#line 4497 "configure"
+#line 4495 "configure"
 #include "confdefs.h"
 
 #ifdef HAVE_SYS_PARAM_H
@@ -4512,7 +4510,7 @@
 exit (statfs (".", &fsd));
 }
 EOF
-if { (eval echo configure:4516: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:4514: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   fu_cv_sys_stat_statfs2_bsize=yes
 else
@@ -4539,7 +4537,7 @@
 if test $space = no; then
 # SVR3
 echo $ac_n "checking for four-argument statfs (AIX-3.2.5, SVR3)""... $ac_c" 1>&6
-echo "configure:4543: checking for four-argument statfs (AIX-3.2.5, SVR3)" >&5
+echo "configure:4541: checking for four-argument statfs (AIX-3.2.5, SVR3)" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_stat_statfs4'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -4547,7 +4545,7 @@
   fu_cv_sys_stat_statfs4=no
 else
   cat > conftest.$ac_ext <<EOF
-#line 4551 "configure"
+#line 4549 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <sys/statfs.h>
@@ -4557,7 +4555,7 @@
 exit (statfs (".", &fsd, sizeof fsd, 0));
 }
 EOF
-if { (eval echo configure:4561: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:4559: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   fu_cv_sys_stat_statfs4=yes
 else
@@ -4584,7 +4582,7 @@
 if test $space = no; then
 # 4.4BSD and NetBSD
 echo $ac_n "checking for two-argument statfs with statfs.fsize member (4.4BSD and NetBSD)""... $ac_c" 1>&6
-echo "configure:4588: checking for two-argument statfs with statfs.fsize member (4.4BSD and NetBSD)" >&5
+echo "configure:4586: checking for two-argument statfs with statfs.fsize member (4.4BSD and NetBSD)" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_stat_statfs2_fsize'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -4592,7 +4590,7 @@
   fu_cv_sys_stat_statfs2_fsize=no
 else
   cat > conftest.$ac_ext <<EOF
-#line 4596 "configure"
+#line 4594 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #ifdef HAVE_SYS_PARAM_H
@@ -4608,7 +4606,7 @@
 exit (statfs (".", &fsd));
 }
 EOF
-if { (eval echo configure:4612: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:4610: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   fu_cv_sys_stat_statfs2_fsize=yes
 else
@@ -4635,7 +4633,7 @@
 if test $space = no; then
 # Ultrix
 echo $ac_n "checking for two-argument statfs with struct fs_data (Ultrix)""... $ac_c" 1>&6
-echo "configure:4639: checking for two-argument statfs with struct fs_data (Ultrix)" >&5
+echo "configure:4637: checking for two-argument statfs with struct fs_data (Ultrix)" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_stat_fs_data'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -4643,7 +4641,7 @@
   fu_cv_sys_stat_fs_data=no
 else
   cat > conftest.$ac_ext <<EOF
-#line 4647 "configure"
+#line 4645 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #ifdef HAVE_SYS_PARAM_H
@@ -4663,7 +4661,7 @@
 exit (statfs (".", &fsd) != 1);
 }
 EOF
-if { (eval echo configure:4667: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:4665: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   fu_cv_sys_stat_fs_data=yes
 else
@@ -4690,12 +4688,12 @@
 if test $space = no; then
 # SVR2
 cat > conftest.$ac_ext <<EOF
-#line 4694 "configure"
+#line 4692 "configure"
 #include "confdefs.h"
 #include <sys/filsys.h>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:4699: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+{ (eval echo configure:4697: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
 ac_err=`grep -v '^ *+' conftest.out`
 if test -z "$ac_err"; then
   rm -rf conftest*
@@ -4720,12 +4718,12 @@
 for ac_func in ftruncate
 do
 echo $ac_n "checking for $ac_func""... $ac_c" 1>&6
-echo "configure:4724: checking for $ac_func" >&5
+echo "configure:4722: checking for $ac_func" >&5
 if eval "test \"`echo '$''{'ac_cv_func_$ac_func'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 4729 "configure"
+#line 4727 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char $ac_func(); below.  */
@@ -4748,7 +4746,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:4752: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:4750: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_func_$ac_func=yes"
 else
@@ -4776,12 +4774,12 @@
 
 if test "$ftruncate_missing" = yes; then
 echo $ac_n "checking fcntl emulation of ftruncate""... $ac_c" 1>&6
-echo "configure:4780: checking fcntl emulation of ftruncate" >&5
+echo "configure:4778: checking fcntl emulation of ftruncate" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_ftruncate_emulation'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 4785 "configure"
+#line 4783 "configure"
 #include "confdefs.h"
 
 #include <sys/types.h>
@@ -4794,7 +4792,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:4798: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:4796: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   fu_cv_sys_ftruncate_emulation=yes
 else
@@ -4822,12 +4820,12 @@
 # If <sys/vfs.h> exists and struct statfs has a member named f_spare,
 # enable the work-around code in fsusage.c.
 echo $ac_n "checking for statfs that truncates block counts""... $ac_c" 1>&6
-echo "configure:4826: checking for statfs that truncates block counts" >&5
+echo "configure:4824: checking for statfs that truncates block counts" >&5
 if eval "test \"`echo '$''{'fu_cv_sys_truncating_statfs'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 4831 "configure"
+#line 4829 "configure"
 #include "confdefs.h"
 
 #if !defined(sun) && !defined(__sun)
@@ -4839,7 +4837,7 @@
 struct statfs t; long c = *(t.f_spare);
 ; return 0; }
 EOF
-if { (eval echo configure:4843: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:4841: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   fu_cv_sys_truncating_statfs=yes
 else
@@ -4860,7 +4858,7 @@
 echo "$ac_t""$fu_cv_sys_truncating_statfs" 1>&6
 
 echo "checking for AFS" 1>&6
-echo "configure:4864: checking for AFS" >&5
+echo "configure:4862: checking for AFS" >&5
 test -d /afs && cat >> confdefs.h <<\EOF
 #define AFS 1
 EOF
@@ -4872,9 +4870,9 @@
     HAVE_POS=yes
 else
   echo $ac_n "checking for pOS""... $ac_c" 1>&6
-echo "configure:4876: checking for pOS" >&5
+echo "configure:4874: checking for pOS" >&5
   cat > conftest.$ac_ext <<EOF
-#line 4878 "configure"
+#line 4876 "configure"
 #include "confdefs.h"
 #ifdef __POS__
     yes
@@ -4902,16 +4900,16 @@
   else
     if [ "x$ac_cv_header_ncurses_h" = "xno" ]; then
       echo $ac_n "checking for attr_t in curses.h""... $ac_c" 1>&6
-echo "configure:4906: checking for attr_t in curses.h" >&5
+echo "configure:4904: checking for attr_t in curses.h" >&5
       cat > conftest.$ac_ext <<EOF
-#line 4908 "configure"
+#line 4906 "configure"
 #include "confdefs.h"
 #include <curses.h>
 int main() {
 { attr_t a; a = A_NORMAL; }
 ; return 0; }
 EOF
-if { (eval echo configure:4915: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:4913: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   echo "$ac_t""yes" 1>&6
 else
@@ -4928,16 +4926,16 @@
 rm -f conftest*
     else
       echo $ac_n "checking for attr_t in ncurses.h""... $ac_c" 1>&6
-echo "configure:4932: checking for attr_t in ncurses.h" >&5
+echo "configure:4930: checking for attr_t in ncurses.h" >&5
       cat > conftest.$ac_ext <<EOF
-#line 4934 "configure"
+#line 4932 "configure"
 #include "confdefs.h"
 #include <ncurses.h>
 int main() {
 { attr_t a; a = A_NORMAL; }
 ; return 0; }
 EOF
-if { (eval echo configure:4941: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:4939: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   echo "$ac_t""yes" 1>&6
 else
@@ -4958,12 +4956,12 @@
 
 
 echo $ac_n "checking for pthread library""... $ac_c" 1>&6
-echo "configure:4962: checking for pthread library" >&5
+echo "configure:4960: checking for pthread library" >&5
 TMP_SAVE_CFLAGS=$CFLAGS
 TMP_SAVE_LIBS=$LIBS
 LIBS="$LIBS -lpthread"
 cat > conftest.$ac_ext <<EOF
-#line 4967 "configure"
+#line 4965 "configure"
 #include "confdefs.h"
 
 #include "confdefs.h"
@@ -4979,7 +4977,7 @@
 }
 ; return 0; }
 EOF
-if { (eval echo configure:4983: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:4981: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   HAVE_PTHREAD_LIB=yes
 echo "$ac_t""yes" 1>&6
@@ -4995,13 +4993,13 @@
 LIBS=$TMP_SAVE_LIBS
 
 echo $ac_n "checking for DirectX""... $ac_c" 1>&6
-echo "configure:4999: checking for DirectX" >&5
+echo "configure:4997: checking for DirectX" >&5
 TMP_SAVE_CFLAGS=$CFLAGS
 TMP_SAVE_LIBS=$LIBS
 CFLAGS="$CFLAGS $X_CFLAGS"
 LIBS="$LIBS -lddraw"
 cat > conftest.$ac_ext <<EOF
-#line 5005 "configure"
+#line 5003 "configure"
 #include "confdefs.h"
 
 #include "confdefs.h"
@@ -5017,7 +5015,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:5021: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:5019: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   HAVE_DIRECTX=yes
 echo "$ac_t""yes" 1>&6
@@ -5158,7 +5156,7 @@
   TMP_SAVE_LIBS=$LIBS
   LIBS="$X_LIBS $LIBS"
   echo $ac_n "checking for XF86DGAQueryExtension in -lXxf86dga""... $ac_c" 1>&6
-echo "configure:5162: checking for XF86DGAQueryExtension in -lXxf86dga" >&5
+echo "configure:5160: checking for XF86DGAQueryExtension in -lXxf86dga" >&5
 ac_lib_var=`echo Xxf86dga'_'XF86DGAQueryExtension | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -5166,7 +5164,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lXxf86dga  $X_PRE_LIBS -lXext -lX11 $X_EXTRA_LIBS  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 5170 "configure"
+#line 5168 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -5177,7 +5175,7 @@
 XF86DGAQueryExtension()
 ; return 0; }
 EOF
-if { (eval echo configure:5181: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:5179: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -5210,7 +5208,7 @@
   TMP_SAVE_LIBS=$LIBS
   LIBS="$X_LIBS $LIBS"
   echo $ac_n "checking for XF86VidModeQueryExtension in -lXxf86vm""... $ac_c" 1>&6
-echo "configure:5214: checking for XF86VidModeQueryExtension in -lXxf86vm" >&5
+echo "configure:5212: checking for XF86VidModeQueryExtension in -lXxf86vm" >&5
 ac_lib_var=`echo Xxf86vm'_'XF86VidModeQueryExtension | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -5218,7 +5216,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lXxf86vm  $X_PRE_LIBS -lXext -lX11 $X_EXTRA_LIBS  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 5222 "configure"
+#line 5220 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -5229,7 +5227,7 @@
 XF86VidModeQueryExtension()
 ; return 0; }
 EOF
-if { (eval echo configure:5233: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:5231: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -5299,7 +5297,7 @@
   # Extract the first word of "gtk-config", so it can be a program name with args.
 set dummy gtk-config; ac_word=$2
 echo $ac_n "checking for $ac_word""... $ac_c" 1>&6
-echo "configure:5303: checking for $ac_word" >&5
+echo "configure:5301: checking for $ac_word" >&5
 if eval "test \"`echo '$''{'ac_cv_path_GTK_CONFIG'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -5330,7 +5328,7 @@
 
   min_gtk_version=0.99.7
   echo $ac_n "checking for GTK - version >= $min_gtk_version""... $ac_c" 1>&6
-echo "configure:5334: checking for GTK - version >= $min_gtk_version" >&5
+echo "configure:5332: checking for GTK - version >= $min_gtk_version" >&5
   no_gtk=""
   if test "$GTK_CONFIG" = "no" ; then
     no_gtk=yes
@@ -5353,7 +5351,7 @@
   echo $ac_n "cross compiling; assumed OK... $ac_c"
 else
   cat > conftest.$ac_ext <<EOF
-#line 5357 "configure"
+#line 5355 "configure"
 #include "confdefs.h"
 
 #include <gtk/gtk.h>
@@ -5416,7 +5414,7 @@
 }
 
 EOF
-if { (eval echo configure:5420: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:5418: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
 then
   :
 else
@@ -5450,7 +5448,7 @@
           CFLAGS="$CFLAGS $GTK_CFLAGS"
           LIBS="$LIBS $GTK_LIBS"
           cat > conftest.$ac_ext <<EOF
-#line 5454 "configure"
+#line 5452 "configure"
 #include "confdefs.h"
 
 #include <gtk/gtk.h>
@@ -5460,7 +5458,7 @@
  return ((gtk_major_version) || (gtk_minor_version) || (gtk_micro_version)); 
 ; return 0; }
 EOF
-if { (eval echo configure:5464: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:5462: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
    echo "*** The test program compiled, but did not run. This usually means"
           echo "*** that the run-time linker is not finding GTK or finding the wrong"
@@ -5503,13 +5501,13 @@
 SHM_SUPPORT_LINKS=0
 if [ "x$no_x" != "xyes" -a "x$ac_cv_header_sys_ipc_h" = "xyes" -a "x$ac_cv_header_sys_shm_h" = "xyes" ]; then
   echo $ac_n "checking whether the X11 MIT-SHM extension can be compiled in""... $ac_c" 1>&6
-echo "configure:5507: checking whether the X11 MIT-SHM extension can be compiled in" >&5
+echo "configure:5505: checking whether the X11 MIT-SHM extension can be compiled in" >&5
   TMP_SAVE_CFLAGS=$CFLAGS
   TMP_SAVE_LIBS=$LIBS
   CFLAGS="$CFLAGS $X_CFLAGS"
   LIBS="$X_LIBS $LIBS $X_PRE_LIBS -lX11 -lXext $X_EXTRA_LIBS"
   cat > conftest.$ac_ext <<EOF
-#line 5513 "configure"
+#line 5511 "configure"
 #include "confdefs.h"
 
 #include "confdefs.h"
@@ -5535,7 +5533,7 @@
 }
 ; return 0; }
 EOF
-if { (eval echo configure:5539: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:5537: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
   rm -rf conftest*
   SHM_SUPPORT_LINKS=1
 echo "$ac_t""yes" 1>&6
@@ -5555,7 +5553,7 @@
 DEBUGOBJS="debug.o"
 
 echo $ac_n "checking which target to use""... $ac_c" 1>&6
-echo "configure:5559: checking which target to use" >&5
+echo "configure:5557: checking which target to use" >&5
 
 if [ "x$HAVE_DIRECTX" = "xyes" ]; then
   echo "$ac_t""Win32/DirectX" 1>&6
@@ -5714,7 +5712,6 @@
 
 USE_PENGUINS=no
 USE_THREADS=no
-USE_SOUND=no
 USE_FILE_SOUND=no
 
 USE_UNDERSCORE=dunno
@@ -5731,9 +5728,9 @@
 CPUOBJS=cpuemu.o
 
 echo $ac_n "checking for GCC 2.7 or higher""... $ac_c" 1>&6
-echo "configure:5735: checking for GCC 2.7 or higher" >&5
+echo "configure:5732: checking for GCC 2.7 or higher" >&5
 cat > conftest.$ac_ext <<EOF
-#line 5737 "configure"
+#line 5734 "configure"
 #include "confdefs.h"
 #if __GNUC__ - 1 > 1 || __GNUC_MINOR__ - 1 > 5
   yes
@@ -5764,9 +5761,9 @@
 
 if [ "x$ac_cv_header_features_h" = "xyes" ]; then
   echo $ac_n "checking for glibc-2.0 or higher""... $ac_c" 1>&6
-echo "configure:5768: checking for glibc-2.0 or higher" >&5
+echo "configure:5765: checking for glibc-2.0 or higher" >&5
   cat > conftest.$ac_ext <<EOF
-#line 5770 "configure"
+#line 5767 "configure"
 #include "confdefs.h"
 #include <features.h>
 #if __GLIBC__ - 1 >= 1
@@ -5813,9 +5810,9 @@
 fi
 
 echo $ac_n "checking for x86 target CPU""... $ac_c" 1>&6
-echo "configure:5817: checking for x86 target CPU" >&5
+echo "configure:5814: checking for x86 target CPU" >&5
 cat > conftest.$ac_ext <<EOF
-#line 5819 "configure"
+#line 5816 "configure"
 #include "confdefs.h"
 
 #ifdef __i386__
@@ -5835,9 +5832,9 @@
 
 
 echo $ac_n "checking for m68k target CPU""... $ac_c" 1>&6
-echo "configure:5839: checking for m68k target CPU" >&5
+echo "configure:5836: checking for m68k target CPU" >&5
 cat > conftest.$ac_ext <<EOF
-#line 5841 "configure"
+#line 5838 "configure"
 #include "confdefs.h"
 
 #ifdef __m68k__
@@ -5848,7 +5845,7 @@
 if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
   egrep "yes" >/dev/null 2>&1; then
   rm -rf conftest*
-  echo "$ac_t""yes" 1>&6; HAVEI386=yes
+  echo "$ac_t""yes" 1>&6; HAVE68K=yes
 else
   rm -rf conftest*
   echo "$ac_t""no" 1>&6
@@ -5867,14 +5864,14 @@
 
 if [ "x$HAVE_MACHINE_JOYSTICK_H" = "xyes" ]; then
   cat > conftest.$ac_ext <<EOF
-#line 5871 "configure"
+#line 5868 "configure"
 #include "confdefs.h"
 #include <machine/joystick.h>
 int main() {
 { struct joystick a; }
 ; return 0; }
 EOF
-if { (eval echo configure:5878: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:5875: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   OD_JOYSTICK=$abssrcdir/src/od-linux/joystick.c
 else
@@ -5886,7 +5883,7 @@
 
 
 echo $ac_n "checking for GAS .p2align feature""... $ac_c" 1>&6
-echo "configure:5890: checking for GAS .p2align feature" >&5
+echo "configure:5887: checking for GAS .p2align feature" >&5
 cat >conftest.S << EOF
 	.text
 	.p2align 5
@@ -5895,7 +5892,7 @@
 echo "$ac_t""$HAVEGAS" 1>&6
 
 echo $ac_n "checking whether assembler symbols need an underscore""... $ac_c" 1>&6
-echo "configure:5899: checking whether assembler symbols need an underscore" >&5
+echo "configure:5896: checking whether assembler symbols need an underscore" >&5
 cat >conftest1.S << EOF
 	.text
 	.globl _symbol
@@ -5975,14 +5972,14 @@
   SAVECFLAGS=$CFLAGS
   CFLAGS="$CFLAGS -mno-schedule-prologue"
   cat > conftest.$ac_ext <<EOF
-#line 5979 "configure"
+#line 5976 "configure"
 #include "confdefs.h"
 
 int main() {
 int main(){return 0;}
 ; return 0; }
 EOF
-if { (eval echo configure:5986: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:5983: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   NO_SCHED_CFLAGS="-mno-schedule-prologue"
 else
@@ -5999,14 +5996,14 @@
   CFLAGS="$CFLAGS -fno-exceptions"
   NOEXCEPTIONS=no
   cat > conftest.$ac_ext <<EOF
-#line 6003 "configure"
+#line 6000 "configure"
 #include "confdefs.h"
 
 int main() {
 int main(){return 0;}
 ; return 0; }
 EOF
-if { (eval echo configure:6010: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:6007: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   NOEXCEPTIONS=yes
 else
@@ -6044,7 +6041,7 @@
   CPU=`uname -m`
   if [ "x$CPU" = "xm68k" ]; then
      MACHDEP=md-68k
-     CFLAGS="$CFLAGS -DREGPARAM=\"__attribute__((regparm(4)))\" -DM68K_FLAG_OPT=1"
+     CFLAGS="$CFLAGS -DUNALIGNED_PROFITABLE -DREGPARAM=\"__attribute__((regparm(4)))\" -DM68K_FLAG_OPT=1"
   else if [ "x$CPU" = "xppc" ]; then
      MACHDEP=md-ppc
      CFLAGS="$CFLAGS -DREGPARAM="
@@ -6060,16 +6057,20 @@
   CFLAGS="$CFLAGS -nostdinc -I/gg/include -I/p/../inc -D__POS__"
   OSDEP=od-pos
   CPUOBJS="cpufast.o"
-else if [ "x$HAVEGCC27" = "xyes" -a "x$HAVE68K" = "xyes" -a "x$TARGET" = "xamigaos" ]; then
-  MACHDEP=md-68k
-  OSDEP=od-amiga
-  CFLAGS="$CFLAGS -DUNALIGNED_PROFITABLE -DREGPARAM=\"__attribute__((regparm(4)))\" -DM68K_FLAG_OPT=1"
-  CPUOBJS="cpufast1.o cpufast2.o cpufast3.o cpufast4.o cpufast5.o cpufast6.o cpufast7.o cpufast8.o"
-else if [ "x$TARGET" = "xamigaos" ]; then 
-    MACHDEP=md-generic
+else if [ "x$TARGET" = "xamigaos" ]; then
   OSDEP=od-amiga
-  CFLAGS="$CFLAGS -O -DREGPARAM="
-  CPUOBJS="cpuemu1.o cpuemu2.o cpuemu3.o cpuemu4.o cpuemu5.o cpuemu6.o cpuemu7.o cpuemu8.o"
+  CPU=`uname -m`
+  if [ "x$HAVEGCC27" = "xyes" -a "x$HAVE68K" = "xyes" ]; then
+    MACHDEP=md-68k
+    CFLAGS="$CFLAGS -DUNALIGNED_PROFITABLE -DREGPARAM=\"__attribute__((regparm(4)))\" -DM68K_FLAG_OPT=1"
+    CPUOBJS="cpufast1.o cpufast2.o cpufast3.o cpufast4.o cpufast5.o cpufast6.o cpufast7.o cpufast8.o"
+  else if [ "x$HAVEGCC27" = "xyes" -a "x$CPU" = "xppc" ]; then
+    MACHDEP=md-ppc-gcc
+  else
+        CFLAGS="$CFLAGS -O -DREGPARAM="
+    CPUOBJS="cpuemu1.o cpuemu2.o cpuemu3.o cpuemu4.o cpuemu5.o cpuemu6.o cpuemu7.o cpuemu8.o"
+  fi
+  fi
 else if [ "x$HAVEGCC27" = "xyes" -a "x$HAVE68K" = "xyes" -a "x$DO_PROFILING" = "xno" ]; then
     MACHDEP=md-68k
   CFLAGS="$CFLAGS -DM68K_FLAG_OPT=1 -DREGPARAM="
@@ -6086,7 +6087,6 @@
 fi
 fi
 fi
-fi
 
 if [ "x$TARGET" = "xwin32" ]; then
   OSDEP=od-win32
@@ -6144,12 +6144,6 @@
 
 echo $ac_n "checking which sound system to use""... $ac_c" 1>&6
 echo "configure:6147: checking which sound system to use" >&5
-# Check whether --enable-sound or --disable-sound was given.
-if test "${enable_sound+set}" = set; then
-  enableval="$enable_sound"
-  USE_SOUND=$enableval
-fi
-
 # Check whether --enable-file-sound or --disable-file-sound was given.
 if test "${enable_file_sound+set}" = set; then
   enableval="$enable_file_sound"
@@ -6158,67 +6152,60 @@
 
 
 if [ "x$USE_FILE_SOUND" = "xyes" ]; then
+  echo "$ac_t""file output" 1>&6
+  SOUNDDEP=sd-file
+  USE_SOUND=yes  
+else if [ "x$HAVE_USS_SOUND" = "xyes" ]; then
+  echo "$ac_t""USS" 1>&6
+  SOUNDDEP=sd-uss
   USE_SOUND=yes
-fi
-
-if [ "x$USE_SOUND" = "xno" ]; then
-  echo "$ac_t""sound not enabled" 1>&6
-else
-  if [ "x$USE_FILE_SOUND" = "xyes" ]; then
-    echo "$ac_t""file output" 1>&6
-    SOUNDDEP=sd-file
-    USE_SOUND=yes  
-  else if [ "x$HAVE_USS_SOUND" = "xyes" ]; then
-    echo "$ac_t""USS" 1>&6
-    SOUNDDEP=sd-uss
-    USE_SOUND=yes
-  else if [ "x$ac_cv_header_sys_audioio_h" = "xyes" -o "x$ac_cv_header_sun_audioio_h" = "xyes" ]; then
-    echo "$ac_t""Solaris/NetBSD" 1>&6
-    SOUNDDEP=sd-solaris
-    USE_SOUND=yes
-  else if [ "x$HAVE_AF_LIB" = "xyes" ]; then
-    echo "$ac_t""AF sound" 1>&6
-    SOUNDDEP=sd-af
-    LIBS="$LIBS -lAF"
-    USE_SOUND=yes
-  else if [ "x$HAVE_MME_LIB" = "xyes" ]; then
-    echo "$ac_t""MME sound" 1>&6
-    SOUNDDEP=sd-mme
-    LIBS="$LIBS -lmme"
-    USE_SOUND=yes
-  else if [ "x$TARGET" = "xp_os" ]; then
-    echo "$ac_t""pAudio.device" 1>&6
-    SOUNDDEP=od-pos
-    USE_SOUND=yes
-  else if [ "x$TARGET" = "xamigaos" ]; then
-    if [ "x$ac_cv_header_devices_ahi_h" = "xyes" ]; then
-       echo "$ac_t""Amiga AHI.device" 1>&6
-    else
-       echo "$ac_t""Amiga audio.device" 1>&6
-    fi
-    SOUNDDEP=od-amiga
-    USE_SOUND=yes
-  else if [ "x$TARGET" = "xbeos" ]; then
-    echo "$ac_t""BeOS sound" 1>&6
-    SOUNDDEP=od-beos
-    USE_SOUND=yes
-  else if [ "x$TARGET" = "xwin32" ]; then
-    echo "$ac_t""Win32 sound" 1>&6
-    SOUNDDEP=od-win32
-    USE_SOUND=yes
+else if [ "x$ac_cv_header_sys_audioio_h" = "xyes" -o "x$ac_cv_header_sun_audioio_h" = "xyes" ]; then
+  echo "$ac_t""Solaris/NetBSD" 1>&6
+  SOUNDDEP=sd-solaris
+  USE_SOUND=yes
+else if [ "x$HAVE_AF_LIB" = "xyes" ]; then
+  echo "$ac_t""AF sound" 1>&6
+  SOUNDDEP=sd-af
+  LIBS="$LIBS -lAF"
+  USE_SOUND=yes
+else if [ "x$HAVE_MME_LIB" = "xyes" ]; then
+  echo "$ac_t""MME sound" 1>&6
+  SOUNDDEP=sd-mme
+  LIBS="$LIBS -lmme"
+  USE_SOUND=yes
+else if [ "x$TARGET" = "xp_os" ]; then
+  echo "$ac_t""pAudio.device" 1>&6
+  SOUNDDEP=od-pos
+  USE_SOUND=yes
+else if [ "x$TARGET" = "xamigaos" ]; then
+  if [ "x$ac_cv_header_devices_ahi_h" = "xyes" ]; then
+    echo "$ac_t""Amiga AHI.device" 1>&6
   else
-    echo "no known sound system found"
-    NR_ERRORS=`expr $NR_ERRORS + 1`
-  fi
-  fi
-  fi
-  fi
-  fi
-  fi
-  fi
-  fi
+    echo "$ac_t""Amiga audio.device" 1>&6
   fi
+  SOUNDDEP=od-amiga
+  USE_SOUND=yes
+else if [ "x$TARGET" = "xbeos" ]; then
+  echo "$ac_t""BeOS sound" 1>&6
+  SOUNDDEP=od-beos
+  USE_SOUND=yes
+else if [ "x$TARGET" = "xwin32" ]; then
+  echo "$ac_t""Win32 sound" 1>&6
+  SOUNDDEP=od-win32
+  USE_SOUND=yes
+else
+  echo "no known sound system found"
+  NR_ERRORS=`expr $NR_ERRORS + 1`
+fi
+fi
+fi
+fi
 fi
+fi
+fi
+fi
+fi
+
 
 rm -f src/machdep
 rm -f src/osdep
@@ -6233,13 +6220,13 @@
 
 if [ "x$TARGET" = "xamigaos" -o "x$TARGET" = "xp_os" ]; then
     echo $ac_n "checking which CPU to use""... $ac_c" 1>&6
-echo "configure:6237: checking which CPU to use" >&5
+echo "configure:6224: checking which CPU to use" >&5
   cpu=`cpu | cut -d' ' -f2`
   echo "$ac_t""$cpu" 1>&6
   CFLAGS="$CFLAGS -m$cpu"
 
     echo $ac_n "checking which FPU to use""... $ac_c" 1>&6
-echo "configure:6243: checking which FPU to use" >&5
+echo "configure:6230: checking which FPU to use" >&5
   fpu=`cpu | cut -d' ' -f3 | grep '^688812$'`
   if [ "x$fpu" != "x" ]; then
         echo "$ac_t""68881" 1>&6
diff -r -u uae-0.8.5/configure.in uae-0.8.6/configure.in
--- uae-0.8.5/configure.in	Wed Jul  1 17:26:22 1998
+++ uae-0.8.6/configure.in	Sat Jul 18 13:14:42 1998
@@ -527,7 +527,6 @@
 
 USE_PENGUINS=no
 USE_THREADS=no
-USE_SOUND=no
 USE_FILE_SOUND=no
 
 USE_UNDERSCORE=dunno
@@ -612,7 +611,7 @@
 #ifdef __m68k__
   yes
 #endif
-], [AC_MSG_RESULT(yes); HAVEI386=yes], AC_MSG_RESULT(no))
+], [AC_MSG_RESULT(yes); HAVE68K=yes], AC_MSG_RESULT(no))
 
 if MACHINE=`uname -a 2>/dev/null`; then
   case "$MACHINE" in
@@ -757,7 +756,7 @@
   CPU=`uname -m`
   if [[ "x$CPU" = "xm68k" ]]; then
      MACHDEP=md-68k
-     CFLAGS="$CFLAGS -DREGPARAM=\"__attribute__((regparm(4)))\" -DM68K_FLAG_OPT=1"
+     CFLAGS="$CFLAGS -DUNALIGNED_PROFITABLE -DREGPARAM=\"__attribute__((regparm(4)))\" -DM68K_FLAG_OPT=1"
   else if [[ "x$CPU" = "xppc" ]]; then
      MACHDEP=md-ppc
      CFLAGS="$CFLAGS -DREGPARAM="
@@ -774,17 +773,21 @@
   CFLAGS="$CFLAGS -nostdinc -I/gg/include -I/p/../inc -D__POS__"
   OSDEP=od-pos
   CPUOBJS="cpufast.o"
-else if [[ "x$HAVEGCC27" = "xyes" -a "x$HAVE68K" = "xyes" -a "x$TARGET" = "xamigaos" ]]; then
-  MACHDEP=md-68k
-  OSDEP=od-amiga
-  CFLAGS="$CFLAGS -DUNALIGNED_PROFITABLE -DREGPARAM=\"__attribute__((regparm(4)))\" -DM68K_FLAG_OPT=1"
-  CPUOBJS="cpufast1.o cpufast2.o cpufast3.o cpufast4.o cpufast5.o cpufast6.o cpufast7.o cpufast8.o"
-else if [[ "x$TARGET" = "xamigaos" ]]; then 
-  dnl sam: amigaos without gcc
-  MACHDEP=md-generic
+else if [[ "x$TARGET" = "xamigaos" ]]; then
   OSDEP=od-amiga
-  CFLAGS="$CFLAGS -O -DREGPARAM="
-  CPUOBJS="cpuemu1.o cpuemu2.o cpuemu3.o cpuemu4.o cpuemu5.o cpuemu6.o cpuemu7.o cpuemu8.o"
+  CPU=`uname -m`
+  if [[ "x$HAVEGCC27" = "xyes" -a "x$HAVE68K" = "xyes" ]]; then
+    MACHDEP=md-68k
+    CFLAGS="$CFLAGS -DUNALIGNED_PROFITABLE -DREGPARAM=\"__attribute__((regparm(4)))\" -DM68K_FLAG_OPT=1"
+    CPUOBJS="cpufast1.o cpufast2.o cpufast3.o cpufast4.o cpufast5.o cpufast6.o cpufast7.o cpufast8.o"
+  else if [[ "x$HAVEGCC27" = "xyes" -a "x$CPU" = "xppc" ]]; then
+    MACHDEP=md-ppc-gcc
+  else
+    dnl sam: amigaos without gcc
+    CFLAGS="$CFLAGS -O -DREGPARAM="
+    CPUOBJS="cpuemu1.o cpuemu2.o cpuemu3.o cpuemu4.o cpuemu5.o cpuemu6.o cpuemu7.o cpuemu8.o"
+  fi
+  fi
 else if [[ "x$HAVEGCC27" = "xyes" -a "x$HAVE68K" = "xyes" -a "x$DO_PROFILING" = "xno" ]]; then
   dnl sam: This is for linux 68k (REGPARAM is not used under linux)
   MACHDEP=md-68k
@@ -802,7 +805,6 @@
 fi
 fi
 fi
-fi
 
 if [[ "x$TARGET" = "xwin32" ]]; then
   OSDEP=od-win32
@@ -846,71 +848,63 @@
 fi
 
 AC_MSG_CHECKING(which sound system to use)
-AC_ARG_ENABLE(sound,[  --enable-sound          Enable sound support],[USE_SOUND=$enableval],[])
 AC_ARG_ENABLE(file-sound,[  --enable-file-sound          Enable sound output to file],[USE_FILE_SOUND=$enableval],[])
 
 if [[ "x$USE_FILE_SOUND" = "xyes" ]]; then
+  AC_MSG_RESULT(file output)
+  SOUNDDEP=sd-file
+  USE_SOUND=yes  
+else if [[ "x$HAVE_USS_SOUND" = "xyes" ]]; then
+  AC_MSG_RESULT(USS)
+  SOUNDDEP=sd-uss
   USE_SOUND=yes
-fi
-
-if [[ "x$USE_SOUND" = "xno" ]]; then
-  AC_MSG_RESULT(sound not enabled)
-else
-  if [[ "x$USE_FILE_SOUND" = "xyes" ]]; then
-    AC_MSG_RESULT(file output)
-    SOUNDDEP=sd-file
-    USE_SOUND=yes  
-  else if [[ "x$HAVE_USS_SOUND" = "xyes" ]]; then
-    AC_MSG_RESULT(USS)
-    SOUNDDEP=sd-uss
-    USE_SOUND=yes
-  else if [[ "x$ac_cv_header_sys_audioio_h" = "xyes" -o "x$ac_cv_header_sun_audioio_h" = "xyes" ]]; then
-    AC_MSG_RESULT(Solaris/NetBSD)
-    SOUNDDEP=sd-solaris
-    USE_SOUND=yes
-  else if [[ "x$HAVE_AF_LIB" = "xyes" ]]; then
-    AC_MSG_RESULT(AF sound)
-    SOUNDDEP=sd-af
-    LIBS="$LIBS -lAF"
-    USE_SOUND=yes
-  else if [[ "x$HAVE_MME_LIB" = "xyes" ]]; then
-    AC_MSG_RESULT(MME sound)
-    SOUNDDEP=sd-mme
-    LIBS="$LIBS -lmme"
-    USE_SOUND=yes
-  else if [[ "x$TARGET" = "xp_os" ]]; then
-    AC_MSG_RESULT(pAudio.device)
-    SOUNDDEP=od-pos
-    USE_SOUND=yes
-  else if [[ "x$TARGET" = "xamigaos" ]]; then
-    if [[ "x$ac_cv_header_devices_ahi_h" = "xyes" ]]; then
-       AC_MSG_RESULT(Amiga AHI.device)
-    else
-       AC_MSG_RESULT(Amiga audio.device)
-    fi
-    SOUNDDEP=od-amiga
-    USE_SOUND=yes
-  else if [[ "x$TARGET" = "xbeos" ]]; then
-    AC_MSG_RESULT(BeOS sound)
-    SOUNDDEP=od-beos
-    USE_SOUND=yes
-  else if [[ "x$TARGET" = "xwin32" ]]; then
-    AC_MSG_RESULT(Win32 sound)
-    SOUNDDEP=od-win32
-    USE_SOUND=yes
+else if [[ "x$ac_cv_header_sys_audioio_h" = "xyes" -o "x$ac_cv_header_sun_audioio_h" = "xyes" ]]; then
+  AC_MSG_RESULT(Solaris/NetBSD)
+  SOUNDDEP=sd-solaris
+  USE_SOUND=yes
+else if [[ "x$HAVE_AF_LIB" = "xyes" ]]; then
+  AC_MSG_RESULT(AF sound)
+  SOUNDDEP=sd-af
+  LIBS="$LIBS -lAF"
+  USE_SOUND=yes
+else if [[ "x$HAVE_MME_LIB" = "xyes" ]]; then
+  AC_MSG_RESULT(MME sound)
+  SOUNDDEP=sd-mme
+  LIBS="$LIBS -lmme"
+  USE_SOUND=yes
+else if [[ "x$TARGET" = "xp_os" ]]; then
+  AC_MSG_RESULT(pAudio.device)
+  SOUNDDEP=od-pos
+  USE_SOUND=yes
+else if [[ "x$TARGET" = "xamigaos" ]]; then
+  if [[ "x$ac_cv_header_devices_ahi_h" = "xyes" ]]; then
+    AC_MSG_RESULT(Amiga AHI.device)
   else
-    echo "no known sound system found"
-    NR_ERRORS=`expr $NR_ERRORS + 1`
-  fi
-  fi
-  fi
-  fi
-  fi
-  fi
-  fi
-  fi
+    AC_MSG_RESULT(Amiga audio.device)
   fi
+  SOUNDDEP=od-amiga
+  USE_SOUND=yes
+else if [[ "x$TARGET" = "xbeos" ]]; then
+  AC_MSG_RESULT(BeOS sound)
+  SOUNDDEP=od-beos
+  USE_SOUND=yes
+else if [[ "x$TARGET" = "xwin32" ]]; then
+  AC_MSG_RESULT(Win32 sound)
+  SOUNDDEP=od-win32
+  USE_SOUND=yes
+else
+  echo "no known sound system found"
+  NR_ERRORS=`expr $NR_ERRORS + 1`
+fi
+fi
+fi
+fi
 fi
+fi
+fi
+fi
+fi
+
 
 rm -f src/machdep
 rm -f src/osdep
diff -r -u uae-0.8.5/docs/NEWS uae-0.8.6/docs/NEWS
--- uae-0.8.5/docs/NEWS	Thu Jul  2 20:56:19 1998
+++ uae-0.8.6/docs/NEWS	Sat Jul 18 13:14:42 1998
@@ -2,6 +2,13 @@
 more detailed description of changes between releases, read src/ChangeLog, and
 for the full picture, make a diff between releases.
 
+User-visible changes in 0.8.6:
+  - Black scanlines implemented ('D' modifier for "-O" option)
+  - Should no longer crash when resetting the emulation
+  - DOS port update
+  - Improvements in X11 and ncurses user interfaces.
+  - Sound can be re-configured at run-time in the UI.
+
 User-visible changes in 0.8.5:
   - Prettier gtk user interface
   - Swedish documentation by Jonas Holm Pileborg
diff -r -u uae-0.8.5/docs/README uae-0.8.6/docs/README
--- uae-0.8.5/docs/README	Tue Jun  9 19:51:02 1998
+++ uae-0.8.6/docs/README	Sat Jul 18 13:14:42 1998
@@ -1,4 +1,4 @@
-This is version 0.8.5 of UAE, the Un*x Amiga Emulator.
+This is version 0.8.6 of UAE, the Un*x Amiga Emulator.
 
 Versions numbered 0.8.x are beta versions, to be used for development only.
 If you are only a user of UAE, you are better off using the latest 0.7.x
diff -r -u uae-0.8.5/docs/README.PROGRAMMERS uae-0.8.6/docs/README.PROGRAMMERS
--- uae-0.8.5/docs/README.PROGRAMMERS	Mon May  4 19:08:00 1998
+++ uae-0.8.6/docs/README.PROGRAMMERS	Sat Jul 18 13:14:42 1998
@@ -106,6 +106,7 @@
 * Set up your editor so that tab characters round up to the next position
   where ((cursorx-1) % 8) == 0, i.e. 8 space tabs. Do not use 4 space tabs,
   that makes the code awful to read on other machines and worse to edit.
+  (I'm talking about the tab character here, not indentation!)
 * Lines can be up to 132 characters wide. Use SVGATextMode for the Linux
   console, or use a windowing system in a high resolution.
 * C++ comments are a no-no in C code.
@@ -291,6 +292,7 @@
 F0FF50: used by the EXTER interrupt which we set up for the filesystem.
 F0FF60: used by the uaectrl/uae-control programs (see uaelib.c)
 F0FF70: used by the task that gets set up for the mouse emulation.
+
 
 * How the compiler works
 
diff -r -u uae-0.8.5/src/ChangeLog uae-0.8.6/src/ChangeLog
--- uae-0.8.5/src/ChangeLog	Thu Jul  2 20:56:20 1998
+++ uae-0.8.6/src/ChangeLog	Sat Jul 18 13:14:42 1998
@@ -1,3 +1,25 @@
+980715 Change sd-uss/sound.c not to keep a file open in setup_sound, to
+       support reconfiguration.
+980713 Fix m68k detection in configure.in. Clear execbase after allocating
+       chipmem (Holger Jakob)
+       od-dos update, tui.c patches (Gustavo Goedert)
+       Get rid of --enable-sound, always enable sound.
+       Make svga.c compilable.
+980712 md-ppc-gcc patches (Holger Jakob)
+980707 gtk ui: Better CPU speed selection.
+       Move initializations from add_filesys_unit to set_filesys_unit.
+980706 AGA patches by Toni Wilen: Call calcdiw when changing fmode; fix
+       references to bplcon variables to go through dp_for_drawing; ifdef out
+       some code that's too hard to fix for now.
+       "Fix" the AGA color code. In pfield_linetoscr_aga, add lframe_end and
+       diw_end parameters and use them. Add some fill_line code for AGA. Make
+       sure no code touches acolors if [AGA_CHIPSET != 0]
+       New function finish_line_aga.
+980705 drawing.c/custom.c: Get rid of line_changed, replace with a single
+       variable thisline_changed. Pass it to hsync_record_line_state and
+       evaluate it there. Get rid of BORDER_PREV and BORDER_NEXT states;
+       add LINE_BLACK/LINE_REMEMBERED_AS_BLACK to implement scanlines option.
+       Remove code in pfield_draw_line that checks line_changed.
 980702 filesys.c: New function move_filesys_unit.
        Win32 GUI fixes.
 980701 gtk UI beautification and code cleanup (Michael Krause)
diff -r -u uae-0.8.5/src/audio.c uae-0.8.6/src/audio.c
--- uae-0.8.5/src/audio.c	Wed Jul  1 17:26:23 1998
+++ uae-0.8.6/src/audio.c	Sat Jul 18 13:14:42 1998
@@ -436,24 +436,26 @@
 	return;
 
     close_sound ();
+
     currprefs.produce_sound = changed_prefs.produce_sound;
     currprefs.stereo = changed_prefs.stereo;
     currprefs.sound_bits = changed_prefs.sound_bits;
 
-    if (currprefs.produce_sound >= 1) {
-	if (! init_sound ()) {
-	    if (currprefs.produce_sound == -1) {
-		fprintf (stderr, "Sound is not supported.\n");
-	    } else {
-		fprintf (stderr, "Sorry, can't initialize sound.\n");
-		currprefs.produce_sound = 0;
-	    }
-	} else {
-	    last_cycles = cycles - 1;
-	    next_sample_evtime = sample_evtime;
-	}
+    if (currprefs.produce_sound < 2)
+	return;
+
+    if (init_sound ()) {
+	last_cycles = cycles - 1;
+	next_sample_evtime = sample_evtime;
+	return;
+    }
+    if (! sound_available) {
+	fprintf (stderr, "Sound is not supported.\n");
     } else {
-	printf ("Sound system shut down.\n");
+	fprintf (stderr, "Sorry, can't initialize sound.\n");
+	currprefs.produce_sound = 0;
+	/* So we don't do this every frame */
+	changed_prefs.produce_sound = 0;
     }
 }
 
@@ -488,7 +490,7 @@
 	audio_channel[2].evtime -= best_evtime;
 	audio_channel[3].evtime -= best_evtime;
 	n_cycles -= best_evtime;
-	if (next_sample_evtime == 0) {
+	if (next_sample_evtime == 0 && currprefs.produce_sound > 1) {
 	    next_sample_evtime = sample_evtime;
 	    (*sample_handler) ();
 	}
diff -r -u uae-0.8.5/src/cia.c uae-0.8.6/src/cia.c
--- uae-0.8.5/src/cia.c	Tue Jun  9 19:51:06 1998
+++ uae-0.8.6/src/cia.c	Sat Jul 18 13:14:42 1998
@@ -308,7 +308,7 @@
 {
     unsigned int tmp;
 
-    switch(addr & 0xf){
+    switch(addr & 0xf) {
      case 0:
 	if (currprefs.use_serial && (serstat < 0)) /* Only read status when needed */
 	    serstat=serial_readstatus();		/* and only once per frame */
@@ -366,7 +366,7 @@
 {
     unsigned int tmp;
 
-    switch(addr & 0xf){
+    switch(addr & 0xf) {
      case 0:
 	if (currprefs.use_serial && serstat < 0) /* Only read status when needed */
 	    serstat=serial_readstatus();	 /* and only once per frame      */
@@ -416,7 +416,7 @@
 static void WriteCIAA(uae_u16 addr,uae_u8 val)
 {
     int oldled, oldovl;
-    switch(addr & 0xf){
+    switch(addr & 0xf) {
      case 0:
 	oldovl = ciaapra & 1;
 	oldled = ciaapra & 2;
@@ -501,7 +501,7 @@
 	CIA_calctimers();
 	break;
      case 8:
-	if (ciaacrb & 0x80){
+	if (ciaacrb & 0x80) {
 	    ciaaalarm = (ciaaalarm & ~0xff) | val;
 	} else {
 	    ciaatod = (ciaatod & ~0xff) | val;
@@ -509,7 +509,7 @@
 	}
 	break;
      case 9:
-	if (ciaacrb & 0x80){
+	if (ciaacrb & 0x80) {
 	    ciaaalarm = (ciaaalarm & ~0xff00) | (val << 8);
 	} else {
 	    ciaatod = (ciaatod & ~0xff00) | (val << 8);
@@ -517,7 +517,7 @@
 	}
 	break;
      case 10:
-	if (ciaacrb & 0x80){
+	if (ciaacrb & 0x80) {
 	    ciaaalarm = (ciaaalarm & ~0xff0000) | (val << 16);
 	} else {
 	    ciaatod = (ciaatod & ~0xff0000) | (val << 16);
@@ -531,7 +531,7 @@
      case 14:
 	CIA_update();
 	ciaacra = val;
-	if (ciaacra & 0x10){
+	if (ciaacra & 0x10) {
 	    ciaacra &= ~0x10;
 	    ciaata = ciaala;
 	}
@@ -543,7 +543,7 @@
      case 15:
 	CIA_update();
 	ciaacrb = val;
-	if (ciaacrb & 0x10){
+	if (ciaacrb & 0x10) {
 	    ciaacrb &= ~0x10;
 	    ciaatb = ciaalb;
 	}
@@ -555,7 +555,7 @@
 static void WriteCIAB(uae_u16 addr,uae_u8 val)
 {
     int oldval;
-    switch(addr & 0xf){
+    switch(addr & 0xf) {
      case 0:
 	if (currprefs.use_serial) {
 	  oldval = ciabpra;
@@ -602,7 +602,7 @@
 	CIA_calctimers();
 	break;
      case 8:
-	if (ciabcrb & 0x80){
+	if (ciabcrb & 0x80) {
 	    ciabalarm = (ciabalarm & ~0xff) | val;
 	} else {
 	    ciabtod = (ciabtod & ~0xff) | val;
@@ -610,7 +610,7 @@
 	}
 	break;
      case 9:
-	if (ciabcrb & 0x80){
+	if (ciabcrb & 0x80) {
 	    ciabalarm = (ciabalarm & ~0xff00) | (val << 8);
 	} else {
 	    ciabtod = (ciabtod & ~0xff00) | (val << 8);
@@ -618,7 +618,7 @@
 	}
 	break;
      case 10:
-	if (ciabcrb & 0x80){
+	if (ciabcrb & 0x80) {
 	    ciabalarm = (ciabalarm & ~0xff0000) | (val << 16);
 	} else {
 	    ciabtod = (ciabtod & ~0xff0000) | (val << 16);
@@ -634,7 +634,7 @@
      case 14:
 	CIA_update();
 	ciabcra = val;
-	if (ciabcra & 0x10){
+	if (ciabcra & 0x10) {
 	    ciabcra &= ~0x10;
 	    ciabta = ciabla;
 	}
@@ -643,7 +643,7 @@
      case 15:
 	CIA_update();
 	ciabcrb = val;
-	if (ciabcrb & 0x10){
+	if (ciabcrb & 0x10) {
 	    ciabcrb &= ~0x10;
 	    ciabtb = ciablb;
 	}
diff -r -u uae-0.8.5/src/custom.c uae-0.8.6/src/custom.c
--- uae-0.8.5/src/custom.c	Fri Jun 12 15:52:54 1998
+++ uae-0.8.6/src/custom.c	Sat Jul 18 13:14:42 1998
@@ -204,12 +204,13 @@
  * have to be remembered. */
 static int decided_bpl1mod, decided_bpl2mod, decided_nr_planes, decided_hires;
 
-char line_changed[2 * (maxvpos+1)];
+static char thisline_changed;
+
 
 #ifdef SMART_UPDATE
-#define MARK_LINE_CHANGED(l) do { line_changed[l] = 1; } while (0)
+#define MARK_LINE_CHANGED do { thisline_changed = 1; } while (0)
 #else
-#define MARK_LINE_CHANGED(l) do { } while (0)
+#define MARK_LINE_CHANGED do { ; } while (0)
 #endif
 
 static struct decision thisline_decision;
@@ -341,13 +342,11 @@
 	    color_src_match = oldctable;
 	    color_dest_match = remembered_color_entry;
 	}
-	if (changed) {
-	    line_changed[next_lineno] = 1;
-	}
+	thisline_changed |= changed;
     } else {
 	/* We know the result of the comparison */
 	if (color_compare_result)
-	    line_changed[next_lineno] = 1;
+	    thisline_changed = 1;
     }
 }
 
@@ -370,7 +369,7 @@
 	 * some programs change them after DDF start but before DIW start. */
 	thisline_decision.bplcon1 = bplcon1;
 	if (thisline_decision.diwfirstword != line_decisions[next_lineno].diwfirstword)
-	    MARK_LINE_CHANGED (next_lineno);
+	    MARK_LINE_CHANGED;
 	thisline_decision.diwlastword = -1;
     }
     if (hdiwstate == DIW_waiting_stop && thisline_decision.diwlastword == -1
@@ -379,7 +378,7 @@
 	thisline_decision.diwlastword = diwlastword;
 	hdiwstate = DIW_waiting_start;
 	if (thisline_decision.diwlastword != line_decisions[next_lineno].diwlastword)
-	    MARK_LINE_CHANGED (next_lineno);
+	    MARK_LINE_CHANGED;
     }
 }
 
@@ -414,7 +413,7 @@
 #endif
 	)
 #endif /* SMART_UPDATE */
-	line_changed[next_lineno] = 1;
+	thisline_changed = 1;
 }
 
 /* Called when we already decided whether the line is playfield or border,
@@ -513,7 +512,7 @@
 	thisline_decision.bplcon0 &= 0xFFF;
 	thisline_decision.bplcon0 |= bplcon0 & 0xF000;
 	adjust_broken_program (hpos);
-	MARK_LINE_CHANGED (next_lineno); /* Play safe. */
+	MARK_LINE_CHANGED; /* Play safe. */
 	return;
     }
     
@@ -535,7 +534,7 @@
     thisline_decision.bplcon0 &= 0xFFF;
     thisline_decision.bplcon0 |= bplcon0 & 0xF000;
 
-    MARK_LINE_CHANGED (next_lineno); /* Play safe. */
+    MARK_LINE_CHANGED; /* Play safe. */
     decide_as_playfield (plfstrt, plflinelen);
     adjust_broken_program (hpos);
 }
@@ -642,7 +641,7 @@
     if (regno == 0 && thisline_decision.color0 == 0xFFFFFFFFul && thisline_decision.diwfirstword < 0) {
 	thisline_decision.color0 = current_colors.color_regs[0];
 	if (line_decisions[next_lineno].color0 != value)
-	    line_changed[next_lineno] = 1;
+	    thisline_changed = 1;
     }
     /* Anything else gets recorded in the color_changes table. */
 #ifdef OS_WITHOUT_MEMORY_MANAGEMENT
@@ -726,11 +725,11 @@
 		real_ptr = pfield_xlateptr(0, 0);
 #ifdef SMART_UPDATE
 #if 1
-	    if (line_changed[next_lineno])
+	    if (thisline_changed)
 		memcpy (dataptr, real_ptr, bytecount);
 	    else
 #endif
-		line_changed[next_lineno] |= memcmpy (dataptr, real_ptr, bytecount);
+		thisline_changed |= memcmpy (dataptr, real_ptr, bytecount);
 #else
 	    real_bplpt[i] = real_ptr;
 #endif
@@ -746,8 +745,8 @@
 	    if (real_ptr == NULL)
 		real_ptr = pfield_xlateptr(0, 0);
 #ifdef SMART_UPDATE
-	    if (!line_changed[next_lineno])
-		line_changed[next_lineno] |= memcmpy (dataptr, real_ptr, bytecount);
+	    if (!thisline_changed)
+		thisline_changed |= memcmpy (dataptr, real_ptr, bytecount);
 	    else
 		memcpy (dataptr, real_ptr, bytecount);
 #else
@@ -924,17 +923,17 @@
     if (hdiwstate == DIW_waiting_stop) {
 	thisline_decision.diwlastword = max_diwlastword;
 	if (thisline_decision.diwlastword != line_decisions[next_lineno].diwlastword)
-	    MARK_LINE_CHANGED (next_lineno);
+	    MARK_LINE_CHANGED;
     }
 
     if (line_decisions[next_lineno].which != thisline_decision.which)
-	line_changed[next_lineno] = 1;
+	thisline_changed = 1;
     decide_plane (hpos);
 
     dip = curr_drawinfo + next_lineno;
     dip_old = prev_drawinfo + next_lineno;
     dp = line_decisions + next_lineno;
-    changed = line_changed[next_lineno];
+    changed = thisline_changed;
 
     if (thisline_decision.which == 1) {
 	record_diw_line (diwfirstword, diwlastword);
@@ -979,7 +978,7 @@
 	changed = 1;
 
     if (changed) {
-	line_changed[next_lineno] = 1;
+	thisline_changed = 1;
 	*dp = thisline_decision;
     } else
 	/* The only one that may differ: */
@@ -1002,12 +1001,12 @@
     if (hdiwstate == DIW_waiting_stop) {
 	thisline_decision.diwfirstword = PIXEL_XPOS (DISPLAY_LEFT_SHIFT/2);
 	if (thisline_decision.diwfirstword != line_decisions[next_lineno].diwfirstword)
-	    MARK_LINE_CHANGED (next_lineno);
+	    MARK_LINE_CHANGED;
     }
     thisline_decision.ctable = -1;
     thisline_decision.color0 = 0xFFFFFFFFul;
 
-    line_changed[next_lineno] = 0;
+    thisline_changed = 0;
     curr_drawinfo[next_lineno].first_color_change = next_color_change;
     curr_drawinfo[next_lineno].first_delay_change = next_delay_change;
     curr_drawinfo[next_lineno].first_sprite_draw = next_sprite_draw;
@@ -1649,7 +1648,7 @@
     if (!blt_info.vblitsize) blt_info.vblitsize = 32768;
     if (!blt_info.hblitsize) blt_info.hblitsize = 0x800;
     bltstate = BLT_init;
-    do_blitter();
+    do_blitter ();
 }
 
 static __inline__ void SPRxCTL_1 (uae_u16 v, int num)
@@ -1738,9 +1737,9 @@
 	r = (v & 0xF00) >> 8;
 	g = (v & 0xF0) >> 4;
 	b = (v & 0xF) >> 0;
-	cr = color_regs[colreg] >> 16;
-	cg = (color_regs[colreg] >> 8) & 0xFF;
-	cb = color_regs[colreg] & 0xFF;
+	cr = current_colors.color_regs[colreg] >> 16;
+	cg = (current_colors.color_regs[colreg] >> 8) & 0xFF;
+	cb = current_colors.color_regs[colreg] & 0xFF;
 
 	if (bplcon3 & 0x200) {
 	    cr &= 0xF0; cr |= r;
@@ -1752,10 +1751,14 @@
 	    cb = b + (b << 4);
 	}
 	cval = (cr << 16) | (cg << 8) | cb;
-	if (cval == color_regs[colreg])
+	if (cval == current_colors.color_regs[colreg])
 	    return;
-	color_regs[colreg] = cval;
-	pfield_may_need_update(1);
+
+	/* Call this with the old table still intact. */
+	record_color_change (hpos, colreg, v);
+	remembered_color_entry = -1;
+	current_colors.color_regs[colreg] = cval;
+/*	current_colors.acolors[colreg] = xcolors[v];*/
     }
 #else
     {
@@ -2608,7 +2611,7 @@
     finish_decisions ();
     do_modulos (current_hpos ());
 
-    hsync_record_line_state (next_lineno, nextline_how);
+    hsync_record_line_state (next_lineno, nextline_how, thisline_changed);
 
     eventtab[ev_hsync].evtime += cycles - eventtab[ev_hsync].oldcycles;
     eventtab[ev_hsync].oldcycles = cycles;
@@ -2656,7 +2659,7 @@
 	nextline_how = nln_normal;
 	if (currprefs.gfx_linedbl) {
 	    lineno *= 2;
-	    nextline_how = nln_doubled;
+	    nextline_how = currprefs.gfx_linedbl == 1 ? nln_doubled : nln_nblack;
 	    if (bplcon0 & 4) {
 		if (!lof) {
 		    lineno++;
@@ -3059,7 +3062,7 @@
 #endif
 #if AGA_CHIPSET == 1
      case 0x10C: BPLCON4 (hpos, value); break;
-     case 0x1FC: fmode = value; break;
+     case 0x1FC: fmode = value; calcdiw (); break;
 #endif
     }
 }
diff -r -u uae-0.8.5/src/drawing.c uae-0.8.6/src/drawing.c
--- uae-0.8.5/src/drawing.c	Sun Jun 14 21:15:31 1998
+++ uae-0.8.6/src/drawing.c	Sat Jul 18 13:14:42 1998
@@ -88,8 +88,8 @@
 #define LINE_DECIDED 2
 #define LINE_DECIDED_DOUBLE 3
 #define LINE_AS_PREVIOUS 4
-#define LINE_BORDER_NEXT 5
-#define LINE_BORDER_PREV 6
+#define LINE_BLACK 5
+#define LINE_REMEMBERED_AS_BLACK 6
 #define LINE_DONE 7
 #define LINE_DONE_AS_PREVIOUS 8
 #define LINE_REMEMBERED_AS_PREVIOUS 9
@@ -256,35 +256,38 @@
 }
 #endif
 
+static int linetoscr_double_offset;
+
 #if AGA_CHIPSET != 0
 /* WARNING: Not too much of this will work correctly yet. */
 
-static void pfield_linetoscr_aga(int pix, int stoppos)
+static void pfield_linetoscr_aga (int pix, int lframe_end, int diw_end, int stoppos)
 {
     uae_u32 *buf = aga_lbufptr;
     int i;
-    int xor = (uae_u8)(bplcon4 >> 8);
-    int oldpix = pix; \
+    int xor = (uae_u8)(dp_for_drawing->bplcon4 >> 8);
+    int oldpix = pix;
 
-    buf -= pix; \
+    buf -= pix;
 
     for (i = 0; i < stoppos; i++)
 	pixdata.apixels[i] ^= xor;
 
-    while (pix < dp_for_drawing->diwfirstword && pix < stoppos) {
+    while (pix < lframe_end) {
 	buf[pix++] = colors_for_drawing.color_regs[0];
     }
     if (bplham) {
-	while (pix < dp_for_drawing->diwlastword && pix < stoppos) {
+	while (pix < diw_end) {
 	    uae_u32 d = ham_linebuf[pix];
 	    buf[pix] = d;
 	    pix++;
 	}
     } else if (bpldualpf) {
+#if 0 /* FIXME */
 	/* Dual playfield */
 	int *lookup = bpldualpfpri ? dblpf_aga2 : dblpf_aga1;
 	int *lookup_no = bpldualpfpri ? dblpf_2nd2 : dblpf_2nd1;
-	while (pix < dp_for_drawing->diwlastword && pix < stoppos) {
+	while (pix < diw_end) {
 	    int pixcol = pixdata.apixels[pix];
 	    int pfno = lookup_no[pixcol];
 
@@ -293,13 +296,14 @@
 	    } else {
 		int val = lookup[pixdata.apixels[pix]];
 		if (pfno == 2)
-		    val += dblpfofs[(bplcon2 >> 10) & 7];
+		    val += dblpfofs[(dp_for_drawing->bplcon2 >> 10) & 7];
 		buf[pix] = colors_for_drawing.color_regs[val];
 	    }
 	    pix++;
 	}
+#endif
     } else if (bplehb) {
-	while (pix < dp_for_drawing->diwlastword && pix < stoppos) {
+	while (pix < diw_end) {
 	    int pixcol = pixdata.apixels[pix];
 	    uae_u32 d = colors_for_drawing.color_regs[pixcol];
 	    /* What about sprites? */
@@ -309,7 +313,7 @@
 	    pix++;
 	}
     } else {
-	while (pix < dp_for_drawing->diwlastword && pix < stoppos) {
+	while (pix < diw_end) {
 	    int pixcol = pixdata.apixels[pix];
 	    buf[pix] = colors_for_drawing.color_regs[pixcol];
 	    pix++;
@@ -321,12 +325,13 @@
     aga_lbufptr += pix - oldpix;
 }
 
-static void aga_translate32(int start, int stop)
+static void aga_translate32 (int start, int stop)
 {
-    memcpy (((uae_u32 *)xlinebuffer) + start, aga_linebuf + start, 4*(stop-start));
+    memcpy (((uae_u32 *)xlinebuffer) + start, aga_lbufptr, 4*(stop-start));
+    aga_lbufptr += stop - start;
 }
 
-static void aga_translate16(int start, int stop)
+static void aga_translate16 (int start, int stop)
 {
     int i;
     for (i = start; i < stop; i++) {
@@ -336,7 +341,7 @@
     }
 }
 
-static void aga_translate8(int start, int stop)
+static void aga_translate8 (int start, int stop)
 {
     int i;
     for (i = start; i < stop; i++) {
@@ -345,9 +350,21 @@
 	((uae_u8 *)xlinebuffer)[i] = xcolors[v];
     }
 }
-#endif
 
-static int linetoscr_double_offset;
+static void aga_fill_line_32 (char *buf, int start, int stop)
+{
+    int i;
+    for (i = start; i < stop; i++) {
+	((uae_u32 *)buf)[i] = colors_for_drawing.color_regs[0];
+    }
+}
+
+static void fill_line (void)
+{
+    aga_fill_line_32 (xlinebuffer, linetoscr_x_adjust, linetoscr_x_adjust + gfxvidinfo.width);
+}
+
+#else /* no AGA_CHIPSET */
 
 #define LINE_TO_SCR(NAME, TYPE, DO_DOUBLE, CONVERT) \
 static void NAME(int pix, int lframe_end, int diw_end, int stoppos) \
@@ -405,7 +422,7 @@
 }
 
 #define FILL_LINE(NAME, TYPE, CONVERT) \
-static void NAME(char *buf, int start, int stop) \
+static void NAME (char *buf, int start, int stop) \
 { \
     TYPE *b = (TYPE *)buf; \
     int i;\
@@ -445,10 +462,10 @@
 static __inline__ void fill_line_full (void)
 {
     switch (gfxvidinfo.pixbytes) {
-     case 1: fill_line_8(xlinebuffer, linetoscr_x_adjust, linetoscr_x_adjust + gfxvidinfo.width); break;
-     case 2: fill_line_16(xlinebuffer, linetoscr_x_adjust, linetoscr_x_adjust + gfxvidinfo.width); break;
-     case 3: fill_line_24(xlinebuffer, linetoscr_x_adjust, linetoscr_x_adjust + gfxvidinfo.width); break;
-     case 4: fill_line_32(xlinebuffer, linetoscr_x_adjust, linetoscr_x_adjust + gfxvidinfo.width); break;
+     case 1: fill_line_8 (xlinebuffer, linetoscr_x_adjust, linetoscr_x_adjust + gfxvidinfo.width); break;
+     case 2: fill_line_16 (xlinebuffer, linetoscr_x_adjust, linetoscr_x_adjust + gfxvidinfo.width); break;
+     case 3: fill_line_24 (xlinebuffer, linetoscr_x_adjust, linetoscr_x_adjust + gfxvidinfo.width); break;
+     case 4: fill_line_32 (xlinebuffer, linetoscr_x_adjust, linetoscr_x_adjust + gfxvidinfo.width); break;
     }
 }
 
@@ -524,16 +541,16 @@
 
 #undef pfield_linetoscr_full8
 /* The types are lies, of course. */
-extern void pfield_linetoscr_normal_asm8(void) __asm__("pfield_linetoscr_normal_asm8");
-extern void pfield_linetoscr_ehb_asm8(void) __asm__("pfield_linetoscr_ehb_asm8");
-extern void pfield_linetoscr_ham6_asm8(void) __asm__("pfield_linetoscr_ham6_asm8");
-extern void pfield_linetoscr_dualpf_asm8(void) __asm__("pfield_linetoscr_dualpf_asm8");
-extern void pfield_linetoscr_hdouble_asm8(void) __asm__("pfield_linetoscr_hdouble_asm8");
-extern void pfield_linetoscr_hdouble_dpf_asm8(void) __asm__("pfield_linetoscr_hdouble_dpf_asm8");
-extern void pfield_linetoscr_hdouble_ehb_asm8(void) __asm__("pfield_linetoscr_hdouble_ehb_asm8");
-extern void pfield_linetoscr_asm8(void (*)(void), int, int, int, int, ...) __asm__("pfield_linetoscr_asm8");
+extern void pfield_linetoscr_normal_asm8 (void) __asm__("pfield_linetoscr_normal_asm8");
+extern void pfield_linetoscr_ehb_asm8 (void) __asm__("pfield_linetoscr_ehb_asm8");
+extern void pfield_linetoscr_ham6_asm8 (void) __asm__("pfield_linetoscr_ham6_asm8");
+extern void pfield_linetoscr_dualpf_asm8 (void) __asm__("pfield_linetoscr_dualpf_asm8");
+extern void pfield_linetoscr_hdouble_asm8 (void) __asm__("pfield_linetoscr_hdouble_asm8");
+extern void pfield_linetoscr_hdouble_dpf_asm8 (void) __asm__("pfield_linetoscr_hdouble_dpf_asm8");
+extern void pfield_linetoscr_hdouble_ehb_asm8 (void) __asm__("pfield_linetoscr_hdouble_ehb_asm8");
+extern void pfield_linetoscr_asm8 (void (*) (void), int, int, int, int, ...) __asm__("pfield_linetoscr_asm8");
 
-static void pfield_linetoscr_full8(int pix, int lframe_end, int diw_end, int stoppos)
+static void pfield_linetoscr_full8 (int pix, int lframe_end, int diw_end, int stoppos)
 {
     int lframe_end_1, diw_end_1;
 
@@ -541,30 +558,30 @@
     diw_end_1 = stoppos - ((stoppos - diw_end) & ~3);
 
     if (bplham && bplplanecnt == 6) {
-	pfield_linetoscr_asm8(pfield_linetoscr_ham6_asm8, pix, lframe_end_1, diw_end_1, stoppos);
+	pfield_linetoscr_asm8 (pfield_linetoscr_ham6_asm8, pix, lframe_end_1, diw_end_1, stoppos);
     } else if (bpldualpf) {
 #ifdef LORES_HACK
 	if (currprefs.gfx_lores == 2)
-	    pfield_linetoscr_asm8(pfield_linetoscr_hdouble_dpf_asm8, pix, lframe_end_1, diw_end_1, stoppos,
+	    pfield_linetoscr_asm8 (pfield_linetoscr_hdouble_dpf_asm8, pix, lframe_end_1, diw_end_1, stoppos,
 				   bpldualpfpri ? dblpf_ind2 : dblpf_ind1);
 	else
 #endif
-	    pfield_linetoscr_asm8(pfield_linetoscr_dualpf_asm8, pix, lframe_end_1, diw_end_1, stoppos,
+	    pfield_linetoscr_asm8 (pfield_linetoscr_dualpf_asm8, pix, lframe_end_1, diw_end_1, stoppos,
 				  bpldualpfpri ? dblpf_ind2 : dblpf_ind1);
     } else if (bplehb) {
 #ifdef LORES_HACK
 	if (currprefs.gfx_lores == 2)
-	    pfield_linetoscr_asm8(pfield_linetoscr_hdouble_ehb_asm8, pix, lframe_end_1, diw_end_1, stoppos);
+	    pfield_linetoscr_asm8 (pfield_linetoscr_hdouble_ehb_asm8, pix, lframe_end_1, diw_end_1, stoppos);
 	else
 #endif
-	    pfield_linetoscr_asm8(pfield_linetoscr_ehb_asm8, pix, lframe_end_1, diw_end_1, stoppos);
+	    pfield_linetoscr_asm8 (pfield_linetoscr_ehb_asm8, pix, lframe_end_1, diw_end_1, stoppos);
     } else {
 #ifdef LORES_HACK
 	if (currprefs.gfx_lores == 2)
-	    pfield_linetoscr_asm8(pfield_linetoscr_hdouble_asm8, pix, lframe_end_1, diw_end_1, stoppos);
+	    pfield_linetoscr_asm8 (pfield_linetoscr_hdouble_asm8, pix, lframe_end_1, diw_end_1, stoppos);
 	else
 #endif
-	    pfield_linetoscr_asm8(pfield_linetoscr_normal_asm8, pix, lframe_end_1, diw_end_1, stoppos);
+	    pfield_linetoscr_asm8 (pfield_linetoscr_normal_asm8, pix, lframe_end_1, diw_end_1, stoppos);
     }
 
     /* The assembly functions work on aligned data, so we may have to do some
@@ -582,16 +599,16 @@
 }
 
 #undef pfield_linetoscr_full16
-extern void pfield_linetoscr_normal_asm16(void) __asm__("pfield_linetoscr_normal_asm16");
-extern void pfield_linetoscr_ehb_asm16(void) __asm__("pfield_linetoscr_ehb_asm16");
-extern void pfield_linetoscr_ham6_asm16(void) __asm__("pfield_linetoscr_ham6_asm16");
-extern void pfield_linetoscr_dualpf_asm16(void) __asm__("pfield_linetoscr_dualpf_asm16");
-extern void pfield_linetoscr_hdouble_asm16(void) __asm__("pfield_linetoscr_hdouble_asm16");
-extern void pfield_linetoscr_hdouble_dpf_asm16(void) __asm__("pfield_linetoscr_hdouble_dpf_asm16");
-extern void pfield_linetoscr_hdouble_ehb_asm16(void) __asm__("pfield_linetoscr_hdouble_ehb_asm16");
-extern void pfield_linetoscr_asm16(void (*)(void), int, int, int, int, ...) __asm__("pfield_linetoscr_asm16");
+extern void pfield_linetoscr_normal_asm16 (void) __asm__("pfield_linetoscr_normal_asm16");
+extern void pfield_linetoscr_ehb_asm16 (void) __asm__("pfield_linetoscr_ehb_asm16");
+extern void pfield_linetoscr_ham6_asm16 (void) __asm__("pfield_linetoscr_ham6_asm16");
+extern void pfield_linetoscr_dualpf_asm16 (void) __asm__("pfield_linetoscr_dualpf_asm16");
+extern void pfield_linetoscr_hdouble_asm16 (void) __asm__("pfield_linetoscr_hdouble_asm16");
+extern void pfield_linetoscr_hdouble_dpf_asm16 (void) __asm__("pfield_linetoscr_hdouble_dpf_asm16");
+extern void pfield_linetoscr_hdouble_ehb_asm16 (void) __asm__("pfield_linetoscr_hdouble_ehb_asm16");
+extern void pfield_linetoscr_asm16 (void (*) (void), int, int, int, int, ...) __asm__("pfield_linetoscr_asm16");
 
-static void pfield_linetoscr_full16(int pix, int lframe_end, int diw_end, int stoppos)
+static void pfield_linetoscr_full16 (int pix, int lframe_end, int diw_end, int stoppos)
 {
     int lframe_end_1, diw_end_1;
 
@@ -599,30 +616,30 @@
     diw_end_1 = stoppos - ((stoppos - diw_end) & ~3);
 
     if (bplham && bplplanecnt == 6) {
-	pfield_linetoscr_asm16(pfield_linetoscr_ham6_asm16, pix, lframe_end_1, diw_end_1, stoppos);
+	pfield_linetoscr_asm16 (pfield_linetoscr_ham6_asm16, pix, lframe_end_1, diw_end_1, stoppos);
     } else if (bpldualpf) {
 #ifdef LORES_HACK
 	if (currprefs.gfx_lores == 2)
-	    pfield_linetoscr_asm16(pfield_linetoscr_hdouble_dpf_asm16, pix, lframe_end_1, diw_end_1, stoppos,
+	    pfield_linetoscr_asm16 (pfield_linetoscr_hdouble_dpf_asm16, pix, lframe_end_1, diw_end_1, stoppos,
 				   bpldualpfpri ? dblpf_ind2 : dblpf_ind1);
 	else
 #endif
-	    pfield_linetoscr_asm16(pfield_linetoscr_dualpf_asm16, pix, lframe_end_1, diw_end_1, stoppos,
+	    pfield_linetoscr_asm16 (pfield_linetoscr_dualpf_asm16, pix, lframe_end_1, diw_end_1, stoppos,
 				   bpldualpfpri ? dblpf_ind2 : dblpf_ind1);
     } else if (bplehb) {
 #ifdef LORES_HACK
 	if (currprefs.gfx_lores == 2)
-	    pfield_linetoscr_asm16(pfield_linetoscr_hdouble_ehb_asm16, pix, lframe_end_1, diw_end_1, stoppos);
+	    pfield_linetoscr_asm16 (pfield_linetoscr_hdouble_ehb_asm16, pix, lframe_end_1, diw_end_1, stoppos);
 	else
 #endif
-	    pfield_linetoscr_asm16(pfield_linetoscr_ehb_asm16, pix, lframe_end_1, diw_end_1, stoppos);
+	    pfield_linetoscr_asm16 (pfield_linetoscr_ehb_asm16, pix, lframe_end_1, diw_end_1, stoppos);
     } else {
 #ifdef LORES_HACK
 	if (currprefs.gfx_lores == 2)
-	    pfield_linetoscr_asm16(pfield_linetoscr_hdouble_asm16, pix, lframe_end_1, diw_end_1, stoppos);
+	    pfield_linetoscr_asm16 (pfield_linetoscr_hdouble_asm16, pix, lframe_end_1, diw_end_1, stoppos);
 	else
 #endif
-	    pfield_linetoscr_asm16(pfield_linetoscr_normal_asm16, pix, lframe_end_1, diw_end_1, stoppos);
+	    pfield_linetoscr_asm16 (pfield_linetoscr_normal_asm16, pix, lframe_end_1, diw_end_1, stoppos);
     }
 
     /* The assembly functions work on aligned data, so we may have to do some
@@ -649,22 +666,24 @@
 #ifdef NO_DOUBLING_LINETOSCR
 #undef pfield_linetoscr_full8_double
 #undef pfield_linetoscr_full16_double
-static void pfield_linetoscr_full8_double(int start, int lframe_end, int diw_end, int stop)
+static void pfield_linetoscr_full8_double (int start, int lframe_end, int diw_end, int stop)
 {
     char *oldxlb = (char *)xlinebuffer;
-    pfield_linetoscr_full8(start, lframe_end, diw_end, stop);
+    pfield_linetoscr_full8 (start, lframe_end, diw_end, stop);
     xlinebuffer = oldxlb + linetoscr_double_offset;
-    pfield_linetoscr_full8(start, lframe_end, diw_end, stop);
+    pfield_linetoscr_full8 (start, lframe_end, diw_end, stop);
 }
-static void pfield_linetoscr_full16_double(int start, int lframe_end, int diw_end, int stop)
+static void pfield_linetoscr_full16_double (int start, int lframe_end, int diw_end, int stop)
 {
     char *oldxlb = (char *)xlinebuffer;
-    pfield_linetoscr_full16(start, lframe_end, diw_end, stop);
+    pfield_linetoscr_full16 (start, lframe_end, diw_end, stop);
     xlinebuffer = oldxlb + linetoscr_double_offset;
-    pfield_linetoscr_full16(start, lframe_end, diw_end, stop);
+    pfield_linetoscr_full16 (start, lframe_end, diw_end, stop);
 }
 #endif
 
+#endif /* no AGA_CHIPSET */
+
 static int linetoscr_diw_end, linetoscr_diw_start;
 
 /* Initialize the variables necessary for drawing a line.
@@ -780,11 +799,11 @@
 	}
     }
 #else
-    pfield_linetoscr_aga(start, lframe_end, diw_end, stop);
+    pfield_linetoscr_aga (start, lframe_end, diw_end, stop);
 #endif
 }
 
-static void pfield_do_fill_line(int start, int stop)
+static void pfield_do_fill_line (int start, int stop)
 {
     if (stop > linetoscr_right_x)
 	stop = linetoscr_right_x;
@@ -794,15 +813,20 @@
     if (start >= stop)
 	return;
 
+#if AGA_CHIPSET == 0
     switch (gfxvidinfo.pixbytes) {
      case 1: fill_line_8 (xlinebuffer, start, stop); break;
      case 2: fill_line_16 (xlinebuffer, start, stop); break;
      case 3: fill_line_24 (xlinebuffer, start, stop); break;
      case 4: fill_line_32 (xlinebuffer, start, stop); break;
     }
+#else
+    aga_fill_line_32 (xlinebuffer, start, stop);
+    /* FIXME */
+#endif
 }
 
-static void pfield_do_linetoscr_full(int double_line)
+static void pfield_do_linetoscr_full (int double_line)
 {
     int start = linetoscr_x_adjust, stop = start + gfxvidinfo.width;
     int lframe_end = linetoscr_diw_start, diw_end = linetoscr_diw_end;
@@ -827,11 +851,11 @@
 	 case 4: pfield_linetoscr_full32 (start, lframe_end, diw_end, stop); break;
 	}
 #else
-    pfield_linetoscr_aga(start, lframe_end, diw_end, stop);
+    pfield_linetoscr_aga (start, lframe_end, diw_end, stop);
 #endif
 }
 
-static void gen_pfield_tables(void)
+static void gen_pfield_tables (void)
 {
     int i;
     union {
@@ -1768,11 +1792,20 @@
 	flush_screen (start, stop);
 }
 
+static __inline__ void finish_line_aga (void)
+{
+#if AGA_CHIPSET != 0
+    aga_lbufptr = aga_linebuf;
+    aga_translate32 (linetoscr_x_adjust_bytes, linetoscr_x_adjust_bytes + gfxvidinfo.width);
+#endif
+}
+
 static int drawing_color_matches;
 static enum { color_match_acolors, color_match_full } color_match_type;
 
 static void adjust_drawing_colors (int ctable, int bplham)
 {
+#if AGA_CHIPSET == 0
     if (drawing_color_matches != ctable) {
 	if (bplham) {
 	    memcpy (&colors_for_drawing, curr_color_tables + ctable,
@@ -1789,6 +1822,13 @@
 		sizeof colors_for_drawing.color_regs);
 	color_match_type = color_match_full;
     }
+#else
+    if (drawing_color_matches != ctable) {
+	memcpy (&colors_for_drawing, curr_color_tables + ctable,
+		sizeof colors_for_drawing);
+	drawing_color_matches = ctable;
+    }
+#endif
 }
 
 static __inline__ void adjust_color0_for_color_change (void)
@@ -1796,7 +1836,9 @@
     drawing_color_matches = -1;
     if (dp_for_drawing->color0 != 0xFFFFFFFFul) {
 	colors_for_drawing.color_regs[0] = dp_for_drawing->color0;
+#if AGA_CHIPSET == 0
 	colors_for_drawing.acolors[0] = xcolors[dp_for_drawing->color0];
+#endif
     }
 }
 
@@ -1818,7 +1860,9 @@
 	worker (lastpos, nextpos);
 	if (i != dip_for_drawing->last_color_change) {
 	    colors_for_drawing.color_regs[cc->regno] = cc->value;
+#if AGA_CHIPSET == 0
 	    colors_for_drawing.acolors[cc->regno] = xcolors[cc->value];
+#endif
 	}
 	if (nextpos > lastpos) {
 	    lastpos = nextpos;
@@ -1862,10 +1906,9 @@
     int do_double = 0;
     enum double_how dh;
 
-    dp_for_drawing = 0;
-    dip_for_drawing = 0;
+    dp_for_drawing = line_decisions + lineno;
+    dip_for_drawing = curr_drawinfo + lineno;
     switch (linestate[lineno]) {
-     case LINE_AS_PREVIOUS:
      case LINE_REMEMBERED_AS_PREVIOUS:
 	{
 	    static int warned = 0;
@@ -1875,16 +1918,22 @@
 	line_decisions[lineno].which = -2;
 	return;
 
-     case LINE_BORDER_PREV:
-	border = 1;
-	dp_for_drawing = line_decisions + lineno - 1;
-	dip_for_drawing = curr_drawinfo + lineno - 1;
+     case LINE_BLACK:
+	line_decisions[lineno].which = -2;
+	linestate[lineno] = LINE_REMEMBERED_AS_BLACK;
+	border = 2;
 	break;
 
-     case LINE_BORDER_NEXT:
-	border = 1;
-	dp_for_drawing = line_decisions + lineno + 1;
-	dip_for_drawing = curr_drawinfo + lineno + 1;
+     case LINE_REMEMBERED_AS_BLACK:
+	return;
+
+     case LINE_AS_PREVIOUS:
+	dp_for_drawing--;
+	dip_for_drawing--;
+	if (dp_for_drawing->which != 1)
+	    border = 1;
+	line_decisions[lineno].which = -2;
+	linestate[lineno] = LINE_DONE_AS_PREVIOUS;
 	break;
 
      case LINE_DONE_AS_PREVIOUS:
@@ -1898,45 +1947,27 @@
 	if (follow_ypos != -1) {
 	    do_double = 1;
 	    linetoscr_double_offset = gfxvidinfo.rowbytes * (follow_ypos - gfx_ypos);
+	    linestate[lineno + 1] = LINE_DONE_AS_PREVIOUS;
 	}
 
 	/* fall through */
      default:
-	dip_for_drawing = curr_drawinfo + lineno;
-	dp_for_drawing = line_decisions + lineno;
 	if (dp_for_drawing->which != 1)
 	    border = 1;
-	break;
-    }
-
-    if (!line_changed[lineno] && !frame_redraw_necessary) {
-	/* The case where we can skip redrawing this line. If this line
-	 * is supposed to be doubled, and the next line is remembered as
-	 * having been doubled, then the next line is done as well. */
-	if (do_double) {
-	    /* @@@ This is buggy. FIXME */
-	    if (linestate[lineno+1] != LINE_REMEMBERED_AS_PREVIOUS) {
-		if (gfxvidinfo.linemem == 0)
-		    memcpy (row_map[follow_ypos], row_map[gfx_ypos], gfxvidinfo.rowbytes);
-		line_decisions[lineno + 1].which = -2;
-		do_flush_line (follow_ypos);
-	    }
-	    linestate[lineno + 1] = LINE_DONE_AS_PREVIOUS;
-	}
 	linestate[lineno] = LINE_DONE;
-	return;
+	break;
     }
 
     dh = dh_line;
     xlinebuffer = gfxvidinfo.linemem;
-    if (xlinebuffer == 0 && do_double && dip_for_drawing->nr_color_changes != 0)
+    if (xlinebuffer == 0 && do_double && border != 2 && dip_for_drawing->nr_color_changes != 0)
 	xlinebuffer = gfxvidinfo.emergmem, dh = dh_emerg;
     if (xlinebuffer == 0)
 	xlinebuffer = row_map[gfx_ypos], dh = dh_buf;
     xlinebuffer -= linetoscr_x_adjust_bytes;
     aga_lbufptr = aga_linebuf;
 
-    if (!border) {
+    if (border == 0) {
 	pfield_expand_dp_bplcon ();
 
 #ifdef LORES_HACK
@@ -1983,8 +2014,8 @@
 
 	if (dip_for_drawing->nr_color_changes == 0) {
 	    pfield_do_linetoscr_full (dh == dh_buf ? do_double : 0);
+	    finish_line_aga ();
 	    do_flush_line (gfx_ypos);
-	    linestate[lineno] = LINE_DONE;
 #if 0
 	    if (dh == dh_emerg)
 		abort ();
@@ -1993,24 +2024,22 @@
 		/* If dh == dh_line, do_flush_line will re-use the rendered line
 		 * from linemem.  If dh == dh_buf, the line will have been doubled
 		 * by pfield_do_linetoscr_full.  */
-		linestate[lineno + 1] = LINE_DONE_AS_PREVIOUS;
 		do_flush_line (follow_ypos);
 	    }
 	} else {
 	    adjust_color0_for_color_change ();
 	    do_color_changes (pfield_do_linetoscr);
+	    finish_line_aga ();
 
 	    if (dh == dh_emerg)
 		memcpy (row_map[gfx_ypos], xlinebuffer + linetoscr_x_adjust_bytes, gfxvidinfo.rowbytes);
 
-	    linestate[lineno] = LINE_DONE;
 	    do_flush_line (gfx_ypos);
 	    if (do_double) {
 		if (dh == dh_emerg)
 		    memcpy (row_map[follow_ypos], xlinebuffer + linetoscr_x_adjust_bytes, gfxvidinfo.rowbytes);
 		else if (dh == dh_buf)
 		    memcpy (row_map[follow_ypos], row_map[gfx_ypos], gfxvidinfo.rowbytes);
-		linestate[lineno + 1] = LINE_DONE_AS_PREVIOUS;
 		line_decisions[lineno + 1].which = -2;
 		do_flush_line (follow_ypos);
 	    }
@@ -2019,7 +2048,7 @@
 	if (currprefs.gfx_lores == 2)
 	    currprefs.gfx_lores = 0;
 #endif
-    } else { /* Border. */
+    } else if (border == 1) {
 	adjust_drawing_colors (dp_for_drawing->ctable, 0);
 
 	/* Check color0 adjust only if we have color changes - shouldn't happen
@@ -2028,7 +2057,6 @@
 	if (dip_for_drawing->nr_color_changes == 0) {
 	    fill_line ();
 	    do_flush_line (gfx_ypos);
-	    linestate[lineno] = LINE_DONE;
 #if 0
 	    if (dh == dh_emerg)
 		abort ();
@@ -2041,7 +2069,6 @@
 		/* If dh == dh_line, do_flush_line will re-use the rendered line
 		 * from linemem.  */
 		do_flush_line (follow_ypos);
-		linestate[lineno+1] = LINE_DONE_AS_PREVIOUS;
 	    }
 	    return;
 	}
@@ -2053,7 +2080,6 @@
 	    memcpy (row_map[gfx_ypos], xlinebuffer + linetoscr_x_adjust_bytes, gfxvidinfo.rowbytes);
 
 	do_flush_line (gfx_ypos);
-	linestate[lineno] = LINE_DONE;
 	if (do_double) {
 	    if (dh == dh_emerg)
 		memcpy (row_map[follow_ypos], xlinebuffer + linetoscr_x_adjust_bytes, gfxvidinfo.rowbytes);
@@ -2062,9 +2088,16 @@
 	    /* If dh == dh_line, do_flush_line will re-use the rendered line
 	     * from linemem.  */
 	    do_flush_line (follow_ypos);
-	    linestate[lineno + 1] = LINE_DONE_AS_PREVIOUS;
 	    line_decisions[lineno + 1].which = -2;
 	}
+    } else {
+#if AGA_CHIPSET == 0
+	xcolnr tmp = colors_for_drawing.acolors[0];
+	colors_for_drawing.acolors[0] = xcolors[0];
+	fill_line ();
+	do_flush_line (gfx_ypos);
+	colors_for_drawing.acolors[0] = tmp;
+#endif
     }
 }
 
@@ -2233,8 +2266,18 @@
 
     maxline = currprefs.gfx_linedbl ? (maxvpos+1) * 2 + 1 : (maxvpos+1) + 1;
 #ifdef SMART_UPDATE
-    for (i = 0; i < maxline; i++)
-	linestate[i] = linestate[i] == LINE_DONE_AS_PREVIOUS ? LINE_REMEMBERED_AS_PREVIOUS : LINE_UNDECIDED;
+    for (i = 0; i < maxline; i++) {
+	switch (linestate[i]) {
+	 case LINE_DONE_AS_PREVIOUS:
+	    linestate[i] = LINE_REMEMBERED_AS_PREVIOUS;
+	    break;
+	 case LINE_REMEMBERED_AS_BLACK:
+	    break;
+	 default:
+	    linestate[i] = LINE_UNDECIDED;
+	    break;
+	}
+    }
 #else
     memset (linestate, LINE_UNDECIDED, maxline);
 #endif
@@ -2382,6 +2425,7 @@
 	count_frame ();
 	check_picasso ();
 
+	check_prefs_changed_audio ();
 	check_prefs_changed_custom ();
 	check_prefs_changed_cpu ();
 	if (check_prefs_changed_gfx ()) {
@@ -2399,30 +2443,40 @@
     }
 }
 
-void hsync_record_line_state (int lineno, enum nln_how how)
+void hsync_record_line_state (int lineno, enum nln_how how, int changed)
 {
+    char *state;
     if (framecnt != 0)
 	return;
+
+    state = linestate + lineno;
+    changed += frame_redraw_necessary;
+
     switch (how) {
      case nln_normal:
-	linestate[lineno] = LINE_DECIDED;
+	*state = changed ? LINE_DECIDED : LINE_DONE;
 	break;
      case nln_doubled:
-	linestate[lineno] = LINE_DECIDED_DOUBLE;
-	if (linestate[lineno+1] != LINE_REMEMBERED_AS_PREVIOUS)
-	    linestate[lineno+1] = LINE_AS_PREVIOUS;
+	*state = changed ? LINE_DECIDED_DOUBLE : LINE_DONE;
+	changed += state[1] != LINE_REMEMBERED_AS_PREVIOUS;
+	state[1] = changed ? LINE_AS_PREVIOUS : LINE_DONE_AS_PREVIOUS;
+	break;
+     case nln_nblack:
+	*state = changed ? LINE_DECIDED : LINE_DONE;
+	if (state[1] != LINE_REMEMBERED_AS_BLACK)
+	    state[1] = LINE_BLACK;
 	break;
      case nln_lower:
-	if (linestate[lineno-1] == LINE_UNDECIDED)
-	    linestate[lineno-1] = LINE_BORDER_NEXT;
-	linestate[lineno] = LINE_DECIDED;
+	if (state[-1] == LINE_UNDECIDED)
+	    state[-1] = LINE_BLACK;
+	*state = changed ? LINE_DECIDED : LINE_DONE;
 	break;
      case nln_upper:
-	linestate[lineno] = LINE_DECIDED;
-	if (linestate[lineno+1] == LINE_UNDECIDED
-	    || linestate[lineno+1] == LINE_REMEMBERED_AS_PREVIOUS
-	    || linestate[lineno+1] == LINE_AS_PREVIOUS)
-	    linestate[lineno+1] = LINE_BORDER_PREV;
+	*state = changed ? LINE_DECIDED : LINE_DONE;
+	if (state[1] == LINE_UNDECIDED
+	    || state[1] == LINE_REMEMBERED_AS_PREVIOUS
+	    || state[1] == LINE_AS_PREVIOUS)
+	    state[1] = LINE_BLACK;
 	break;
     }
 }
diff -r -u uae-0.8.5/src/filesys.c uae-0.8.6/src/filesys.c
--- uae-0.8.5/src/filesys.c	Thu Jul  2 22:15:15 1998
+++ uae-0.8.6/src/filesys.c	Sat Jul 18 13:14:42 1998
@@ -242,6 +242,13 @@
     if (nr >= mountinfo->num_units)
 	return "No slot allocated for this unit";
 
+    tmpui.hf.fd = 0;
+    tmpui.devname = 0;
+    tmpui.volname = 0;
+    tmpui.rootdir = 0;
+    tmpui.unit_pipe = 0;
+    tmpui.back_pipe = 0;
+
     if (volname != 0) {
 	tmpui.volname = my_strdup (volname);
 	tmpui.hf.fd = 0;
@@ -290,13 +297,6 @@
     if (nr >= MAX_UNITS)
 	return "Maximum number of file systems mounted";
 
-    uip->hf.fd = 0;
-    uip->devname = 0;
-    uip->volname = 0;
-    uip->rootdir = 0;
-    uip->unit_pipe = 0;
-    uip->back_pipe = 0;
-
     mountinfo->num_units++;
     retval = set_filesys_unit (mountinfo, nr, volname, rootdir, readonly,
 			       secspertrack, surfaces, reserved);
@@ -950,6 +950,7 @@
     } else {
 	get_file_attrs (aino);
     }
+
     recycle_aino (unit, aino);
     TRACE(("created aino %x, normal\n", aino->uniq));
     return aino;
@@ -2343,9 +2344,9 @@
     }
 
     /* @@@ what should we do if there are locks on a1? */
-    if (-1 == rename(a1->nname, a2->nname)) {
+    if (-1 == rename (a1->nname, a2->nname)) {
 	PUT_PCK_RES1 (packet, DOS_FALSE);
-	PUT_PCK_RES2 (packet, dos_errno());
+	PUT_PCK_RES2 (packet, dos_errno ());
 	return;
     }
     move_aino_children (unit, a1, a2);
diff -r -u uae-0.8.5/src/gtkui.c uae-0.8.6/src/gtkui.c
--- uae-0.8.5/src/gtkui.c	Wed Jul  1 17:26:23 1998
+++ uae-0.8.6/src/gtkui.c	Sat Jul 18 13:14:42 1998
@@ -35,6 +35,7 @@
 static char *new_disk_string[4];
 
 static GtkAdjustment *cpuspeed_adj;
+static GtkWidget *cpuspeed_widgets[4], *cpuspeed_scale;
 static GtkWidget *cpu_widget[4], *a24m_widget, *ccpu_widget;
 static GtkWidget *sound_widget[4], *sound_bits_widget[2], *sound_freq_widget[3], *sound_ch_widget[2];
 
@@ -95,12 +96,15 @@
     gtk_widget_set_sensitive (a24m_widget, changed_prefs.cpu_level > 1);
     gtk_toggle_button_set_state (GTK_TOGGLE_BUTTON (ccpu_widget), changed_prefs.cpu_compatible != 0);
     gtk_widget_set_sensitive (ccpu_widget, changed_prefs.cpu_level == 0);
+    gtk_widget_set_sensitive (cpuspeed_scale, changed_prefs.m68k_speed > 0);
 }
 
 static void set_cpu_widget (void)
 {
     int nr = changed_prefs.cpu_level;
     gtk_toggle_button_set_state (GTK_TOGGLE_BUTTON (cpu_widget[nr]), TRUE);
+    nr = currprefs.m68k_speed + 1 < 3 ? currprefs.m68k_speed + 1 : 2;
+    gtk_toggle_button_set_state (GTK_TOGGLE_BUTTON (cpuspeed_widgets[nr]), TRUE);
 }
 
 static void set_gfx_state (void)
@@ -176,9 +180,8 @@
 	    set_cpu_state ();
 	    set_gfx_state ();
 	    set_joy_state ();
-#ifdef SOUND_RECONFIG_SUPPORT
 	    set_sound_state ();
-#endif
+
 	    gui_active = 1;
 	    break;
 	}
@@ -232,7 +235,11 @@
 
 static void cpuspeed_changed (void)
 {
-    changed_prefs.m68k_speed = cpuspeed_adj->value;
+    int which = find_current_toggle (cpuspeed_widgets, 3);
+    changed_prefs.m68k_speed = (which == 0 ? -1
+				: which == 1 ? 0
+				: cpuspeed_adj->value);
+    set_cpu_state ();
 }
 
 static void cputype_changed (void)
@@ -243,7 +250,7 @@
 
     oldcl = changed_prefs.cpu_level;
 
-    changed_prefs.cpu_level = find_current_toggle(cpu_widget, 4);
+    changed_prefs.cpu_level = find_current_toggle (cpu_widget, 4);
     changed_prefs.cpu_compatible = GTK_TOGGLE_BUTTON (ccpu_widget)->active;
     changed_prefs.address_space_24 = GTK_TOGGLE_BUTTON (a24m_widget)->active;
 
@@ -377,6 +384,13 @@
     gtk_box_pack_start (GTK_BOX (tobox), thing, TRUE, TRUE, 0);
 }
 
+static void add_empty_hbox (GtkWidget *tobox)
+{
+    GtkWidget *thing = gtk_hbox_new (FALSE, 0);
+    gtk_widget_show (thing);
+    gtk_box_pack_start (GTK_BOX (tobox), thing, TRUE, TRUE, 0);
+}
+
 static void add_centered_to_vbox (GtkWidget *vbox, GtkWidget *w)
 {
     GtkWidget *hbox = gtk_hbox_new (TRUE, 0);
@@ -399,11 +413,12 @@
     return hbox2;
 }
 
-static void add_labelled_widget_centered (const char *str, GtkWidget *thing, GtkWidget *vbox)
+static GtkWidget *add_labelled_widget_centered (const char *str, GtkWidget *thing, GtkWidget *vbox)
 {
     GtkWidget *w = make_labelled_widget (str, thing);
     gtk_widget_show (w);
     add_centered_to_vbox (vbox, w);
+    return w;
 }
 
 static void make_radio_group (const char **labels, GtkWidget *tobox,
@@ -535,10 +550,38 @@
     add_empty_vbox (vbox);
 }
 
+static GtkWidget *make_cpu_speed_sel (void)
+{
+    static const char *labels[] = {
+	"Optimize for host CPU speed","Approximate 68000/7MHz speed", "Adjustable",
+	NULL
+    };
+    GtkWidget *frame, *newbox;
+
+    frame = gtk_frame_new ("CPU speed");
+    newbox = gtk_vbox_new (FALSE, 4);
+    gtk_widget_show (newbox);
+    gtk_container_border_width (GTK_CONTAINER (newbox), 4);
+    gtk_container_add (GTK_CONTAINER (frame), newbox);
+    make_radio_group (labels, newbox, cpuspeed_widgets, 0, 1, cpuspeed_changed);
+
+    cpuspeed_adj = GTK_ADJUSTMENT (gtk_adjustment_new (currprefs.m68k_speed, 1.0, 10.0, 1.0, 1.0, 1.0));
+    gtk_signal_connect (GTK_OBJECT (cpuspeed_adj), "value_changed",
+			GTK_SIGNAL_FUNC (cpuspeed_changed), NULL);
+
+    cpuspeed_scale = gtk_hscale_new (cpuspeed_adj);
+    gtk_range_set_update_policy (GTK_RANGE (cpuspeed_scale), GTK_UPDATE_DELAYED);
+    gtk_scale_set_digits (GTK_SCALE (cpuspeed_scale), 0);
+    gtk_scale_set_value_pos (GTK_SCALE (cpuspeed_scale), GTK_POS_RIGHT);
+    cpuspeed_scale = add_labelled_widget_centered ("Cycles per instruction:", cpuspeed_scale, newbox);
+
+    return frame;
+}
+
 static void make_cpu_widgets (GtkWidget *vbox)
 {
     int i;
-    GtkWidget *newbox, *frame;
+    GtkWidget *newbox, *hbox, *frame;
     GtkWidget *thing;
     static const char *radiolabels[] = {
 	"68000", "68010", "68020", "68020+68881",
@@ -547,9 +590,20 @@
 
     add_empty_vbox (vbox);
 
-    newbox = make_radio_group_box ("CPU type", radiolabels, cpu_widget, 1, cputype_changed);
+    hbox = gtk_hbox_new (FALSE, 0);
+    add_empty_vbox (hbox);
+
+    newbox = make_radio_group_box ("CPU type", radiolabels, cpu_widget, 0, cputype_changed);
     gtk_widget_show (newbox);
-    add_centered_to_vbox (vbox, newbox);
+    gtk_box_pack_start (GTK_BOX (hbox), newbox, FALSE, FALSE, 0);
+
+    newbox = make_cpu_speed_sel ();
+    gtk_widget_show (newbox);
+    gtk_box_pack_start (GTK_BOX (hbox), newbox, FALSE, FALSE, 0);
+
+    add_empty_vbox (hbox);
+    gtk_widget_show (hbox); 
+    gtk_box_pack_start (GTK_BOX (vbox), hbox, FALSE, FALSE, 0);
 
     frame = gtk_frame_new ("CPU flags");
     add_centered_to_vbox (vbox, frame);
@@ -559,23 +613,13 @@
     gtk_container_border_width (GTK_CONTAINER (newbox), 4);
     gtk_container_add (GTK_CONTAINER (frame), newbox);
 
-    cpuspeed_adj = GTK_ADJUSTMENT (gtk_adjustment_new (currprefs.m68k_speed, 1.0, 10.0, 1.0, 1.0, 1.0));
-    gtk_signal_connect (GTK_OBJECT (cpuspeed_adj), "value_changed",
-			GTK_SIGNAL_FUNC (cpuspeed_changed), NULL);
-
-    thing = gtk_hscale_new (cpuspeed_adj);
-    gtk_range_set_update_policy (GTK_RANGE (thing), GTK_UPDATE_DELAYED);
-    gtk_scale_set_digits (GTK_SCALE (thing), 0);
-    gtk_scale_set_value_pos (GTK_SCALE (thing), GTK_POS_RIGHT);
-    add_labelled_widget_centered ("Cycles per instruction:", thing, newbox);
-
     a24m_widget = gtk_check_button_new_with_label ("24 bit address space");
     add_centered_to_vbox (newbox, a24m_widget);
     gtk_widget_show (a24m_widget);
     ccpu_widget = gtk_check_button_new_with_label ("Slow but compatible");
     add_centered_to_vbox (newbox, ccpu_widget);
     gtk_widget_show (ccpu_widget);
-
+    
     add_empty_vbox (vbox);
 
     gtk_signal_connect (GTK_OBJECT (ccpu_widget), "clicked",
@@ -634,7 +678,6 @@
 
     add_empty_vbox (vbox);
 
-#ifdef SOUND_RECONFIG_SUPPORT
     newbox = make_radio_group_box ("Mode", soundlabels1, sound_widget, 1, sound_changed);
     gtk_widget_show (newbox);
     add_centered_to_vbox (vbox, newbox);
@@ -648,11 +691,7 @@
     newbox = make_radio_group_box ("Resolution", soundlabels2, sound_bits_widget, 1, sound_changed);
     gtk_widget_show (newbox);
     gtk_box_pack_start (GTK_BOX (hbox), newbox, FALSE, TRUE, 0);
-#else
-    hbox = gtk_label_new ("Your sound system doesn't support\nrun-time reconfiguration.");
-    gtk_widget_show (hbox);
-    add_centered_to_vbox (vbox, hbox);
-#endif
+
     add_empty_vbox (vbox);
 }
 
diff -r -u uae-0.8.5/src/include/drawing.h uae-0.8.6/src/include/drawing.h
--- uae-0.8.5/src/include/drawing.h	Wed Jun  3 11:41:55 1998
+++ uae-0.8.6/src/include/drawing.h	Sat Jul 18 13:14:43 1998
@@ -12,13 +12,7 @@
 #endif
 
 /*
- * Several people have tried this define, with not much success. Turning on
- * AGA garbles the screen. A place you could start looking is the calcdiw()
- * function - the AGA timing parameters are different, and apparently I
- * haven't figured out the correct formula yet. Pity, the current one looks
- * logical.
- *
- * @@@ Probably won't compile in this version.
+ * This doesn't work very well
  */
 
 /* #define EMULATE_AGA */
@@ -55,7 +49,10 @@
 
 struct color_entry {
 #if AGA_CHIPSET == 0
-    /* X86.S expects this at the start of the structure. */
+    /* Color values in two formats: 12 bit Amiga RGB (color_regs), and
+     * the native color value; both for each Amiga hardware color register. 
+     */
+    /* X86.S expects acolors at the start of the structure. */
     xcolnr acolors[32];
     uae_u16 color_regs[32];
 #else
@@ -143,7 +140,6 @@
 
 extern struct decision line_decisions[2 * (maxvpos+1) + 1];
 extern struct draw_info line_drawinfo[2][2 * (maxvpos+1) + 1];
-extern char line_changed[2 * (maxvpos+1)];
 
 extern uae_u8 line_data[(maxvpos+1) * 2][MAX_PLANES * MAX_WORDS_PER_LINE * 2];
 
@@ -163,10 +159,12 @@
     /* Interlace, doubled display, upper line.  */
     nln_upper,
     /* Interlace, doubled display, lower line.  */
-    nln_lower
+    nln_lower,
+    /* This line normal, next one black.  */
+    nln_nblack
 };
 
-extern void hsync_record_line_state (int lineno, enum nln_how);
+extern void hsync_record_line_state (int lineno, enum nln_how, int changed);
 extern void vsync_handle_redraw (int long_frame, int lof_changed);
 extern void init_hardware_for_drawing_frame (void);
 extern void finish_drawing_frame (void);
diff -r -u uae-0.8.5/src/include/gensound.h uae-0.8.6/src/include/gensound.h
--- uae-0.8.5/src/include/gensound.h	Sat Apr 18 15:38:17 1998
+++ uae-0.8.6/src/include/gensound.h	Sat Jul 18 13:14:43 1998
@@ -12,7 +12,8 @@
 extern void (*sample_handler) (void);
 extern unsigned long sample_evtime;
 
-/* Determine if we can produce any sound at all. */
+/* Determine if we can produce any sound at all.  This can be only a guess;
+ * if unsure, say yes.  Any call to init_sound may change the value.  */
 extern int setup_sound (void);
 
 extern int init_sound (void);
diff -r -u uae-0.8.5/src/include/options.h uae-0.8.6/src/include/options.h
--- uae-0.8.5/src/include/options.h	Wed Jul  1 17:26:24 1998
+++ uae-0.8.6/src/include/options.h	Sat Jul 18 13:14:43 1998
@@ -9,7 +9,7 @@
 
 #define UAEMAJOR 0
 #define UAEMINOR 8
-#define UAESUBREV 5
+#define UAESUBREV 6
 
 typedef enum { KBD_LANG_US, KBD_LANG_DE, KBD_LANG_SE, KBD_LANG_FR, KBD_LANG_IT, KBD_LANG_ES } KbdLang;
 
diff -r -u uae-0.8.5/src/main.c uae-0.8.6/src/main.c
--- uae-0.8.5/src/main.c	Fri Jun 12 15:52:55 1998
+++ uae-0.8.6/src/main.c	Sat Jul 18 13:14:42 1998
@@ -469,10 +469,15 @@
     currprefs.gfx_xcenter = strchr (x2, 'x') != 0 ? 1 : strchr (x2, 'X') != 0 ? 2 : 0;
     currprefs.gfx_ycenter = strchr (x2, 'y') != 0 ? 1 : strchr (x2, 'Y') != 0 ? 2 : 0;
     currprefs.gfx_linedbl = strchr (x2, 'd') != 0;
+    currprefs.gfx_linedbl += 2 * (strchr (x2, 'D') != 0);
     currprefs.gfx_afullscreen = strchr (x2, 'a') != 0;
     currprefs.gfx_pfullscreen = strchr (x2, 'p') != 0;
     currprefs.gfx_correct_aspect = strchr (x2, 'c') != 0;
 
+    if (currprefs.gfx_linedbl == 3) {
+	fprintf (stderr, "You can't use both 'd' and 'D' modifiers in the display mode specification.\n");
+    }
+    
     free (x0);
     return;
 
@@ -992,7 +997,7 @@
 	    exit (0);
 	}
     }
-    if (sound_available && ! init_sound ()) {
+    if (sound_available && currprefs.produce_sound > 1 && ! init_sound ()) {
 	fprintf (stderr, "Sound driver unavailable: Sound output disabled\n");
 	currprefs.produce_sound = 0;
     }
Only in uae-0.8.6/src: md-ppc-gcc
diff -r -u uae-0.8.5/src/memory.c uae-0.8.6/src/memory.c
--- uae-0.8.5/src/memory.c	Wed Jul  1 17:26:23 1998
+++ uae-0.8.6/src/memory.c	Sat Jul 18 13:14:42 1998
@@ -36,29 +36,29 @@
 #endif
 
 #ifdef NO_INLINE_MEMORY_ACCESS
-__inline__ uae_u32 longget(uaecptr addr)
+__inline__ uae_u32 longget (uaecptr addr)
 {
-    return call_mem_get_func(get_mem_bank(addr).lget, addr);
+    return call_mem_get_func (get_mem_bank (addr).lget, addr);
 }
-__inline__ uae_u32 wordget(uaecptr addr)
+__inline__ uae_u32 wordget (uaecptr addr)
 {
-    return call_mem_get_func(get_mem_bank(addr).wget, addr);
+    return call_mem_get_func (get_mem_bank (addr).wget, addr);
 }
-__inline__ uae_u32 byteget(uaecptr addr)
+__inline__ uae_u32 byteget (uaecptr addr)
 {
-    return call_mem_get_func(get_mem_bank(addr).bget, addr);
+    return call_mem_get_func (get_mem_bank (addr).bget, addr);
 }
-__inline__ void longput(uaecptr addr, uae_u32 l)
+__inline__ void longput (uaecptr addr, uae_u32 l)
 {
-    call_mem_put_func(get_mem_bank(addr).lput, addr, l);
+    call_mem_put_func (get_mem_bank (addr).lput, addr, l);
 }
-__inline__ void wordput(uaecptr addr, uae_u32 w)
+__inline__ void wordput (uaecptr addr, uae_u32 w)
 {
-    call_mem_put_func(get_mem_bank(addr).wput, addr, w);
+    call_mem_put_func (get_mem_bank (addr).wput, addr, w);
 }
-__inline__ void byteput(uaecptr addr, uae_u32 b)
+__inline__ void byteput (uaecptr addr, uae_u32 b)
 {
-    call_mem_put_func(get_mem_bank(addr).bput, addr, b);
+    call_mem_put_func (get_mem_bank (addr).bput, addr, b);
 }
 #endif
 
@@ -203,7 +203,7 @@
     addr -= chipmem_start & chipmem_mask;
     addr &= chipmem_mask;
     m = (uae_u32 *)(chipmemory + addr);
-    return do_get_mem_long(m);
+    return do_get_mem_long (m);
 }
 
 uae_u32 REGPARAM2 chipmem_wget (uaecptr addr)
@@ -212,7 +212,7 @@
     addr -= chipmem_start & chipmem_mask;
     addr &= chipmem_mask;
     m = (uae_u16 *)(chipmemory + addr);
-    return do_get_mem_word(m);
+    return do_get_mem_word (m);
 }
 
 uae_u32 REGPARAM2 chipmem_bget (uaecptr addr)
@@ -228,7 +228,7 @@
     addr -= chipmem_start & chipmem_mask;
     addr &= chipmem_mask;
     m = (uae_u32 *)(chipmemory + addr);
-    do_put_mem_long(m, l);
+    do_put_mem_long (m, l);
 }
 
 void REGPARAM2 chipmem_wput (uaecptr addr, uae_u32 w)
@@ -237,7 +237,7 @@
     addr -= chipmem_start & chipmem_mask;
     addr &= chipmem_mask;
     m = (uae_u16 *)(chipmemory + addr);
-    do_put_mem_word(m, w);
+    do_put_mem_word (m, w);
 }
 
 void REGPARAM2 chipmem_bput (uaecptr addr, uae_u32 b)
@@ -280,7 +280,7 @@
     addr -= bogomem_start & bogomem_mask;
     addr &= bogomem_mask;
     m = (uae_u32 *)(bogomemory + addr);
-    return do_get_mem_long(m);
+    return do_get_mem_long (m);
 }
 
 uae_u32 REGPARAM2 bogomem_wget (uaecptr addr)
@@ -289,7 +289,7 @@
     addr -= bogomem_start & bogomem_mask;
     addr &= bogomem_mask;
     m = (uae_u16 *)(bogomemory + addr);
-    return do_get_mem_word(m);
+    return do_get_mem_word (m);
 }
 
 uae_u32 REGPARAM2 bogomem_bget (uaecptr addr)
@@ -305,7 +305,7 @@
     addr -= bogomem_start & bogomem_mask;
     addr &= bogomem_mask;
     m = (uae_u32 *)(bogomemory + addr);
-    do_put_mem_long(m, l);
+    do_put_mem_long (m, l);
 }
 
 void REGPARAM2 bogomem_wput (uaecptr addr, uae_u32 w)
@@ -314,7 +314,7 @@
     addr -= bogomem_start & bogomem_mask;
     addr &= bogomem_mask;
     m = (uae_u16 *)(bogomemory + addr);
-    do_put_mem_word(m, w);
+    do_put_mem_word (m, w);
 }
 
 void REGPARAM2 bogomem_bput (uaecptr addr, uae_u32 b)
@@ -357,7 +357,7 @@
     addr -= a3000mem_start & a3000mem_mask;
     addr &= a3000mem_mask;
     m = (uae_u32 *)(a3000memory + addr);
-    return do_get_mem_long(m);
+    return do_get_mem_long (m);
 }
 
 uae_u32 REGPARAM2 a3000mem_wget (uaecptr addr)
@@ -366,7 +366,7 @@
     addr -= a3000mem_start & a3000mem_mask;
     addr &= a3000mem_mask;
     m = (uae_u16 *)(a3000memory + addr);
-    return do_get_mem_word(m);
+    return do_get_mem_word (m);
 }
 
 uae_u32 REGPARAM2 a3000mem_bget (uaecptr addr)
@@ -382,7 +382,7 @@
     addr -= a3000mem_start & a3000mem_mask;
     addr &= a3000mem_mask;
     m = (uae_u32 *)(a3000memory + addr);
-    do_put_mem_long(m, l);
+    do_put_mem_long (m, l);
 }
 
 void REGPARAM2 a3000mem_wput (uaecptr addr, uae_u32 w)
@@ -391,7 +391,7 @@
     addr -= a3000mem_start & a3000mem_mask;
     addr &= a3000mem_mask;
     m = (uae_u16 *)(a3000memory + addr);
-    do_put_mem_word(m, w);
+    do_put_mem_word (m, w);
 }
 
 void REGPARAM2 a3000mem_bput (uaecptr addr, uae_u32 b)
@@ -434,7 +434,7 @@
     addr -= kickmem_start & kickmem_mask;
     addr &= kickmem_mask;
     m = (uae_u32 *)(kickmemory + addr);
-    return do_get_mem_long(m);
+    return do_get_mem_long (m);
 }
 
 uae_u32 REGPARAM2 kickmem_wget (uaecptr addr)
@@ -443,7 +443,7 @@
     addr -= kickmem_start & kickmem_mask;
     addr &= kickmem_mask;
     m = (uae_u16 *)(kickmemory + addr);
-    return do_get_mem_word(m);
+    return do_get_mem_word (m);
 }
 
 uae_u32 REGPARAM2 kickmem_bget (uaecptr addr)
@@ -687,7 +687,8 @@
 	abort ();
     }
 #endif
-
+    
+    do_put_mem_long (chipmemory + 4, 0);
     init_mem_banks ();
 
     /* Map the chipmem into all of the lower 16MB */
@@ -753,5 +754,5 @@
 	endhioffs = 0x10000;
     for (hioffs = 0; hioffs < endhioffs; hioffs += 0x100)
 	for (bnr = start; bnr < start+size; bnr++)
-	    put_mem_bank((bnr + hioffs) << 16, bank);
+	    put_mem_bank ((bnr + hioffs) << 16, bank);
 }
diff -r -u uae-0.8.5/src/od-dos/joystick.c uae-0.8.6/src/od-dos/joystick.c
--- uae-0.8.5/src/od-dos/joystick.c	Wed Nov 19 18:34:26 1997
+++ uae-0.8.6/src/od-dos/joystick.c	Sat Jul 18 13:14:43 1998
@@ -17,6 +17,7 @@
 #include "custom.h"
 #include "joystick.h"
 
+int nr_joysticks;
 int HasJoy0 = 0, HasJoy1 = 0;
 int minx0, maxx0, miny0, maxy0;
 int minx1, maxx1, miny1, maxy1;
@@ -158,6 +159,8 @@
 	miny1 = JoyY - 2*JoyY/3;
 	maxy1 = JoyY + 2*JoyY/3;
     }
+
+    nr_joysticks = HasJoy0 + HasJoy1;
 }
 
 void close_joystick(void) {
diff -r -u uae-0.8.5/src/od-dos/memory.h uae-0.8.6/src/od-dos/memory.h
--- uae-0.8.5/src/od-dos/memory.h	Mon Mar  3 13:32:02 1997
+++ uae-0.8.6/src/od-dos/memory.h	Sat Jul 18 13:14:43 1998
@@ -1,11 +1,15 @@
- /*
+ /* 
   * UAE - The Un*x Amiga Emulator
-  *
-  * See if this OS has mmap or equivalent
+  * 
+  * See if this OS has mmap.
   *
   * Copyright 1996 Bernd Schmidt
   */
 
 #undef USE_MAPPED_MEMORY
-#undef CAN_MAP_MEMORY
 
+#if USER_PROGRAMS_BEHAVE > 0
+#define USE_MAPPED_MEMORY
+#endif
+
+#define CAN_MAP_MEMORY
diff -r -u uae-0.8.5/src/od-dos/misc/handlers.c uae-0.8.6/src/od-dos/misc/handlers.c
--- uae-0.8.5/src/od-dos/misc/handlers.c	Wed Nov 19 18:34:26 1997
+++ uae-0.8.6/src/od-dos/misc/handlers.c	Sat Jul 18 13:14:43 1998
@@ -35,30 +35,20 @@
 #include "misc/misc.h"
 
 /* dummie Amiga Keys */
-#define AK_EjectDisk    0xfa
-#define AK_ChangeDisk   0xfb
-#define AK_SaveScreen1  0xfc
-#define AK_SaveScreen2  0xfd
-#define AK_TougleScreen 0xfe
-#define AK_QuitProgram  0xff
+#define AK_Options	0x1fc
+#define AK_SaveScreen1  0x1fd
+#define AK_SaveScreen2  0x1fe
+#define AK_TougleScreen 0x1ff
 
 /* Event Flags */
-#define EF_ResetCPU       0x0001
-#define EF_EjectDisk0     0x0002
-#define EF_EjectDisk1     0x0004
-#define EF_EjectDisk2     0x0008
-#define EF_EjectDisk3     0x0010
-#define EF_ChangeDisk0    0x0020
-#define EF_ChangeDisk1    0x0040
-#define EF_ChangeDisk2    0x0080
-#define EF_ChangeDisk3    0x0100
-#define EF_ChangeOptions  0x0200
-#define EF_EnterDebug     0x0400
-#define EF_SaveScreen     0x0800
-#define EF_TougleScreen   0x1000
-#define EF_TougleSound    0x2000
-#define EF_TougleCapsLock 0x4000
-#define EF_QuitProgram    0x8000
+#define EF_ResetCPU       0x01
+#define EF_ChangeOptions  0x02
+#define EF_EnterDebug     0x04
+#define EF_SaveScreen     0x08
+#define EF_TougleScreen   0x10
+#define EF_TougleSound    0x20
+#define EF_TougleCapsLock 0x40
+#define EF_QuitProgram    0x80
 
 extern int kpb_first, kpb_last;
 extern int keybuf[256];
@@ -66,7 +56,7 @@
 int Original_produce_sound;
 int KeyBoardInstalled = 0, MouseInstalled = 0;
 int EventFlags = 0;
-int KeyState[256];
+int KeyState[512];
 int buttonstate[3] = {0, 0, 0};
 int lastmx, lastmy;
 int newmousecounters = 0;
@@ -87,9 +77,9 @@
     AK_F6,          AK_F7,         AK_F8,          AK_F9,          AK_F10,    -1,       AK_TougleScreen, AK_NP7,
     AK_NP8,         AK_NP9,        -1,             AK_NP4,         AK_NP5,    AK_NP6,   -1,              AK_NP1,
     AK_NP2,         AK_NP3,        AK_NP0,         -1,             -1,        -1,       -1,              AK_BACKSLASH,
-    AK_QuitProgram, -1,            -1,             -1,             -1,        -1,       -1,              -1,
-    -1,             AK_RCTRL,      AK_SaveScreen1, AK_SaveScreen2, AK_RALT,   -1,       AK_ChangeDisk,   AK_UP,
-    AK_RAMI,        AK_LF,         AK_RT,          AK_EjectDisk,   AK_DN,     AK_LAMI,  AK_HELP,         AK_DEL,
+    -1, 	    -1,            -1,             -1,             -1,        -1,       -1,              -1,
+    -1,             AK_RCTRL,      AK_SaveScreen1, AK_SaveScreen2, AK_RALT,   -1,       AK_Options,	 AK_UP,
+    AK_RAMI,        AK_LF,         AK_RT,          -1,   	   AK_DN,     AK_LAMI,  AK_HELP,         AK_DEL,
     -1,             -1,            -1,             -1,             -1,        -1,       -1,              -1,
     -1,             -1,            -1,             -1,             -1,        AK_LAMI,  AK_RAMI,         -1
 };
@@ -138,49 +128,12 @@
 	    m68k_reset();
 	    EventFlags &= ~EF_ResetCPU;
 	}
-	if (EventFlags & EF_EjectDisk0) {
-	    disk_eject(0);
-	    EventFlags &= ~EF_EjectDisk0;
-	}
-	if (EventFlags & EF_EjectDisk1) {
-	    disk_eject(1);
-	    EventFlags &= ~EF_EjectDisk1;
-	}
-	if (EventFlags & EF_EjectDisk2) {
-	    disk_eject(2);
-	    EventFlags &= ~EF_EjectDisk2;
-	}
-	if (EventFlags & EF_EjectDisk3) {
-	    disk_eject(3);
-	    EventFlags &= ~EF_EjectDisk3;
-	}
-	if (EventFlags & EF_ChangeDisk0) {
-	    HandleDisk(0);
-	    KeyState[AK_ChangeDisk] = 0;
+	if (EventFlags & EF_ChangeOptions) {
+	    HandleOptions();
+	    KeyState[AK_Options] = 0;
 	    KeyState[AK_F1] = 0;
 	    record_key ((AK_F1 << 1) | 1);
-	    EventFlags &= ~EF_ChangeDisk0;
-	}
-	if (EventFlags & EF_ChangeDisk1) {
-	    HandleDisk(1);
-	    KeyState[AK_ChangeDisk] = 0;
-	    KeyState[AK_F2] = 0;
-	    record_key ((AK_F2 << 1) | 1);
-	    EventFlags &= ~EF_ChangeDisk1;
-	}
-	if (EventFlags & EF_ChangeDisk2) {
-	    HandleDisk(2);
-	    KeyState[AK_ChangeDisk] = 0;
-	    KeyState[AK_F3] = 0;
-	    record_key ((AK_F3 << 1) | 1);
-	    EventFlags &= ~EF_ChangeDisk2;
-	}
-	if (EventFlags & EF_ChangeDisk3) {
-	    HandleDisk(3);
-	    KeyState[AK_ChangeDisk] = 0;
-	    KeyState[AK_F4] = 0;
-	    record_key ((AK_F4 << 1) | 1);
-	    EventFlags &= ~EF_ChangeDisk3;
+	    EventFlags &= ~EF_ChangeOptions;
 	}
 	if (EventFlags & EF_EnterDebug) {
 	    EnterDebug();
@@ -275,7 +228,7 @@
 	return;
     KeyState[AmigaKey] = NewState;
 
-    if (AmigaKey < AK_EjectDisk) {
+    if (AmigaKey < AK_Options) {
 	if (NewState)
 	    record_key (AmigaKey << 1);
 	else
@@ -285,34 +238,18 @@
     if ((KeyState[AK_CTRL] && KeyState[AK_LAMI] && KeyState[AK_RAMI]) ||
 	(KeyState[AK_RCTRL] && KeyState[AK_LAMI] && KeyState[AK_RAMI]))
 	EventFlags |= EF_ResetCPU;
-    if (KeyState[AK_EjectDisk]) {
-	if (KeyState[AK_F1])
-	    EventFlags |= EF_EjectDisk0;
-	if (KeyState[AK_F2])
-	    EventFlags |= EF_EjectDisk1;
-	if (KeyState[AK_F3])
-	    EventFlags |= EF_EjectDisk2;
-	if (KeyState[AK_F4])
-	    EventFlags |= EF_EjectDisk3;
-    }
-    if (KeyState[AK_ChangeDisk]) {
+    if (KeyState[AK_Options]) {
+	if (KeyState[AK_ESC])
+	    EventFlags |= EF_QuitProgram;
 	if (KeyState[AK_F1])
-	    EventFlags |= EF_ChangeDisk0;
+	    EventFlags |= EF_ChangeOptions;
 	if (KeyState[AK_F2])
-	    EventFlags |= EF_ChangeDisk1;
-	if (KeyState[AK_F3])
-	    EventFlags |= EF_ChangeDisk2;
-	if (KeyState[AK_F4])
-	    EventFlags |= EF_ChangeDisk3;
-	if (KeyState[AK_F6])
 	    EventFlags |= EF_EnterDebug;
     }
     if (KeyState[AK_TougleScreen])
 	EventFlags |= EF_TougleScreen;
     if (KeyState[AK_SaveScreen1] && KeyState[AK_SaveScreen2])
 	EventFlags |= EF_SaveScreen;
-    if (KeyState[AK_QuitProgram])
-	EventFlags |= EF_QuitProgram;
 }
 
 int InstallKeyboardHandler(void) {
diff -r -u uae-0.8.5/src/od-dos/misc/misc.c uae-0.8.6/src/od-dos/misc/misc.c
--- uae-0.8.5/src/od-dos/misc/misc.c	Wed Nov 19 18:34:26 1997
+++ uae-0.8.6/src/od-dos/misc/misc.c	Sat Jul 18 13:14:43 1998
@@ -28,10 +28,11 @@
 #include "misc/handlers.h"
 #include "xwin.h"
 #include "video/vbe.h"
-#include "video/dos-supp.h"
+#include "tui.h"
 #include "disk.h"
 #include "debug.h"
 #include "picasso96.h"
+#include "logo.h"
 
 #define MAXMESSAGES 100
 
@@ -48,10 +49,48 @@
 void DOS_abort(void);
 void DumpMessages(void);
 static int ScreenWrite(__FSEXT_Fnumber func, int *retval, va_list rest_args);
+int scandir(const char *dir, struct dirent ***namelist,
+       int (*select)(const struct dirent *),
+       int (*cmp)(const void *, const void *));
 
 extern int NeedDither, ModeNumber, UseLinear, ScreenIsPicasso, PicassoModeNumber, PicassoUseLinear;
 extern char PicassoInvalidLines[];
 
+int origrows;
+
+int main(int argc, char **argv)
+{
+    time_t t;
+    _go32_dpmi_registers IntRegs;
+    int HasMode, i;
+
+    origrows = ScreenRows();
+    DOS_init();
+    HasMode = 1;
+    if (!SetMode(NumberOfModes-3, 1, 0))
+      if (!SetMode(NumberOfModes-3, 0, 0))
+	HasMode = 0;
+    if (HasMode) {
+      for (i=0; i<200; i++)
+	CurrentMode.PutLine(&(Logo[320*i]), i);
+      t = time(NULL)+5;
+      while(time(NULL)<t)
+	if (kbhit()) {
+	  getch();
+	  break;
+	}
+    }
+    IntRegs.x.ax = 0x1C;
+    IntRegs.h.ah = 0x00;
+    IntRegs.h.al = 0x03;
+    IntRegs.x.ss = IntRegs.x.sp = IntRegs.x.flags = 0;
+    _go32_dpmi_simulate_int(0x10, &IntRegs);
+    _set_screen_lines(50);
+    clrscr();
+    real_main(argc, argv);
+    return 0;
+}
+
 void DOS_init(void) {
     int i;
 
@@ -84,7 +123,9 @@
 }
 
 void DOS_leave(void) {
+    _set_screen_lines(origrows);
     DumpMessages();
+    printf("have a nice day!\n");
 }
 
 void DOS_abort(void) {
@@ -175,7 +216,7 @@
 	    InstallKeyboardHandler();
 	    RestoreLEDStatus(SavedLEDb);
 	    /* Set graphics mode */
-	    SetMode(ModeNumber, UseLinear);
+	    SetMode(ModeNumber, UseLinear, 0);
 	    /* Restore screen */
 	    if ((gfxvidinfo.pixbytes == 1) || NeedDither)
 		LoadPalette();
@@ -196,7 +237,7 @@
 	    InstallKeyboardHandler();
 	    RestoreLEDStatus(SavedLEDb);
 	    /* Set graphics mode */
-	    SetMode(PicassoModeNumber, PicassoUseLinear);
+	    SetMode(PicassoModeNumber, PicassoUseLinear, 0);
 	    /* Restore screen */
 	    DX_SetPalette (0, 256);
 	    for (i = 0; i < picasso_vidinfo.height; i++, addr += picasso96_state.BytesPerRow) {
@@ -208,40 +249,9 @@
     }
 }
 
-void HandleDisk(int num) {
-    char *ptr=NULL, buf[256];
-
+void HandleOptions(void) {
     EnterText();
-
-    tui_reset();
-    switch(num) {
-     case 0:
-	gotoxy(5, 4);
-	cprintf("DF0:");
-	ptr = tuifilereq("*.adf", currprefs.df[0]);
-	break;
-     case 1:
-	gotoxy(5, 4);
-	cprintf("DF1:");
-	ptr = tuifilereq("*.adf", currprefs.df[1]);
-	break;
-     case 2:
-	gotoxy(5, 4);
-	cprintf("DF2:");
-	ptr = tuifilereq("*.adf", currprefs.df[2]);
-	break;
-     case 3:
-	gotoxy(5, 4);
-	cprintf("DF3:");
-	ptr = tuifilereq("*.adf", currprefs.df[3]);
-	break;
-    }
-    tui_shutdown();
-    if (ptr != NULL) {
-	strcpy(buf, ptr);
-	disk_insert(num, buf);
-    }
-
+    gui_changesettings ();
     LeaveText();
 }
 
@@ -337,4 +347,76 @@
 	}
     }
     fclose(imagefile);
+}
+
+int scandir(const char *dir, struct dirent ***namelist,
+       int (*select)(const struct dirent *),
+       int (*cmp)(const void *, const void *))
+{
+  DIR *dp = opendir (dir);
+  struct dirent **v = NULL;
+  size_t vsize = 0, i;
+  struct dirent *d;
+  int save;
+
+  if (dp == NULL)
+    return -1;
+
+  save = errno;
+  errno = 0;
+
+  i = 0;
+  while ((d = readdir (dp)) != NULL)
+    if (select == NULL || (*select) (d))
+      {
+	if (i == vsize)
+	  {
+	    struct dirent **new;
+	    if (vsize == 0)
+	      vsize = 10;
+	    else
+	      vsize *= 2;
+	    new = (struct dirent **) realloc (v, vsize * sizeof (*v));
+	    if (new == NULL)
+	      {
+	      lose:
+		(void) closedir (dp);
+		while (i > 0)
+		  free (v[--i]);
+		free (v);
+		errno = ENOMEM;
+		return -1;
+	      }
+	    v = new;
+	  }
+
+	v[i] = (struct dirent *) malloc (sizeof (**v));
+	if (v[i] == NULL)
+	  goto lose;
+
+	*v[i++] = *d;
+      }
+
+  if (errno != 0)
+    {
+      save = errno;
+
+      (void) closedir (dp);
+
+      /* Remember to free allocated memory upon error! */
+      while (i > 0) free(v[--i]);
+      free(v);
+
+      errno = save;
+      return -1;
+    }
+
+  (void) closedir (dp);
+  errno = save;
+
+  /* Sort the list if we have a comparison function to sort with.  */
+  if (cmp != NULL)
+    qsort (v, i, sizeof (*v), cmp);
+  *namelist = v;
+  return i;
 }
diff -r -u uae-0.8.5/src/od-dos/misc/misc.h uae-0.8.6/src/od-dos/misc/misc.h
--- uae-0.8.5/src/od-dos/misc/misc.h	Sat Mar  1 21:14:09 1997
+++ uae-0.8.6/src/od-dos/misc/misc.h	Sat Jul 18 13:14:43 1998
@@ -6,7 +6,7 @@
   * (c) 1997 Gustavo Goedert
   */
 
-void HandleDisk(int num);
+void HandleOptions(void);
 void SaveScreen(void);
 void EnterDebug(void);
 void LeaveDebug(void);
diff -r -u uae-0.8.5/src/od-dos/sound/sound.c uae-0.8.6/src/od-dos/sound/sound.c
--- uae-0.8.5/src/od-dos/sound/sound.c	Mon Dec 15 11:09:46 1997
+++ uae-0.8.6/src/od-dos/sound/sound.c	Sat Jul 18 13:14:43 1998
@@ -3,7 +3,7 @@
   *
   * Support for DOS
   *
-  * Copyright 1997 Gustavo Goedert
+  * Copyright 1997, 1998 Gustavo Goedert
   */
 
 #include "sysconfig.h"
@@ -23,7 +23,12 @@
 #include <time.h>
 
 #include "sound/sb.h"
-#include "sound/gus.h"
+
+typedef uae_s8 sample8_t;
+#define DO_CHANNEL_1(v, c) do { (v) *= audio_channel[c].vol; } while (0)
+#define SBASEVAL8(logn) ((logn) == 1 ? SOUND8_BASE_VAL << 7 : SOUND8_BASE_VAL << 8)
+#define SBASEVAL16(logn) ((logn) == 1 ? SOUND16_BASE_VAL >> 1 : SOUND16_BASE_VAL)
+#define FINISH_DATA(b,logn) do { if (14 - (b) + (logn) > 0) data >>= 14 - (b) + (logn); else data <<= (b) - 14 - (logn); } while (0);
 
 uae_u16 sndbuffer[44100];
 uae_u16 *sndbufpt;
@@ -33,8 +38,8 @@
 
 int sound_curfreq;
 
-void (*SND_Write)(void *buf, unsigned long size); // Pointer to function that plays data on card
-void (*SND_DirectWrite)(unsigned int size, int freq); // New function that plays data directly
+void (*SND_DirectWrite)(unsigned int size, int freq); // Pointer to function that plays data on card
+#define SND_DirectWrite SB_DirectWrite
 volatile int IsPlaying = 0;
 int CurrentBuffer = 0;
 unsigned int direct_buffers[2], direct_sndbufpt;
@@ -43,11 +48,8 @@
 void direct_mono_sample8_handler(void);
 void direct_stereo_sample16_handler(void);
 void direct_stereo_sample8_handler(void);
-void normal_sample16_handler(void);
-void normal_sample8_handler(void);
 void interpol_freq(int new_freq);
 void direct_check_sound_buffers(void);
-void normal_check_sound_buffers(void);
 
 #define INTERPOL_SIZE 8
 int freq_buf[INTERPOL_SIZE];
@@ -102,167 +104,136 @@
     }
 }
 
-inline void normal_check_sound_buffers(void) {
-    if ((char *)sndbufpt - (char *)sndbuffer >= sndbufsize) {
-	SND_Write(sndbuffer, sndbufsize);
-	sndbufpt = sndbuffer;
-    }
-}
-
-/* Gustavo et al.: *please* don't duplicate code like this, but use the functions
- * in audio.c */
 void direct_mono_sample16_handler(void)
 {
-    int nr, adk;
-    uae_u32 data = SOUND16_BASE_VAL;
+    uae_u32 data0 = audio_channel[0].current_sample;
+    uae_u32 data1 = audio_channel[1].current_sample;
+    uae_u32 data2 = audio_channel[2].current_sample;
+    uae_u32 data3 = audio_channel[3].current_sample;
+    DO_CHANNEL_1 (data0, 0);
+    DO_CHANNEL_1 (data1, 1);
+    DO_CHANNEL_1 (data2, 2);
+    DO_CHANNEL_1 (data3, 3);
+    data0 &= audio_channel[0].adk_mask;
+    data1 &= audio_channel[1].adk_mask;
+    data2 &= audio_channel[2].adk_mask;
+    data3 &= audio_channel[3].adk_mask;
+    data0 += data1;
+    data0 += data2;
+    data0 += data3;
+    {
+	uae_u32 data = SBASEVAL16(2) + data0;
+	FINISH_DATA(16, 2);
+	_farnspokew(direct_sndbufpt, data);
+	direct_sndbufpt += 2;
+    }
+
+    direct_check_sound_buffers();
 
     eventtab[ev_sample].evtime = cycles + sample_evtime;
     eventtab[ev_sample].oldcycles = cycles;
-
-    adk = adkcon;
-
-    if (!(adk & 0x11))
-	data += sound_table[audio_channel[0].current_sample][audio_channel[0].vol];
-    if (!(adk & 0x22))
-	data += sound_table[audio_channel[1].current_sample][audio_channel[1].vol];
-    if (!(adk & 0x44))
-	data += sound_table[audio_channel[2].current_sample][audio_channel[2].vol];
-    if (!(adk & 0x88))
-	data += sound_table[audio_channel[3].current_sample][audio_channel[3].vol];
-
-    _farnspokew(direct_sndbufpt, data);
-    direct_sndbufpt += 2;
-    direct_check_sound_buffers();
 }
 
 void direct_mono_sample8_handler(void)
 {
-    int nr, adk, played_size;
-    uae_u32 data = SOUND8_BASE_VAL;
-
-    eventtab[ev_sample].evtime = cycles + sample_evtime;
-    eventtab[ev_sample].oldcycles = cycles;
-
-    adk = adkcon;
-
-    if (!(adk & 0x11))
-	data += sound_table[audio_channel[0].current_sample][audio_channel[0].vol];
-    if (!(adk & 0x22))
-	data += sound_table[audio_channel[1].current_sample][audio_channel[1].vol];
-    if (!(adk & 0x44))
-	data += sound_table[audio_channel[2].current_sample][audio_channel[2].vol];
-    if (!(adk & 0x88))
-	data += sound_table[audio_channel[3].current_sample][audio_channel[3].vol];
+    uae_u32 data0 = audio_channel[0].current_sample;
+    uae_u32 data1 = audio_channel[1].current_sample;
+    uae_u32 data2 = audio_channel[2].current_sample;
+    uae_u32 data3 = audio_channel[3].current_sample;
+    DO_CHANNEL_1 (data0, 0);
+    DO_CHANNEL_1 (data1, 1);
+    DO_CHANNEL_1 (data2, 2);
+    DO_CHANNEL_1 (data3, 3);
+    data0 &= audio_channel[0].adk_mask;
+    data1 &= audio_channel[1].adk_mask;
+    data2 &= audio_channel[2].adk_mask;
+    data3 &= audio_channel[3].adk_mask;
+    data0 += data1;
+    data0 += data2;
+    data0 += data3;
+    {
+	uae_u32 data = SBASEVAL8(2) + data0;
+	FINISH_DATA(8, 2);
+	_farnspokeb(direct_sndbufpt++, data);
+    }
 
-    _farnspokeb(direct_sndbufpt++, data);
     direct_check_sound_buffers();
-}
-
-void direct_stereo_sample16_handler(void)
-{
-    int nr, adk;
-    uae_u32 ldata = SOUND16_BASE_VAL, rdata = SOUND16_BASE_VAL;
 
     eventtab[ev_sample].evtime = cycles + sample_evtime;
     eventtab[ev_sample].oldcycles = cycles;
-
-    adk = adkcon;
-
-    if (!(adk & 0x11))
-	ldata += sound_table[audio_channel[0].current_sample][audio_channel[0].vol];
-    if (!(adk & 0x22))
-	rdata += sound_table[audio_channel[1].current_sample][audio_channel[1].vol];
-    if (!(adk & 0x44))
-	rdata += sound_table[audio_channel[2].current_sample][audio_channel[2].vol];
-    if (!(adk & 0x88))
-	ldata += sound_table[audio_channel[3].current_sample][audio_channel[3].vol];
-
-    _farnspokew(direct_sndbufpt, ldata);
-    direct_sndbufpt += 2;
-    _farnspokew(direct_sndbufpt, rdata);
-    direct_sndbufpt += 2;
-    direct_check_sound_buffers();
 }
 
-void direct_stereo_sample8_handler(void)
+void direct_stereo_sample16_handler(void)
 {
-    int nr, adk, played_size;
-    uae_u32 ldata = SOUND8_BASE_VAL, rdata = SOUND8_BASE_VAL;
-
-    eventtab[ev_sample].evtime = cycles + sample_evtime;
-    eventtab[ev_sample].oldcycles = cycles;
-
-    adk = adkcon;
+    uae_u32 data0 = audio_channel[0].current_sample;
+    uae_u32 data1 = audio_channel[1].current_sample;
+    uae_u32 data2 = audio_channel[2].current_sample;
+    uae_u32 data3 = audio_channel[3].current_sample;
+    DO_CHANNEL_1 (data0, 0);
+    DO_CHANNEL_1 (data1, 1);
+    DO_CHANNEL_1 (data2, 2);
+    DO_CHANNEL_1 (data3, 3);
+
+    data0 &= audio_channel[0].adk_mask;
+    data1 &= audio_channel[1].adk_mask;
+    data2 &= audio_channel[2].adk_mask;
+    data3 &= audio_channel[3].adk_mask;
+
+    data0 += data3;
+    {
+	uae_u32 data = SBASEVAL16(1) + data0;
+	FINISH_DATA (16, 1);
+	_farnspokew(direct_sndbufpt, data);
+	direct_sndbufpt += 2;
+    }
 
-    if (!(adk & 0x11))
-	ldata += sound_table[audio_channel[0].current_sample][audio_channel[0].vol];
-    if (!(adk & 0x22))
-	rdata += sound_table[audio_channel[1].current_sample][audio_channel[1].vol];
-    if (!(adk & 0x44))
-	rdata += sound_table[audio_channel[2].current_sample][audio_channel[2].vol];
-    if (!(adk & 0x88))
-	ldata += sound_table[audio_channel[3].current_sample][audio_channel[3].vol];
+    data1 += data2;
+    {
+	uae_u32 data = SBASEVAL16(1) + data1;
+	FINISH_DATA (16, 1);
+	_farnspokew(direct_sndbufpt, data);
+	direct_sndbufpt += 2;
+    }
 
-    _farnspokeb(direct_sndbufpt++, ldata);
-    _farnspokeb(direct_sndbufpt++, rdata);
     direct_check_sound_buffers();
-}
-
-
-void normal_sample16_handler(void)
-{
-    int nr, adk;
-    uae_u32 data = SOUND16_BASE_VAL;
 
     eventtab[ev_sample].evtime = cycles + sample_evtime;
     eventtab[ev_sample].oldcycles = cycles;
-
-    adk = adkcon;
-
-    if (!(adk & 0x11))
-	data += sound_table[audio_channel[0].current_sample][audio_channel[0].vol];
-    if (!(adk & 0x22))
-	data += sound_table[audio_channel[1].current_sample][audio_channel[1].vol];
-    if (!(adk & 0x44))
-	data += sound_table[audio_channel[2].current_sample][audio_channel[2].vol];
-    if (!(adk & 0x88))
-	data += sound_table[audio_channel[3].current_sample][audio_channel[3].vol];
-
-    *(uae_u16 *)sndbufpt = data;
-    sndbufpt = (uae_u16 *)(((uae_u8 *)sndbufpt) + 2);
-    normal_check_sound_buffers();
 }
 
-void normal_sample8_handler(void)
+void direct_stereo_sample8_handler(void)
 {
-    int nr, adk;
-    uae_u32 data = SOUND8_BASE_VAL;
+    uae_u32 data0 = audio_channel[0].current_sample;
+    uae_u32 data1 = audio_channel[1].current_sample;
+    uae_u32 data2 = audio_channel[2].current_sample;
+    uae_u32 data3 = audio_channel[3].current_sample;
+    DO_CHANNEL_1 (data0, 0);
+    DO_CHANNEL_1 (data1, 1);
+    DO_CHANNEL_1 (data2, 2);
+    DO_CHANNEL_1 (data3, 3);
+
+    data0 &= audio_channel[0].adk_mask;
+    data1 &= audio_channel[1].adk_mask;
+    data2 &= audio_channel[2].adk_mask;
+    data3 &= audio_channel[3].adk_mask;
+
+    data0 += data3;
+    {
+	uae_u32 data = SBASEVAL8(1) + data0;
+	FINISH_DATA (8, 1);
+	_farnspokeb(direct_sndbufpt++, data);
+    }
+    data1 += data2;
+    {
+	uae_u32 data = SBASEVAL8(1) + data1;
+	FINISH_DATA (8, 1);
+	_farnspokeb(direct_sndbufpt++, data);
+    }
+
+    direct_check_sound_buffers();
 
     eventtab[ev_sample].evtime = cycles + sample_evtime;
     eventtab[ev_sample].oldcycles = cycles;
-
-    adk = adkcon;
-
-    if (!(adk & 0x11))
-	data += sound_table[audio_channel[0].current_sample][audio_channel[0].vol];
-    if (!(adk & 0x22))
-	data += sound_table[audio_channel[1].current_sample][audio_channel[1].vol];
-    if (!(adk & 0x44))
-	data += sound_table[audio_channel[2].current_sample][audio_channel[2].vol];
-    if (!(adk & 0x88))
-	data += sound_table[audio_channel[3].current_sample][audio_channel[3].vol];
-
-    *(uae_u8 *)sndbufpt = data;
-    sndbufpt = (uae_u16 *)(((uae_u8 *)sndbufpt) + 1);
-    normal_check_sound_buffers();
-}
-
-void close_sound(void) {
-}
-
-int setup_sound(void) {
-    sound_available = 1;
-    return 1;
 }
 
 int init_sound (void)
@@ -282,8 +253,7 @@
     rate = currprefs.sound_freq;
     sndbufsize = currprefs.sound_maxbsiz;
 
-    if (GUS_Init(&dspbits, &rate, &sndbufsize, direct_buffers, &currprefs.stereo));
-    else if (SB_DetectInitSound(&dspbits, &rate, &sndbufsize, direct_buffers, &currprefs.stereo));
+    if (SB_DetectInitSound(&dspbits, &rate, &sndbufsize, direct_buffers, &currprefs.stereo));
     else if (0/*OTHER_CARD_DETECT_ROUTINE*/);
     else
 	return 0;
@@ -292,31 +262,21 @@
     currprefs.sound_minbsiz = (currprefs.sound_minbsiz>>2)<<2;
     currprefs.sound_maxbsiz = sndbufsize;
 
-    if (direct_buffers[0] == 0)
-	currprefs.sound_minbsiz = currprefs.sound_maxbsiz;
-
     sample_evtime = (long)maxhpos * maxvpos * 50 / rate;
 
     if (dspbits == 16) {
 	init_sound_table16 ();
-	if (direct_buffers[0] != 0) {
-	    if (currprefs.stereo)
-		eventtab[ev_sample].handler = direct_stereo_sample16_handler;
-	    else
-		eventtab[ev_sample].handler = direct_mono_sample16_handler;
-	} else
-	    eventtab[ev_sample].handler = normal_sample16_handler;
+	if (currprefs.stereo)
+	    eventtab[ev_sample].handler = direct_stereo_sample16_handler;
+	else
+	    eventtab[ev_sample].handler = direct_mono_sample16_handler;
     } else {
 	init_sound_table8 ();
-	if (direct_buffers[0] != 0) {
-	    if (currprefs.stereo)
-		eventtab[ev_sample].handler = direct_stereo_sample8_handler;
-	    else
-		eventtab[ev_sample].handler = direct_mono_sample8_handler;
-	} else
-	    eventtab[ev_sample].handler = normal_sample8_handler;
+	if (currprefs.stereo)
+	    eventtab[ev_sample].handler = direct_stereo_sample8_handler;
+	else
+	    eventtab[ev_sample].handler = direct_mono_sample8_handler;
     }
-    sound_available = 1;
     printf ("Sound driver found and configured for %d bits at %d Hz, buffer is %d:%d bytes\n",
 	    dspbits, rate, currprefs.sound_minbsiz, currprefs.sound_maxbsiz);
     sndbufpt = sndbuffer;
@@ -327,5 +287,19 @@
 	freq_buf[i] = sound_curfreq;
     buf_tot = sound_curfreq * INTERPOL_SIZE;
 
+#ifdef FRAME_RATE_HACK
+    vsynctime = vsynctime * 9 / 10;
+#endif
+
     return 1;
+}
+
+int setup_sound (void)
+{
+    sound_available = 1;
+    return 1;
+}
+
+void close_sound(void)
+{
 }
diff -r -u uae-0.8.5/src/od-dos/sound/sound.h uae-0.8.6/src/od-dos/sound/sound.h
--- uae-0.8.5/src/od-dos/sound/sound.h	Thu Nov 20 18:39:11 1997
+++ uae-0.8.6/src/od-dos/sound/sound.h	Sat Jul 18 13:14:43 1998
@@ -3,7 +3,7 @@
   *
   * Support for DOS
   *
-  * Copyright 1997 Gustavo Goedert
+  * Copyright 1997, 1998 Gustavo Goedert
   */
 
 extern int sound_fd;
@@ -11,12 +11,16 @@
 extern uae_u16 *sndbufpt;
 extern int sndbufsize;
 
-static __inline__ void check_sound_buffers (void) {
+static __inline__ void check_sound_buffers (void)
+{
 }
 
-#define PUT_SOUND_BYTE(b) do {  } while (0)
-#define PUT_SOUND_WORD(b) do {  } while (0)
-
+#define PUT_SOUND_BYTE(b) do { ; } while (0)
+#define PUT_SOUND_WORD(b) do { ; } while (0)
+#define PUT_SOUND_BYTE_RIGHT(b) do { ; } while (0)
+#define PUT_SOUND_BYTE_LEFT(b) do { ; } while (0)
+#define PUT_SOUND_WORD_RIGHT(b) do { ; } while (0)
+#define PUT_SOUND_WORD_LEFT(b) do { ; } while (0)
 #define SOUND16_BASE_VAL 0
 #define SOUND8_BASE_VAL 128
 
@@ -24,3 +28,4 @@
 #define DEFAULT_SOUND_MINB 2048
 #define DEFAULT_SOUND_BITS 16
 #define DEFAULT_SOUND_FREQ 44100
+#define HAVE_STEREO_SUPPORT
diff -r -u uae-0.8.5/src/od-dos/video/vbe.c uae-0.8.6/src/od-dos/video/vbe.c
--- uae-0.8.5/src/od-dos/video/vbe.c	Wed Nov 19 18:34:26 1997
+++ uae-0.8.6/src/od-dos/video/vbe.c	Sat Jul 18 13:14:43 1998
@@ -793,13 +793,12 @@
     NumberOfModes++;
 }
 
-int SetMode(int ModeNumber, int Linear) {
+int SetMode(int ModeNumber, int Linear, int Debug) {
     _go32_dpmi_registers IntRegs;
-    static int FirstTime = 1;
 
     switch(InternalModeList[ModeNumber].ControlType) {
 	case TVBE:
-	    if (FirstTime) printf ("Using VESA BIOS.\n");
+	    if (Debug) printf ("Using VESA BIOS.\n");
 	    IntRegs.x.ax = 0x4F02;
 	    if (ModeList[ModeNumber].ModeType == T16) {
 		if (Linear)
@@ -818,13 +817,13 @@
 		    return(0);
 		IntRegs.x.bx = InternalModeList[ModeNumber].OriginalModeNumber;
 		if (HasProtectedModeInterface) {
-		    if (FirstTime) printf ("Using Protected Mode Bank Switch Function.\n");
+		    if (Debug) printf ("Using Protected Mode Bank Switch Function.\n");
 		    ModeList[ModeNumber].ChangeBank = VBE_ChangeBankProtectMode;
 		} else if ((InternalModeList[ModeNumber].WinFuncPtrSegment != 0) && (InternalModeList[ModeNumber].WinFuncPtrOffset != 0)) {
-		    if (FirstTime) printf ("Using Real Mode Bank Switch Function.\n");
+		    if (Debug) printf ("Using Real Mode Bank Switch Function.\n");
 		    ModeList[ModeNumber].ChangeBank = VBE_ChangeBankRealMode;
 		} else {
-		    if (FirstTime) printf ("Using Real Mode Bank Switch Interrupt Function.\n");
+		    if (Debug) printf ("Using Real Mode Bank Switch Interrupt Function.\n");
 		    ModeList[ModeNumber].ChangeBank = VBE_ChangeBankRealInterrupt;
 		}
 		ModeList[ModeNumber].PutLine = PutLineBanked;
@@ -833,7 +832,7 @@
 	    _go32_dpmi_simulate_int(0x10, &IntRegs);
 	    break;
 	case TVGA:
-	    if (FirstTime) printf ("Using normal VGA.\n");
+	    if (Debug) printf ("Using normal VGA.\n");
 	    IntRegs.h.ah = 0x00;
 	    IntRegs.h.al = InternalModeList[ModeNumber].OriginalModeNumber;
 	    IntRegs.x.ss = IntRegs.x.sp = IntRegs.x.flags = 0;
@@ -845,7 +844,7 @@
 		ModeList[ModeNumber].PutLine = PutLineLinear;
 	    break;
 	case TModeX:
-	    if (FirstTime) printf ("Using VGA Mode X.\n");
+	    if (Debug) printf ("Using VGA Mode X.\n");
 	    SetModeX(InternalModeList[ModeNumber].OriginalModeNumber);
 	    ModeList[ModeNumber].ChangeBank = NULL_ChangeBank;
 	    ModeList[ModeNumber].PutLine = PutLineVGAX;
@@ -854,7 +853,6 @@
     CurrentMode = ModeList[ModeNumber];
     CurrentInternalMode = InternalModeList[ModeNumber];
     RestoreOldVGAMode = 1;
-    FirstTime = 0;
     MapVideoMemory();
     return(1);
 }
diff -r -u uae-0.8.5/src/od-dos/video/vbe.h uae-0.8.6/src/od-dos/video/vbe.h
--- uae-0.8.5/src/od-dos/video/vbe.h	Wed Nov 19 18:34:26 1997
+++ uae-0.8.6/src/od-dos/video/vbe.h	Sat Jul 18 13:14:43 1998
@@ -37,6 +37,6 @@
 void LoadPalette(void);
 int InitGfxLib(void);
 void CloseGfxLib(void);
-int SetMode(int ModeNumber, int Linear);
+int SetMode(int ModeNumber, int Linear, int Debug);
 void SaveMode(void);
 void RestoreMode(void);
diff -r -u uae-0.8.5/src/od-dos/video/video.c uae-0.8.6/src/od-dos/video/video.c
--- uae-0.8.5/src/od-dos/video/video.c	Mon Jun  1 11:10:24 1998
+++ uae-0.8.6/src/od-dos/video/video.c	Sat Jul 18 13:14:43 1998
@@ -125,10 +125,114 @@
    }
 }
 
+struct gfxstring *gfxmenu;
+int numgfxitems = 0;
+
+struct gfxstring{
+    char data[32];
+    int val;
+};
+
+int gfxmenusort(const void *a, const void *b) {
+   struct gfxstring *ga, *gb;
+
+   ga = (struct gfxstring *) a;
+   gb = (struct gfxstring *) b;
+   if (ModeList[ga->val].ModeWidth < ModeList[gb->val].ModeWidth)
+      return(-1);
+   else if (ModeList[ga->val].ModeWidth > ModeList[gb->val].ModeWidth)
+      return(1);
+   else if (ModeList[ga->val].ModeHeight < ModeList[gb->val].ModeHeight)
+      return(-1);
+   else if (ModeList[ga->val].ModeHeight > ModeList[gb->val].ModeHeight)
+      return(1);
+   else if (ModeList[ga->val].ModeType < ModeList[gb->val].ModeType)
+      return(-1);
+   else if (ModeList[ga->val].ModeType > ModeList[gb->val].ModeType)
+      return(1);
+   return(0);
+}
+
 int graphics_setup(void) {
+    int i, j, hasres;
+    struct gfxstring gfxmenuitem;
+
+    gfxmenu = (struct gfxstring *)calloc(NumberOfModes, sizeof(struct gfxstring));
+
+    for (i = 0; i < NumberOfModes; i++) {
+	hasres = 0;
+	for (j = 0; j < numgfxitems; j++)
+	    if ((ModeList[gfxmenu[j].val].ModeType == ModeList[i].ModeType) &&
+		(ModeList[gfxmenu[j].val].ModeWidth == ModeList[i].ModeWidth) &&
+		(ModeList[gfxmenu[j].val].ModeHeight == ModeList[i].ModeHeight))
+		hasres = 1;
+	if (!hasres) {
+	    sprintf(gfxmenu[numgfxitems].data, "%dx%d ", ModeList[i].ModeWidth, ModeList[i].ModeHeight);
+	    switch (ModeList[i].ModeType) {
+		case T16:
+		    strcat(gfxmenu[numgfxitems].data, "16 colors");
+		    break;
+		case T256:
+		    strcat(gfxmenu[numgfxitems].data, "256 colors");
+		    break;
+		case T32K:
+		    strcat(gfxmenu[numgfxitems].data, "32k colors");
+		    break;
+		case T64K:
+		    strcat(gfxmenu[numgfxitems].data, "64k colors");
+		    break;
+		case T16M:
+		    strcat(gfxmenu[numgfxitems].data, "16M colors");
+		    break;
+	    }
+	    gfxmenu[numgfxitems].val = i;
+	    numgfxitems++;
+	}
+    }
+    qsort((void *)gfxmenu, numgfxitems, sizeof(struct gfxstring), gfxmenusort);
+
+    video_mode_menu = (struct bstring *)malloc(sizeof (struct bstring)*(numgfxitems+1));
+    for (i = 0; i < numgfxitems; i++) {
+	video_mode_menu[i].val = -1;
+	video_mode_menu[i].data = strdup(gfxmenu[i].data);
+    }
+    video_mode_menu[numgfxitems].val = -3;
+    video_mode_menu[numgfxitems].data = NULL;
+
     return 1;
 }
 
+void vidmode_menu_selected(int a) {
+    currprefs.gfx_width = ModeList[gfxmenu[a].val].ModeWidth;
+    currprefs.gfx_height = ModeList[gfxmenu[a].val].ModeHeight;
+    switch (ModeList[gfxmenu[a].val].ModeType) {
+	case T16:
+	    currprefs.color_mode = 4;
+	    break;
+	case T256:
+	    currprefs.color_mode = 0;
+	    break;
+	case T32K:
+	    currprefs.color_mode = 1;
+	    break;
+	case T64K:
+	    currprefs.color_mode = 2;
+	    break;
+	case T16M:
+	    currprefs.color_mode = 5;
+	    break;
+    }
+    currprefs.gfx_lores=currprefs.gfx_width<640;
+    currprefs.gfx_xcenter=2;
+    currprefs.gfx_ycenter=2;
+    currprefs.gfx_linedbl=0;
+    if (currprefs.gfx_height > 285)
+	currprefs.gfx_linedbl = 1;
+    currprefs.gfx_correct_aspect = 1;
+    if (currprefs.gfx_height > 570)
+	currprefs.gfx_correct_aspect = 0;
+}
+
 int graphics_init(void) {
     T_ModeType WantedType;
     int i;
@@ -181,7 +285,7 @@
 	return 0;
     }
 
-    if (!SetMode(ModeNumber, UseLinear)) {
+    if (!SetMode(ModeNumber, UseLinear, 1)) {
 	printf("Can't start graphics mode.\n");
 	return 0;
     }
@@ -209,7 +313,6 @@
     gfxvidinfo.width = CurrentMode.ModeWidth;
     gfxvidinfo.height = CurrentMode.ModeHeight;
     gfxvidinfo.linemem = 0;
-    gfxvidinfo.emergmem = 0;
 
     InitColors();
     if ((gfxvidinfo.pixbytes == 1) || NeedDither)
@@ -248,14 +351,16 @@
     currprefs.produce_sound = Original_produce_sound;
 }
 
-int debuggable(void)
-{
-    return 1;
+int debuggable(void) {
+    return(1);
+}
+
+int needmousehack(void) {
+    return(0);
 }
 
-int needmousehack(void)
-{
-    return 0;
+void write_log(const char *buf) {
+    printf(buf);
 }
 
 #ifdef PICASSO96
@@ -324,7 +429,7 @@
 }
 
 void SetWindowForPicasso(void) {
-    if (!SetMode(PicassoModeNumber, PicassoUseLinear)) {
+    if (!SetMode(PicassoModeNumber, PicassoUseLinear, 0)) {
 	printf("Can't start graphics mode.\n");
 	abort();
     }
@@ -337,7 +442,7 @@
 }
 
 void SetWindowForAmiga(void) {
-    if (!SetMode(ModeNumber, UseLinear)) {
+    if (!SetMode(ModeNumber, UseLinear, 0)) {
 	printf("Can't start graphics mode.\n");
 	abort();
     }
diff -r -u uae-0.8.5/src/picasso96.c uae-0.8.6/src/picasso96.c
--- uae-0.8.5/src/picasso96.c	Wed Jul  1 13:20:20 1998
+++ uae-0.8.6/src/picasso96.c	Sat Jul 18 13:14:42 1998
@@ -26,6 +26,8 @@
  *
  * TODO:
  * - add panning capability
+ * - we want to add a manual switch to override SetSwitch for hardware banging
+ *   programs started from a Picasso workbench.
  */
 
 #include "sysconfig.h"
@@ -313,9 +315,9 @@
     char *uaememptr = 0;
     int i;
 
-    uaememptr = gfxmem_xlate(amigamemptr); /* I know that amigamemptr is inside my gfxmem chunk, so I can just do the xlate() */
-    memset(uaememptr, 0, PSSO_LibResolution_sizeof); /* zero out our LibResolution structure */
-    strcpy(uaememptr + PSSO_LibResolution_P96ID, libres->P96ID);
+    uaememptr = gfxmem_xlate (amigamemptr); /* I know that amigamemptr is inside my gfxmem chunk, so I can just do the xlate() */
+    memset (uaememptr, 0, PSSO_LibResolution_sizeof); /* zero out our LibResolution structure */
+    strcpy (uaememptr + PSSO_LibResolution_P96ID, libres->P96ID);
     put_long (amigamemptr + PSSO_LibResolution_DisplayID, libres->DisplayID);
     put_word (amigamemptr + PSSO_LibResolution_Width, libres->Width);
     put_word (amigamemptr + PSSO_LibResolution_Height, libres->Height);
@@ -560,9 +562,9 @@
 {
     if (! picasso_on)
 	return 0;
-    if (ri->Memory != gfxmemory + (picasso96_state.Address - gfxmem_start)) {
+    if (ri->Memory != gfxmemory + (picasso96_state.Address - gfxmem_start))
 	return 0;
-    }
+
     return 1;
 }
 
@@ -719,7 +721,7 @@
 	res.P96ID[4] = '0';
 	res.P96ID[5] = ':';
 	strcpy (res.Name, "uaegfx:");
-	strncat (res.Name, DisplayModes[i].name, strchr(DisplayModes[i].name, ',') - DisplayModes[i].name);
+	strncat (res.Name, DisplayModes[i].name, strchr (DisplayModes[i].name, ',') - DisplayModes[i].name);
 	res.Modes[PLANAR] = 0;
 	res.Modes[CHUNKY] = 0;
 	res.Modes[HICOLOR] = 0;
@@ -1382,7 +1384,7 @@
     uae_u8 Mask = (uae_u8)m68k_dreg (regs, 4);
     uae_u32 RGBFmt = m68k_dreg (regs, 7);
 
-    uae_u8 Bpp = GetBytesPerPixel(RGBFmt);
+    uae_u8 Bpp = GetBytesPerPixel (RGBFmt);
     int inversion = 0;
     struct RenderInfo ri;
     struct Pattern pattern;
diff -r -u uae-0.8.5/src/sd-uss/sound.c uae-0.8.6/src/sd-uss/sound.c
--- uae-0.8.5/src/sd-uss/sound.c	Wed Jul  1 17:26:25 1998
+++ uae-0.8.6/src/sd-uss/sound.c	Sat Jul 18 13:14:43 1998
@@ -27,7 +27,7 @@
 #endif
 
 int sound_fd;
-static int have_sound;
+static int have_sound = 0;
 static unsigned long formats;
 
 uae_u16 sndbuffer[44100];
@@ -48,21 +48,31 @@
 	close (sound_fd);
 }
 
+/* Try to determine whether sound is available.  This is only for GUI purposes.  */
 int setup_sound (void)
 {
     sound_fd = open ("/dev/dsp", O_WRONLY);
-    have_sound = !(sound_fd < 0);
-    if (! have_sound)
+
+    sound_available = 0;
+
+    if (sound_fd < 0) {
+	perror ("Can't open /dev/dsp");
+	if (errno == EBUSY) {
+	    /* We can hope, can't we ;) */
+	    sound_available = 1;
+	    return 1;
+	}
 	return 0;
+    }
 
     if (ioctl (sound_fd, SNDCTL_DSP_GETFMTS, &formats) == -1) {
-	fprintf (stderr, "ioctl failed - can't use sound.\n");
-	close(sound_fd);
-	have_sound = 0;
+	perror ("ioctl failed - can't use sound");
+	close (sound_fd);
 	return 0;
     }
 
     sound_available = 1;
+    close (sound_fd);
     return 1;
 }
 
@@ -71,6 +81,21 @@
     int tmp;
     int rate;
     int dspbits;
+
+    sound_fd = open ("/dev/dsp", O_WRONLY);
+    have_sound = !(sound_fd < 0);
+    if (! have_sound) {
+	perror ("Can't open /dev/dsp");
+	if (errno != EBUSY)
+	    sound_available = 0;
+	return 0;
+    }
+    if (ioctl (sound_fd, SNDCTL_DSP_GETFMTS, &formats) == -1) {
+	perror ("ioctl failed - can't use sound");
+	close (sound_fd);
+	have_sound = 0;
+	return 0;
+    }
 
     if (currprefs.sound_maxbsiz < 128 || currprefs.sound_maxbsiz > 16384) {
 	fprintf (stderr, "Sound buffer size %d out of range.\n", currprefs.sound_maxbsiz);
diff -r -u uae-0.8.5/src/svga.c uae-0.8.6/src/svga.c
--- uae-0.8.5/src/svga.c	Fri Jun 12 15:52:55 1998
+++ uae-0.8.6/src/svga.c	Sat Jul 18 13:14:43 1998
@@ -861,7 +861,7 @@
     restore_vga_colors ();
 }
 
-void gfx_set_picasso_modeinfo (int w, int h, int depth)
+void gfx_set_picasso_modeinfo (int w, int h, int depth, int rgbfmt)
 {
     vga_modeinfo *info;
     int i, mode;
@@ -908,14 +908,6 @@
 	set_window_for_picasso ();
     else
 	set_window_for_amiga ();
-}
-
-void begindrawing (void)
-{
-}
-
-void enddrawing (void)
-{
 }
 
 uae_u8 *gfx_lock_picasso (void)
diff -r -u uae-0.8.5/src/tui.c uae-0.8.6/src/tui.c
--- uae-0.8.5/src/tui.c	Tue May  5 00:36:17 1998
+++ uae-0.8.6/src/tui.c	Sat Jul 18 13:14:43 1998
@@ -67,6 +67,7 @@
     { "_Disk settings", 'D' },
     { "_Video settings", 'V' },
     { "_Memory settings", 'M' },
+    { "_CPU settings", 'C' },
     { "_Hard disk settings", 'H' },
     { "_Sound settings", 'S' },
     { "_Other settings", 'O' },
@@ -111,6 +112,7 @@
     { "Toggle line _doubling", 'D' },
     { "Toggle _aspect _correction", 'A' },
     { "Change _framerate", 'F' },
+    { "_Graphics card memory", 'P'},
     { NULL, -3 }
 };
 
@@ -123,6 +125,11 @@
     { NULL, -3 }
 };
 
+static struct bstring cpumenu[] = {
+    { "Change _CPU", 'C' },
+    { NULL, -3 }
+};
+
 static struct bstring soundmenu[] = {
     { "Sound settings", 0 },
     { "Change _sound emulation accuracy", 'S' },
@@ -130,6 +137,7 @@
     { "Change m_aximum sound buffer size", 'A' },
     { "Change number of _bits", 'B' },
     { "Change output _frequency", 'F' },
+    { "Change s_tereo", 'T' },
     { NULL , -3 }
 };
 
@@ -248,9 +256,32 @@
      default: sprintf (tmp, "%dth ",currprefs.framerate); tui_puts (tmp); break;
     }
     tui_puts ("frame.    ");
+
+    tui_gotoxy (OPTION_COLUMN+7, y++);
+    if (currprefs.gfxmem_size) {
+	sprintf (tmp, "Picasso 96 %d MB", currprefs.gfxmem_size / 0x100000);
+	tui_puts(tmp);
+    } else
+ 	tui_puts ("Picasso 96 Off");
     y++;
+
+    tui_gotoxy (OPTION_COLUMN, y++);
+    tui_puts ("CPU: ");
+    switch (currprefs.cpu_level) {
+     case 0: tui_puts ("68000"); break;
+     case 1: tui_puts ("68010"); break;
+     case 2: tui_puts ("68020"); break;
+     case 3: tui_puts ("68020/68881"); break;
+    }
+    if (currprefs.address_space_24 && currprefs.cpu_level > 1)
+	tui_puts (" (24 bit addressing)");
+    if (currprefs.cpu_compatible)
+	tui_puts (" (slow but compatible)");
     tui_gotoxy (OPTION_COLUMN, y++);
-    sprintf (tmp, "MEMORY: %4dK chip; %4dK fast; %4dK slow",chipmem_size/1024,fastmem_size/1024,bogomem_size/1024);
+    sprintf (tmp, "MEMORY: %4dK chip; %4dK fast; %4dK slow",
+	     currprefs.chipmem_size/1024,
+	     currprefs.fastmem_size/1024,
+	     currprefs.bogomem_size/1024);
     tui_puts (tmp);
 
     tui_gotoxy (OPTION_COLUMN, y++);
@@ -287,7 +318,7 @@
 	char buf[256];
 
 	tui_gotoxy (OPTION_COLUMN+1,y++);
-	if (sprintf_filesys_unit(buf, i) == -1)
+	if (sprintf_filesys_unit (currprefs.mountinfo, buf, i) == -1)
 	    break;
 	tui_puts (buf);
     }
@@ -320,7 +351,7 @@
 	    if (mountvol[strlen(mountvol)-1]==':')
 		mountvol[strlen(mountvol)-1] = 0;
 	    tui_wgets (mountdir, "Enter mounted volume path", 78);
-	    add_filesys_unit (mountvol, mountdir, 0, 0, 0, 0);
+	    add_filesys_unit (currprefs.mountinfo, mountvol, mountdir, 0, 0, 0, 0);
 	    break;
 	 case 2:
 	    tui_wgets (mountvol, "Enter mounted volume name", 10);
@@ -329,7 +360,7 @@
 	    if (mountvol[strlen (mountvol)-1]==':')
 		mountvol[strlen (mountvol)-1] = 0;
 	    tui_wgets (mountdir, "Enter mounted volume path", 78);
-	    add_filesys_unit (mountvol, mountdir, 1, 0, 0, 0);
+	    add_filesys_unit (currprefs.mountinfo, mountvol, mountdir, 1, 0, 0, 0);
 	    break;
 	 case 3:
 	    buff = tui_filereq("*", "", "Select the hardfile to be mounted");
@@ -339,7 +370,7 @@
 	    tui_wgets (mountdir, "Enter number of sectors per track", 4);
 	    tui_wgets (mountdir + 10, "Enter number of heads", 4);
 	    tui_wgets (mountdir + 20, "Enter number of reserved blocks", 3);
-	    buff = add_filesys_unit (0, mountvol, 1,
+	    buff = add_filesys_unit (currprefs.mountinfo, 0, mountvol, 1,
 				     atoi (mountdir), atoi (mountdir + 10),
 				     atoi (mountdir + 20));
 	    if (buff)
@@ -347,7 +378,7 @@
 	    break;
 	 case 4:
 	    tui_wgets (mountvol, "Enter number of volume to be removed (0 for UAE0:, etc.)", 2);
-	    if (kill_filesys_unit (atoi (mountvol)) == -1)
+	    if (kill_filesys_unit (currprefs.mountinfo, atoi (mountvol)) == -1)
 		tui_errorbox ("Volume does not exist");
 	    break;
 	}
@@ -377,7 +408,7 @@
 	    sel = tui_filereq("*.adf", currprefs.df[c], tmp);
 	    if (sel == NULL)
 		break;
-	    strcpy(currprefs.df[c], sel);
+	    strcpy (currprefs.df[c], sel);
 	    break;
 	}
     }
@@ -450,6 +481,11 @@
 	    if (currprefs.framerate > 9)
 		currprefs.framerate=1;
 	    break;
+	 case 10:
+	    currprefs.gfxmem_size += 0x100000;
+	    if (currprefs.gfxmem_size > 0x800000)
+		currprefs.gfxmem_size = 0;
+	    break;
 	}
     }
 }
@@ -468,33 +504,59 @@
 	    break;
 	else switch (c) {
 	 case 0:
-	    if (fastmem_size == 0)
-		fastmem_size = 0x200000;
-	    else if (fastmem_size == 0x800000)
-		fastmem_size = 0;
+	    if (currprefs.fastmem_size == 0)
+		currprefs.fastmem_size = 0x200000;
+	    else if (currprefs.fastmem_size == 0x800000)
+		currprefs.fastmem_size = 0;
 	    else
-		fastmem_size <<= 1;
+		currprefs.fastmem_size <<= 1;
 	    break;
 	 case 1:
-	    if (chipmem_size == 0x800000)
-		chipmem_size = 0x80000;
+	    if (currprefs.chipmem_size == 0x800000)
+		currprefs.chipmem_size = 0x80000;
 	    else
-		chipmem_size <<= 1;
-	    if (chipmem_size > 0x200000)
-		fastmem_size = 0;
+		currprefs.chipmem_size <<= 1;
+	    if (currprefs.chipmem_size > 0x200000)
+		currprefs.fastmem_size = 0;
 	    break;
 	 case 2:
-	    if (bogomem_size == 0)
-		bogomem_size = 0x40000;
-	    else if (bogomem_size == 0x100000)
-		bogomem_size = 0;
+	    if (currprefs.bogomem_size == 0)
+		currprefs.bogomem_size = 0x40000;
+	    else if (currprefs.bogomem_size == 0x100000)
+		currprefs.bogomem_size = 0;
 	    else
-		bogomem_size <<= 1;
+		currprefs.bogomem_size <<= 1;
 	    break;
 	 case 3:
-	    tmp = tui_filereq("*.rom", romfile, "Select a ROM image");
+	    tmp = tui_filereq ("*.rom", romfile, "Select a ROM image");
 	    if (tmp != NULL)
-		strcpy(romfile, tmp);
+		strcpy (romfile, tmp);
+	    break;
+	}
+    }
+}
+
+static void CPUOptions (void)
+{
+    char *tmp;
+    int c = 0;
+    for (;;) {
+	tui_selwin(0);
+	print_configuration ();
+
+	c = tui_menubrowse (cpumenu, MENU_COL_OFFSET, 5, c, MAX_MENU_HEIGHT);
+	if (c == -1)
+	    break;
+	else switch (c) {
+	 case 0:
+	    currprefs.cpu_level++;
+	    if (currprefs.cpu_level > 3)
+		currprefs.cpu_level = 0;
+	    /* Default to 32 bit addressing when switching from a 68000/68010 to a 32 bit CPU */
+	    if (currprefs.cpu_level == 2)
+		currprefs.address_space_24 = 0;
+	    if (currprefs.cpu_level != 0)
+		currprefs.cpu_compatible = 0;
 	    break;
 	}
     }
@@ -548,6 +610,9 @@
 	    else
 		currprefs.sound_freq = atoi (tmp);
 	    break;
+	 case 5:
+	    currprefs.stereo = !currprefs.stereo;
+	    break;
 	}
     }
 }
@@ -605,16 +670,17 @@
 	    return -2;
 	}
 	if (mode == 1) {
-	    if (c == 7)
+	    if (c == 8)
 		break;
 	    switch (c) {
 	     case 0: DiskOptions (); break;
 	     case 1: VideoOptions (); break;
 	     case 2: MemoryOptions (); break;
-	     case 3: HDOptions (); break;
-	     case 4: SoundOptions (); break;
-	     case 5: OtherOptions (); break;
-	     case 6: save_settings (); break;
+	     case 3: CPUOptions (); break;
+	     case 4: HDOptions (); break;
+	     case 5: SoundOptions (); break;
+	     case 6: OtherOptions (); break;
+	     case 7: save_settings (); break;
 	    }
 	} else {
 	    if (c == 5)
